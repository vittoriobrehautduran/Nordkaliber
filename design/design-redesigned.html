<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designa Din Egen - Nordkaliber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e5e5e5;
            overflow: hidden;
            /* Prevent touch gestures */
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .step-container {
            display: flex;
            width: 500%; /* 5 steps for desktop */
            transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1);
            /* Prevent touch gestures */
            touch-action: none;
        }

        .step {
            width: 20%; /* Each step takes 1/5 of container */
            flex-shrink: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            /* Prevent touch gestures */
            touch-action: none;
        }
        
        /* Desktop: show all steps horizontally, mobile: hide inactive steps */
        @media (min-width: 769px) {
            .step-container {
                width: 500%;
            }
            
            .step {
                width: 20%;
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .step-container {
                width: 100%;
            }
            
            .step {
                width: 100%;
                display: none;
            }
            
            .step.active {
                display: flex;
            }
        }
        
        /* Ensure first step is active by default on mobile */
        @media (max-width: 768px) {
            #step-1.active {
                display: flex;
            }
        }
        
        /* Prevent any horizontal scrolling or swiping on mobile */
        @media (max-width: 768px) {
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            .step-container {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            .step {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
        }
        
        h1, h2, .font-elegant {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .glass-panel {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .option-card {
            background: rgba(40, 40, 40, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .option-card:hover {
            transform: translateY(-4px);
            background: rgba(50, 50, 50, 0.95);
            border-color: rgba(230, 177, 122, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .option-card.selected {
            background: linear-gradient(135deg, rgba(230, 177, 122, 0.15), rgba(27, 67, 50, 0.15));
            border-color: #E6B17A;
            box-shadow: 0 0 20px rgba(230, 177, 122, 0.2);
            transform: translateY(-2px);
        }
        
        .next-btn {
            background: linear-gradient(135deg, #E6B17A, #A0522D);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        
        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(230, 177, 122, 0.3);
        }
        
        .next-btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .prev-btn {
            background: rgba(85, 85, 85, 0.6);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        .prev-btn:hover {
            background: rgba(120, 120, 120, 0.8);
            transform: translateY(-2px);
        }

        .color-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .color-option:hover {
            transform: scale(1.05);
        }
        .color-option.selected {
            border-color: #E6B17A;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(230, 177, 122, 0.3);
        }

        .design-option img {
            transition: transform 0.3s ease;
        }
        .design-option:hover img {
            transform: scale(1.02);
        }
        
        #preview-panel {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translate(100%, -50%);
            width: 350px;
            transition: transform 0.5s ease;
            z-index: 100;
        }
        #preview-panel.visible {
            transform: translate(0, -50%);
        }
        
        #preview-panel.final-summary {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            z-index: 200;
        }

        .preview-box {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            background-color: #e0e0e0;
        }
        .preview-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .step-content {
            opacity: 0;
            transform: translateY(50px);
            display: none;
        }

        #final-summary-view {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 150;
            opacity: 0;
        }

        /* Special Request Styling */
        .special-request-btn {
            background: rgba(230, 177, 122, 0.1);
            border: 1px solid rgba(230, 177, 122, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #E6B17A;
        }
        
        .special-request-btn:hover {
            background: rgba(230, 177, 122, 0.2);
            border-color: rgba(230, 177, 122, 0.5);
        }
        
        .special-request-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            width: 100%;
            margin: 8px 0;
        }
        
        .special-request-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .step-container {
                width: 500%;
            }
            
            .step {
                width: 20%;
                padding: 1rem;
            }
            
            .glass-panel {
                padding: 1.5rem !important;
            }
            
            h1 {
                font-size: 2rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            .option-card {
                padding: 1rem !important;
            }
            
            .color-option {
                width: 60px;
                height: 60px;
            }
            
            #preview-panel {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .step-container {
                width: 100%;
            }
            
            .step {
                width: 100%;
                padding: 0.75rem;
                min-height: 100vh;
                flex-direction: column;
                align-items: stretch;
            }
            
            .glass-panel {
                padding: 1rem !important;
                margin: 0 0.5rem;
            }
            
            h1 {
                font-size: 1.75rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            h2 {
                font-size: 1.125rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .option-card {
                padding: 0.75rem !important;
                font-size: 14px;
            }
            
            .color-option {
                width: 50px;
                height: 50px;
            }
            
            .next-btn, .prev-btn {
                padding: 0.75rem 1.5rem !important;
                font-size: 14px !important;
            }
            
            #preview-panel {
                position: static !important;
                transform: none !important;
                width: 100% !important;
                margin-top: 2rem;
                order: 2;
                z-index: 1;
            }
            
            #preview-panel.visible {
                transform: none !important;
            }
            
            #preview-panel.final-summary {
                width: 95%;
                max-width: none;
            }
            
            .preview-box {
                padding-top: 100%;
            }
            
            #initials-input {
                font-size: 1.5rem !important;
                padding: 0.75rem !important;
            }
            
            /* Mobile layout: options above, preview below */
            .step > div {
                width: 100%;
                max-width: none;
            }
            
            /* Prevent horizontal scrolling on mobile */
            body {
                overflow-x: hidden !important;
            }
            
            .step-container {
                overflow-x: hidden !important;
            }
        }

        @media (max-width: 480px) {
            .step {
                padding: 0.5rem;
            }
            
            .glass-panel {
                padding: 0.75rem !important;
                margin: 0 0.25rem;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1rem !important;
            }
            
            .option-card {
                padding: 0.5rem !important;
                font-size: 12px;
            }
            
            .color-option {
                width: 45px;
                height: 45px;
            }
            
            .next-btn, .prev-btn {
                padding: 0.5rem 1rem !important;
                font-size: 12px !important;
            }
            
            #preview-panel {
                width: 100% !important;
                padding: 0.75rem !important;
            }
            
            #initials-input {
                font-size: 1.25rem !important;
                padding: 0.5rem !important;
            }
        }

        /* Horizontal Orientation */
        @media (orientation: landscape) and (max-height: 600px) {
            .step {
                min-height: 100vh;
                padding: 0.5rem;
            }
            
            .glass-panel {
                padding: 1rem !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            h2 {
                font-size: 1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .option-card {
                padding: 0.5rem !important;
            }
            
            .color-option {
                width: 50px;
                height: 50px;
            }
            
            #preview-panel {
                width: 250px;
                padding: 0.75rem !important;
            }
        }

        /* Prevent overlay at all viewport sizes */
        @media (min-width: 769px) {
            .step-container {
                display: flex;
                width: 500%;
                gap: 0;
                align-items: stretch;
            }
            
            .step {
                width: 20%;
                display: flex;
            }
            
            #preview-panel {
                position: fixed;
                top: 50%;
                right: 0;
                transform: translate(100%, -50%);
                width: 350px;
                z-index: 100;
            }
            
            #preview-panel.visible {
                transform: translate(0, -50%);
            }
            
            #preview-panel.final-summary {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 800px;
                z-index: 200;
            }
        }

        /* Special Request Styling */
        .special-request-btn {
            background: rgba(230, 177, 122, 0.1);
            border: 1px solid rgba(230, 177, 122, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #E6B17A;
        }
        
        .special-request-btn:hover {
            background: rgba(230, 177, 122, 0.2);
            border-color: rgba(230, 177, 122, 0.5);
        }
        
        .special-request-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: white;
            width: 100%;
            margin: 8px 0;
        }
        
        .special-request-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Animation states */
        .gsap-hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* Mobile-specific preview panel behavior */
        @media (max-width: 768px) {
            /* Force mobile layout and reset desktop styles */
            .step-container {
                display: block !important;
                width: 100% !important;
                transform: none !important;
                transition: none !important;
                min-height: auto !important;
            }
            .step {
                width: 100% !important;
                display: none; /* Hide all steps by default */
                opacity: 1;
                transform: none;
                padding: 1rem;
                margin: 0;
            }
            .step.active {
                display: flex; /* Show only the active step */
            }

            /* Special handling for Step 1 to force it to the top */
            #step-1.active {
                position: fixed !important; /* Take it out of flow */
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100vh !important; /* Make it full screen */
                background: #1a1a1a !important; /* Ensure it has a background */
                z-index: 10000 !important; /* Highest z-index */
                display: flex !important;
                justify-content: center; /* Center content vertically and horizontally */
                align-items: center;
            }

            /* Reset preview panel for normal flow on steps 2+ */
            #preview-panel {
                position: relative !important;
                width: 100% !important;
                max-width: none !important;
                margin-bottom: 1rem !important; /* Space between preview and options */
                transform: none !important;
                z-index: 100;
                opacity: 0; /* Hidden by default, JS will show it */
                display: none; /* Hidden by default */
            }
            #preview-panel.visible {
                display: block;
                opacity: 1;
            }
            
            /* Hide preview panel if we are on step 1 */
            body:has(#step-1.active) #preview-panel {
                display: none !important;
            }
        }

        /* Force mobile page to start at top */
        @media (max-width: 768px) {
            html, body {
                scroll-behavior: auto !important;
                overflow-x: hidden !important;
            }
            
            .step-container {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }
            
            /* Ensure step 1 is absolutely positioned at top */
            #step-1.active {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                margin: 0 !important;
                padding: 1rem !important;
                z-index: 1000 !important;
                transform: none !important;
            }
        }
    </style>
</head>
<body>

    <div id="preview-panel" class="glass-panel p-6">
        <h2 class="font-elegant text-2xl text-mustard-gold mb-4">Förhandsvisning</h2>
        <div class="preview-box rounded-lg overflow-hidden mb-4">
            <div id="preview-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-800">
                <i class="fas fa-box text-5xl"></i>
            </div>
            <img id="preview-base" class="preview-layer" src="" alt="Låda bas">
            <img id="preview-logo" class="preview-layer" src="" alt="Låda logo">
            <img id="preview-button" class="preview-layer" src="" alt="Låda knapp">
        </div>
        <div id="summary" class="space-y-2 text-gray-300">
            <div><strong>Kaliber:</strong> <span id="summary-caliber" class="font-bold text-white">-</span></div>
            <div><strong>Primär Färg:</strong> <span id="summary-primary" class="font-bold text-white">-</span></div>
            <div><strong>Sekundär Färg:</strong> <span id="summary-secondary" class="font-bold text-white">-</span></div>
            <div><strong>Design:</strong> <span id="summary-design" class="font-bold text-white">-</span></div>
            <div><strong>Initialer:</strong> <span id="summary-initials" class="font-bold text-white">-</span></div>
        </div>
        <div class="border-t border-gray-600 mt-4 pt-4">
             <div class="flex justify-between items-center text-2xl font-elegant">
                <span class="text-mustard-gold">TOTALT:</span>
                <span id="total-price" class="text-white">850kr</span>
            </div>
        </div>
    </div>


    <div id="final-summary-view"></div>

    <div class="step-container">
        <!-- Step 1: Caliber Selection -->
        <div id="step-1" class="step">
            <div class="text-center w-full max-w-4xl">
                <div class="glass-panel p-8 md:p-12">
                    <h1 class="text-4xl md:text-5xl mb-2 text-mustard-gold font-elegant">STEG 1</h1>
                    <h2 class="text-2xl md:text-3xl mb-10 text-gray-300 font-elegant">VÄLJ DIN KALIBER</h2>
                    
                    <div id="caliber-options" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-12">
                        <!-- Caliber options will be injected here by JS -->
                    </div>
                    
                    <div class="special-request-btn" onclick="toggleSpecialRequest('caliber')">
                        <i class="fas fa-plus-circle mr-2"></i>Specialförfrågan? Anges på steg 5
                    </div>
                    
                    <div id="caliber-special-input" class="hidden mb-8">
                        <textarea id="caliber-special" class="special-request-input" placeholder="Beskriv din specialförfrågan för kaliber..." rows="2"></textarea>
                    </div>
                    
                    <button id="next-btn-1" class="next-btn text-white font-bold py-4 px-10 rounded-lg text-lg" disabled>
                        Nästa <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Primary Color -->
        <div id="step-2" class="step">
            <div class="text-center w-full max-w-4xl">
                <div class="glass-panel p-8 md:p-12">
                    <h1 class="text-4xl md:text-5xl mb-2 text-mustard-gold font-elegant">STEG 2</h1>
                    <h2 class="text-2xl md:text-3xl mb-10 text-gray-300 font-elegant">VÄLJ PRIMÄR FÄRG</h2>
                    
                    <div id="primary-color-options" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-12">
                         <!-- Color options will be injected here by JS -->
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="prev-btn-2" class="prev-btn text-white font-bold py-4 px-10 rounded-lg text-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Tillbaka
                        </button>
                        <button id="next-btn-2" class="next-btn flex-1 text-white font-bold py-4 px-10 rounded-lg text-lg" disabled>
                            Nästa <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Secondary Color -->
        <div id="step-3" class="step">
            <div class="text-center w-full max-w-4xl">
                <div class="glass-panel p-8 md:p-12">
                    <h1 class="text-4xl md:text-5xl mb-2 text-mustard-gold font-elegant">STEG 3</h1>
                    <h2 class="text-2xl md:text-3xl mb-10 text-gray-300 font-elegant">VÄLJ SEKUNDÄR FÄRG</h2>
                     <div id="secondary-color-options" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-12">
                         <!-- Color options will be injected here by JS -->
                    </div>
                    <div class="flex gap-4">
                        <button id="prev-btn-3" class="prev-btn text-white font-bold py-4 px-10 rounded-lg text-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Tillbaka
                        </button>
                        <button id="next-btn-3" class="next-btn flex-1 text-white font-bold py-4 px-10 rounded-lg text-lg" disabled>
                            Nästa <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Design -->
        <div id="step-4" class="step">
            <div class="text-center w-full max-w-5xl">
                <div class="glass-panel p-8 md:p-12">
                    <h1 class="text-4xl md:text-5xl mb-2 text-mustard-gold font-elegant">STEG 4</h1>
                    <h2 class="text-2xl md:text-3xl mb-10 text-gray-300 font-elegant">VÄLJ DIN DESIGN</h2>
                    <div id="design-options" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-12">
                        <!-- Design options will be injected here by JS -->
                    </div>
                    <div class="flex gap-4">
                        <button id="prev-btn-4" class="prev-btn text-white font-bold py-4 px-10 rounded-lg text-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Tillbaka
                        </button>
                        <button id="next-btn-4" class="next-btn flex-1 text-white font-bold py-4 px-10 rounded-lg text-lg" disabled>
                            Nästa <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 5: Initials & Summary -->
        <div id="step-5" class="step">
             <div class="text-center w-full max-w-4xl">
                <div class="glass-panel p-8 md:p-12">
                    <h1 class="text-4xl md:text-5xl mb-2 text-mustard-gold font-elegant">STEG 5</h1>
                    <h2 class="text-2xl md:text-3xl mb-10 text-gray-300 font-elegant">LÄGG TILL INITIALER (VALFRITT)</h2>
                    
                    <input type="text" id="initials-input" placeholder="T.EX. J.S." maxlength="5" class="w-full max-w-sm mx-auto bg-gray-900 border-2 border-gray-600 rounded-lg text-white text-center text-3xl p-4 mb-8 focus:border-mustard-gold focus:ring-mustard-gold transition">
                    
                    <div class="special-request-btn" onclick="toggleSpecialRequest('initials')">
                        <i class="fas fa-plus-circle mr-2"></i>Har du en specialförfrågan? Skriv det här
                    </div>
                    
                    <div id="special-request-inputs" class="hidden mb-8">
                        <textarea id="caliber-special" class="special-request-input" placeholder="Beskriv din specialförfrågan för kaliber..." rows="2"></textarea>
                        <textarea id="initials-special" class="special-request-input" placeholder="Beskriv din specialförfrågan för initialer..." rows="2"></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="prev-btn-5" class="prev-btn text-white font-bold py-4 px-10 rounded-lg text-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Tillbaka
                        </button>
                        <button id="finish-btn" class="next-btn flex-1 text-white font-bold py-4 px-10 rounded-lg text-lg">
                            Slutför & Lägg i Varukorg <i class="fas fa-shopping-cart ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stepContainer = document.querySelector('.step-container');
            const previewPanel = document.getElementById('preview-panel');
            let currentStep = 1;

            const selections = {
                caliber: null,
                primaryColor: null,
                secondaryColor: null,
                design: null,
                initials: '',
                caliberSpecial: '',
                initialsSpecial: ''
            };

            const calibers = [
                ".308 Win", ".223 Rem", "9.3x62", "7x57", ".340 Wby", "8x57",
                ".30-06", ".300 Win Mag", "6.5x55", "12 Gauge"
            ];

            const caliberOptionsContainer = document.getElementById('caliber-options');
            
            // --- ALL FUNCTIONS AND LOGIC GO HERE ---
            function animateInStep(stepNum) {
                const stepContent = document.querySelector(`#step-${stepNum} .glass-panel`);
                const options = stepContent.querySelectorAll('.option-card, .color-option, .design-option, input');
                const buttons = stepContent.querySelectorAll('button');

                gsap.set(stepContent, { y: 100, opacity: 0 });
                gsap.set([...options, ...buttons], { y: 50, opacity: 0 });

                const tl = gsap.timeline({
                    onComplete: () => {
                         // After animation, re-enable main step listeners
                    }
                });

                tl.to(stepContent, { y: 0, opacity: 1, duration: 0.8, ease: "power3.out" })
                  .to([...options, ...buttons], {
                    y: 0,
                    opacity: 1,
                    duration: 0.5,
                    stagger: 0.05,
                    ease: "power3.out"
                }, "-=0.5");
            }

            function animateOutStep(stepNum, onComplete) {
                const stepContent = document.querySelector(`#step-${stepNum} .glass-panel`);
                 gsap.to(stepContent, {
                    y: -100,
                    opacity: 0,
                    duration: 0.6,
                    ease: "power3.in",
                    onComplete: onComplete
                });
            }

            function toggleSpecialRequest(type) {
                if (type === 'caliber') {
                    const caliberSpecialInput = document.getElementById('caliber-special-input');
                    const caliberSpecial = document.getElementById('caliber-special');
                    
                    if (caliberSpecialInput.classList.contains('hidden')) {
                        caliberSpecialInput.classList.remove('hidden');
                        caliberSpecial.focus();
                    } else {
                        caliberSpecialInput.classList.add('hidden');
                    }
                } else if (type === 'initials') {
                    const specialInputs = document.getElementById('special-request-inputs');
                    const initialsSpecial = document.getElementById('initials-special');
                    
                    if (specialInputs.classList.contains('hidden')) {
                        specialInputs.classList.remove('hidden');
                        initialsSpecial.focus();
                    } else {
                        specialInputs.classList.add('hidden');
                    }
                }
            }

            function populateOptions() {
                console.log('Starting populateOptions...');
                
                // Check if containers exist
                const caliberOptionsContainer = document.getElementById('caliber-options');
                const primaryColorContainer = document.getElementById('primary-color-options');
                const secondaryColorContainer = document.getElementById('secondary-color-options');
                const designContainer = document.getElementById('design-options');
                
                console.log('Containers found:', {
                    caliber: caliberOptionsContainer,
                    primary: primaryColorContainer,
                    secondary: secondaryColorContainer,
                    design: designContainer
                });
                
                if (!caliberOptionsContainer) {
                    console.error('caliber-options container not found!');
                    return;
                }
                
                // Calibers
                console.log('Creating caliber options...');
                calibers.forEach(caliber => {
                    const card = document.createElement('div');
                    card.className = 'option-card p-6 flex items-center justify-center text-center';
                    card.dataset.caliber = caliber;
                    card.innerHTML = `<span class="font-semibold text-lg">${caliber}</span>`;
                    caliberOptionsContainer.appendChild(card);
                });
                console.log(`Created ${calibers.length} caliber options`);

                // Primary Colors
                if (primaryColorContainer) {
                    console.log('Creating primary color options...');
                    const primaryColors = [
                        { name: 'Svart', value: 'black' }, { name: 'Vit', value: 'white' }, { name: 'Grå', value: 'gray' },
                        { name: 'Grön', value: 'green' }, { name: 'Röd', value: 'red' }, { name: 'Mörkgrön', value: 'darkgreen' }
                    ];
                    primaryColors.forEach(color => {
                        const option = document.createElement('div');
                        option.className = 'text-center';
                        option.innerHTML = `
                            <div class="color-option mx-auto" style="background-color:${color.value}" data-color="${color.value}"></div>
                            <span class="mt-2 inline-block">${color.name}</span>
                        `;
                        primaryColorContainer.appendChild(option);
                    });
                    console.log(`Created ${primaryColors.length} primary color options`);
                }

                // Secondary Colors
                if (secondaryColorContainer) {
                    console.log('Creating secondary color options...');
                    const secondaryColors = [
                        { name: 'Guld', value: 'gold' }, { name: 'Röd', value: 'red' }, { name: 'Orange', value: 'orange' },
                        { name: 'Svart', value: 'black' }, { name: 'Vit', value: 'white' }
                    ];
                    secondaryColors.forEach(color => {
                        const option = document.createElement('div');
                        option.className = 'text-center';
                        option.innerHTML = `
                            <div class="color-option mx-auto" style="background-color:${color.value}" data-color="${color.value}"></div>
                            <span class="mt-2 inline-block">${color.name}</span>
                        `;
                        secondaryColorContainer.appendChild(option);
                    });
                    console.log(`Created ${secondaryColors.length} secondary color options`);
                }
                
                // Designs
                if (designContainer) {
                    console.log('Creating design options...');
                    const designs = [
                        { name: 'Design 1', id: 'alg_logo', img: '/images/alg_logo.svg' },
                        { name: 'Design 2', id: 'alg_design', img: '/images/alg_design.svg' },
                        { name: 'Design 3', id: 'alg_jagare', img: '/images/alg_jagare.svg' },
                        { name: 'Design 4', id: 'alg_majestic', img: '/images/alg_majestic.svg' },
                        { name: 'Ingen Design', id: 'none', img: null }
                    ];
                    designs.forEach(design => {
                        const card = document.createElement('div');
                        card.className = 'option-card design-option p-4 flex flex-col items-center justify-center text-center';
                        card.dataset.design = design.id;
                        card.innerHTML = design.img ?
                            `<img src="${design.img}" alt="${design.name}" class="h-24 object-contain mb-2"><span class="font-semibold">${design.name}</span>` :
                            `<div class="h-24 flex items-center justify-center"><i class="fas fa-times text-4xl text-gray-500"></i></div><span class="font-semibold">${design.name}</span>`;
                        designContainer.appendChild(card);
                    });
                    console.log(`Created ${designs.length} design options`);
                }
                
                console.log('populateOptions completed');
            }

            function updatePreview() {
                const basePrice = 850;
                let initialsPrice = 0;
                let specialRequestPrice = 0;
                
                // Update text
                document.getElementById('summary-caliber').textContent = selections.caliber || '-';
                document.getElementById('summary-primary').textContent = selections.primaryColor ? selections.primaryColor.name : '-';
                document.getElementById('summary-secondary').textContent = selections.secondaryColor ? selections.secondaryColor.name : '-';
                document.getElementById('summary-design').textContent = selections.design ? selections.design.name : '-';
                document.getElementById('summary-initials').textContent = selections.initials || '-';

                // Update images
                const placeholder = document.getElementById('preview-placeholder');
                const baseImg = document.getElementById('preview-base');
                const logoImg = document.getElementById('preview-logo');
                const buttonImg = document.getElementById('preview-button');

                if (selections.primaryColor) {
                    placeholder.style.display = 'none';
                    baseImg.src = `/images/primarycolors/${selections.primaryColor.value}box.PNG`;
                    baseImg.style.opacity = 1;
                } else {
                    placeholder.style.display = 'flex';
                    baseImg.style.opacity = 0;
                }
                
                if (selections.secondaryColor && selections.design && selections.design.id !== 'none') {
                     logoImg.src = `/images/secondarycolors/${selections.secondaryColor.value}logo.PNG`;
                     buttonImg.src = `/images/secondarycolors/${selections.secondaryColor.value}button.PNG`;
                     logoImg.style.opacity = 1;
                     buttonImg.style.opacity = 1;
                } else {
                    logoImg.style.opacity = 0;
                    buttonImg.style.opacity = 0;
                }

                // Update price
                if (selections.initials) {
                    initialsPrice = 100;
                }
                if (selections.caliberSpecial || selections.initialsSpecial) {
                    specialRequestPrice = 200;
                }
                document.getElementById('total-price').textContent = `${basePrice + initialsPrice + specialRequestPrice}kr`;
            }

            function setupStepListeners(stepNum) {
                const nextBtn = document.getElementById(`next-btn-${stepNum}`);
                const prevBtn = document.getElementById(`prev-btn-${stepNum}`);
                const stepContent = document.getElementById(`step-${stepNum}`);

                const options = stepContent.querySelectorAll('.option-card, .color-option, .design-option');
                
                options.forEach(card => {
                    card.addEventListener('click', () => {
                        options.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');

                        // Store selection
                        if (card.dataset.caliber) selections.caliber = card.dataset.caliber;
                        if (card.dataset.color) {
                             const colorName = card.nextElementSibling.textContent;
                             const colorValue = card.dataset.color;
                            if(stepNum === 2) selections.primaryColor = { name: colorName, value: colorValue};
                            if(stepNum === 3) selections.secondaryColor = { name: colorName, value: colorValue};
                        }
                        if (card.dataset.design) {
                            const designName = card.querySelector('span').textContent;
                            const designId = card.dataset.design;
                            selections.design = { name: designName, id: designId };
                        }

                        updatePreview();
                        if(nextBtn) nextBtn.disabled = false;
                    });
                });

                if (stepNum === 5) {
                    const initialsInput = document.getElementById('initials-input');
                    initialsInput.addEventListener('input', (e) => {
                        selections.initials = e.target.value;
                        updatePreview();
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (!nextBtn.disabled) {
                            goToStep(stepNum + 1);
                        }
                    });
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                         if(previewPanel.classList.contains('final-summary')) {
                            hideFinalSummary();
                        } else {
                            goToStep(stepNum - 1);
                        }
                    });
                }
            }

            function goToStep(step) {
                // Handle final summary
                if (step > 5) {
                    showFinalSummary();
                    return;
                }
                
                // Desktop: horizontal slide transition
                if (window.innerWidth > 768) {
                    const targetX = `-${(step - 1) * 20}%`;
                    gsap.to(stepContainer, {
                        x: targetX,
                        duration: 0.8,
                        ease: "power3.inOut",
                        onComplete: () => {
                            animateInStep(step);
                        }
                    });
                } else {
                    // Mobile: NEW transition logic
                    const isLeavingStep1 = currentStep === 1 && step === 2;
                    const currentStepElement = document.getElementById(`step-${currentStep}`);
                    const targetStepElement = document.getElementById(`step-${step}`);

                    if (isLeavingStep1) {
                        // Fade out the fixed Step 1
                        gsap.to(currentStepElement, {
                            opacity: 0,
                            duration: 0.5,
                            onComplete: () => {
                                currentStepElement.classList.remove('active');
                                window.scrollTo({ top: 0, behavior: 'instant' });
                                
                                previewPanel.classList.add('visible');
                                targetStepElement.classList.add('active');

                                gsap.fromTo(previewPanel, { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.6 });
                                gsap.fromTo(targetStepElement, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.6, delay: 0.2 });
                                
                                // Restore auto-scroll to options
                                setTimeout(() => {
                                    targetStepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 1000);
                            }
                        });
                    } else {
                        // Standard fade between steps 2-5 (and backwards)
                        gsap.to(currentStepElement, {
                            opacity: 0,
                            duration: 0.4,
                            onComplete: () => {
                                currentStepElement.classList.remove('active');
                                targetStepElement.classList.add('active');
                                window.scrollTo({ top: 0, behavior: 'instant' });
                                gsap.fromTo(targetStepElement, { opacity: 0 }, { opacity: 1, duration: 0.4 });

                                // Auto-scroll down if moving forward
                                if (step > currentStep) {
                                    setTimeout(() => {
                                        // Use the reliable scrollIntoView method for all steps
                                        targetStepElement.scrollIntoView({
                                            behavior: 'smooth',
                                            block: 'start'
                                        });
                                    }, 800);
                                }
                            }
                        });
                    }
                }

                // Update preview panel visibility (Desktop only now)
                if (window.innerWidth > 768) {
                    if (step > 1 && !previewPanel.classList.contains('visible')) {
                        previewPanel.classList.add('visible');
                    }
                    if (step === 1 && previewPanel.classList.contains('visible')) {
                        previewPanel.classList.remove('visible');
                    }
                }

                currentStep = step;
            }

            function showFinalSummary() {
                const finalSummaryView = document.getElementById('final-summary-view');
                if (window.innerWidth > 768) {
                   gsap.to(finalSummaryView, { opacity: 1, duration: 0.5 });
                   previewPanel.classList.add('final-summary');
                } else {
                    // Mobile final summary - just show the panel
                    previewPanel.classList.add('visible', 'final-summary');
                    gsap.fromTo(previewPanel, {opacity: 0}, {opacity: 1, duration: 0.5});
                }
                
                // Rearrange buttons for final view
                document.getElementById('prev-btn-5').style.display = 'block'; 
                document.getElementById('finish-btn').textContent = "Bekräfta & Lägg i Varukorg";
            }

            function hideFinalSummary() {
                 if (window.innerWidth > 768) {
                    const finalSummaryView = document.getElementById('final-summary-view');
                    gsap.to(finalSummaryView, { opacity: 0, duration: 0.5, onComplete: () => finalSummaryView.style.display = 'none' });
                 }
                 previewPanel.classList.remove('final-summary');
                 document.getElementById('finish-btn').textContent = "Slutför & Lägg i Varukorg";
            }
            
            function initializeDesignTool() {
                console.log('Initializing design tool...');
                
                populateOptions();
                console.log('Options populated');

                for(let i = 1; i <= 5; i++) {
                    setupStepListeners(i);
                }

                document.getElementById('finish-btn').addEventListener('click', () => {
                    if(previewPanel.classList.contains('final-summary')) {
                        alert('Tillagd i varukorgen! (Simulerat)');
                    } else {
                        goToStep(6);
                    }
                });

                // Set initial state
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    if (index === 0) {
                        stepEl.classList.add('active');
                    } else {
                        stepEl.classList.remove('active');
                    }
                });
                
                // Trigger initial animation for step 1
                gsap.fromTo("#step-1", { opacity: 0 }, { opacity: 1, duration: 0.8 });
            }

            // Initialize the tool
            initializeDesignTool();
        });

    </script>
</body>
</html>