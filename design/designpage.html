<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Designa Din Egen - Nordkaliber</title>
    <!-- Version: 2024-01-27 - Updated header styling -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="48x48" href="images/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="shortcut icon" type="image/png" href="images/favicon-32x32.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;600;700&family=Oswald:wght@300;400;500;600;700&family=Anton&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #E6B17A;
            --secondary-color: #1a1a1a;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --text-light: #e5e5e5;
            --text-dark: #1a1a1a;
            --glass-bg: rgba(26, 26, 26, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }
        


        .main-container {
            min-height: 100vh;
            padding: 1rem;
        }

        /* Navigation Header Styles */
        .nav-header {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1rem 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .back-arrow {
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }

        .back-arrow:hover {
            color: white;
            background: rgba(230, 177, 122, 0.2);
            transform: translateX(-3px);
        }

        .nordkaliber-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: #E6B17A;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
            transition: all 0.3s ease;
            opacity: 0.9;
        }

        .nordkaliber-text:hover {
            color: #DAA520;
            opacity: 1;
        }

        .spacer {
            width: 50px;
        }

        /* Cart Icon Styles */
        .cart-icon-container {
            position: relative;
        }

        .cart-icon-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
        }

        .cart-icon-btn:hover {
            color: white;
            background: rgba(230, 177, 122, 0.2);
            transform: scale(1.1);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Fix layout alignment and height distribution */
        .row {
            align-items: stretch; /* Make all columns the same height */
        }

        .col-lg-8 {
            display: flex;
            flex-direction: column;
        }

        .step {
            display: none;
            flex: 1; /* Take up available space */
            opacity: 0;
            transform: translateX(15px);
            transition: all 0.3s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        .step-container {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            height: 100%; /* Fill available height */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribute content evenly */
        }

        /* Mobile spacing improvements */
        @media (max-width: 991.98px) {
            .step-container {
                margin-bottom: 1.5rem; /* Reduce spacing on mobile */
                padding: 1.5rem; /* Slightly reduce padding on mobile */
            }
            
            .preview-container,
            .cart-container {
                margin-bottom: 1.5rem; /* Match step container spacing */
                padding: 1.5rem;
            }
            
            .main-container {
                padding: 0.75rem; /* Reduce main container padding on mobile */
            }
        }

        /* Ensure the step content fills the container */
        .step-container > *:last-child {
            margin-top: auto; /* Push buttons to bottom */
        }

        /* Step content spacing */
        .step-container .step-title {
            margin-bottom: 1.5rem;
        }

        .step-container .step-subtitle {
            margin-bottom: 2rem;
        }

        .step-container .special-request-container {
            margin: 2rem 0;
            flex: 1; /* Take up remaining space */
        }

        /* Navigation buttons at bottom */
        .step-container .text-center,
        .step-container .d-flex.gap-3.justify-content-center {
            margin-top: auto;
            padding-top: 1rem;
        }

        /* Right sidebar alignment */
        .col-lg-4 {
            display: flex;
            flex-direction: column;
        }

        /* Ensure proper spacing between main content and bottom cart */
        .col-lg-8 {
            margin-bottom: 2rem;
        }

        /* Mobile spacing for main content */
        @media (max-width: 991.98px) {
            .col-lg-8 {
                margin-bottom: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .col-lg-8 {
                margin-bottom: 1rem;
            }
        }





        .step-title {
            font-family: 'Anton', sans-serif;
            font-size: clamp(2rem, 5vw, 3rem);
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .step-subtitle {
            font-family: 'Oswald', sans-serif;
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            color: var(--text-light);
            text-align: center;
            margin-bottom: 2rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .option-card {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-align: center;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px rgba(230, 177, 122, 0.2);
        }

        .option-card.selected {
            background: linear-gradient(135deg, rgba(230, 177, 122, 0.2), rgba(16, 185, 129, 0.2));
            border-color: var(--primary-color);
            box-shadow: 0 0 25px rgba(230, 177, 122, 0.3);
            animation: optionSelected 0.4s ease-out;
        }

        @keyframes optionSelected {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.08);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .color-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin: 0 auto 0.5rem;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .color-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(230, 177, 122, 0.4);
            transform: scale(1.1);
            animation: colorSelected 0.4s ease-out;
        }

        @keyframes colorSelected {
            0% {
                transform: scale(0.9);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .design-option img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .design-option:hover img {
            transform: scale(1.05);
        }

        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color), #A0522D);
            border: none;
            color: white;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-transform: uppercase;
        }

        .btn-custom:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(230, 177, 122, 0.3);
            color: white;
        }

        .btn-custom:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(85, 85, 85, 0.8);
            border: none;
            color: white;
            font-weight: 500;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-transform: uppercase;
        }

        .btn-secondary:hover {
            background: rgba(120, 120, 120, 0.9);
            transform: translateY(-2px);
            color: white;
        }

        .special-request-container {
            margin: 2rem 0;
            text-align: center;
        }

        .special-request-label {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: block;
        }

        .special-request-textbox {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .special-request-textbox:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            background: rgba(0, 0, 0, 0.8);
        }

        .special-request-textbox.active {
            border-color: var(--success-color);
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
            background: rgba(0, 0, 0, 0.9);
        }

        .special-request-textbox::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        /* Clear special request button styles */
        .btn-outline-warning {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: transparent;
            transition: all 0.3s ease;
        }

        .btn-outline-warning:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .step.disabled .option-card,
        .step.disabled .color-option,
        .step.disabled .design-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        /* More specific selectors for step 1 (caliber) */
        #step-1.disabled .caliber-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        #step-1.disabled .caliber-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
        }

        /* Test with even more specific selectors */
        #step-1.disabled .caliber-option,
        #step-1.disabled .option-card {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .step.disabled .option-card:hover,
        .step.disabled .color-option:hover,
        .step.disabled .design-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            border-color: var(--glass-border) !important;
        }

        /* Additional specific rules to ensure disabled state works */
        #step-3.disabled .primary-color-option,
        #step-4.disabled .secondary-color-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        #step-3.disabled .primary-color-option:hover,
        #step-4.disabled .secondary-color-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            border-color: var(--glass-border) !important;
        }

        /* Gray out configured combinations when any step has special request */
        .step.disabled ~ #configured-combinations .configured-combo-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        .step.disabled ~ #configured-combinations .configured-combo-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
        }

        /* Alternative selector for configured combinations when steps are disabled */
        #step-3.disabled ~ #configured-combinations .configured-combo-option,
        #step-4.disabled ~ #configured-combinations .configured-combo-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        #step-3.disabled ~ #configured-combinations .configured-combo-option:hover,
        #step-4.disabled ~ #configured-combinations .configured-combo-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
        }

        /* Style configured combinations when they have disabled class */
        #configured-combinations.disabled .configured-combo-option {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }

        #configured-combinations.disabled .configured-combo-option:hover {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            transform: scale(0.95) !important;
        }

        .step.disabled .special-request-textbox {
            opacity: 1;
            filter: none;
            transform: none;
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .step-indicator {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 700;
            letter-spacing: 1px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(230, 177, 122, 0.3);
        }

        .initials-input {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 2rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .initials-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(230, 177, 122, 0.3);
        }

        .initials-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Preview Panel Styles */
        .preview-container {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .preview-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .preview-box {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            transition: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .preview-box.loading {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(230, 177, 122, 0.1));
            animation: previewPulse 2s ease-in-out infinite;
        }
        

        
        @keyframes previewPulse {
            0%, 100% {
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(230, 177, 122, 0.1));
            }
            50% {
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(230, 177, 122, 0.2));
            }
        }

        .preview-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .preview-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: none;
            will-change: auto;
        }
        
        .preview-next {
            opacity: 0;
            z-index: 1;
        }

        .preview-summary {
            font-size: 0.9rem;
        }

        .preview-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Removed fade-in animations for immediate display */
        .fade-in-detail {
            /* No animation - immediate display */
        }

        /* Image transition styles - removed for immediate changes */
        .preview-image {
            transition: none;
        }

        .preview-placeholder {
            transition: none;
        }

        /* Cart Panel Styles */
        .cart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
        }

        .cart-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 1.5rem 0;
            padding: 1rem;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Saved Product Styles */
        .saved-product {
            background: rgba(16, 185, 129, 0.1) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
        }

        .saved-product .spec-item {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .saved-product .specs-container {
            margin: 0.5rem 0;
        }

        .cart-separator {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 0.5rem;
            }

            .nav-header {
                padding: 0.75rem 1rem;
            }

            .back-arrow {
                width: 40px;
                height: 40px;
            }

            .nordkaliber-text {
                font-size: 2rem;
            }

            .step-container,
            .preview-container,
            .cart-container {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }

            .step-title {
                font-size: 2rem;
            }

            .step-subtitle {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
            }

            .option-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .color-option {
                width: 60px;
                height: 60px;
            }

            .btn-custom,
            .btn-secondary {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .special-request-textbox {
                padding: 0.75rem;
                min-height: 60px;
            }

            .preview-box {
                padding-top: 60%;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 0.25rem;
            }

            .nav-header {
                padding: 0.5rem 0.75rem;
            }

            .back-arrow {
                width: 35px;
                height: 35px;
            }

            .nordkaliber-text {
                font-size: 1.75rem;
            }

            .step-container,
            .preview-container,
            .cart-container {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .step-title {
                font-size: 1.75rem;
            }

            .step-subtitle {
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }

            .option-card {
                padding: 0.75rem;
            }

            .color-option {
                width: 50px;
                height: 50px;
            }

            .btn-custom,
            .btn-secondary {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .special-request-textbox {
                padding: 0.75rem;
                min-height: 60px;
            }
        }

        /* Cart Sidebar Styles */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-left: 1px solid var(--glass-border);
            z-index: 9999;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
        }

        .cart-sidebar.open {
            right: 0;
        }

        .cart-sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-sidebar-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .cart-sidebar-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .cart-sidebar-close:hover {
            color: var(--primary-color);
            background: rgba(230, 177, 122, 0.1);
        }

        .cart-sidebar-content {
            padding: 2rem;
        }

        .cart-sidebar-footer {
            padding: 2rem;
            border-top: 1px solid var(--glass-border);
            position: sticky;
            bottom: 0;
            background: var(--glass-bg);
        }

        .cart-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .cart-sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive cart sidebar */
        @media (max-width: 768px) {
            .cart-sidebar {
                width: 100vw;
                right: -100vw;
            }
        }

        /* Configured Combinations Styles */
        .configured-combinations-container {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .configured-combo-option {
            background: transparent;
            border: none;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .configured-combo-option:hover {
            transform: scale(1.05);
        }

        .configured-combo-option.selected {
            transform: scale(1.1);
        }

        .combo-color-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            background-clip: padding-box;
        }

        .combo-color-circle:hover {
            transform: scale(1.05);
            border-color: rgba(230, 177, 122, 0.4);
        }

        .combo-color-circle.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(230, 177, 122, 0.4);
            transform: scale(1.1);
        }

        .combo-color-circle.black-blaze {
            background: #000000;
        }
        .combo-color-circle.black-blaze::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: #f59e0b;
        }

        .combo-color-circle.nordic-frost {
            background: #000000;
        }
        .combo-color-circle.nordic-frost::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: #ffffff;
        }

        .combo-color-circle.winter-sun {
            background: #ffffff;
        }
        .combo-color-circle.winter-sun::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: #D4AF37;
        }

        .combo-color-circle.midnight-gold {
            background: #000000;
        }
        .combo-color-circle.midnight-gold::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: #D4AF37;
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.9s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(25px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Navigation Header -->
        <div class="nav-header mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="../index.html" class="back-arrow me-3">
                    <i class="fas fa-arrow-left fa-2x"></i>
                </a>
                    <span class="nordkaliber-text">NORDKALIBER</span>
                </div>
                <div class="cart-icon-container">
                    <button id="cart-icon" class="cart-icon-btn" title="Öppna varukorg">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                        <span id="cart-badge" class="cart-badge d-none">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <span id="current-step">1</span> av 5
        </div>

        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8">
                <!-- Step 1: Caliber Selection -->
                <div id="step-1" class="step active">
                    <div class="step-container">
                        <h1 class="step-title">STEG 1</h1>
                        <h2 class="step-subtitle">VÄLJ DIN KALIBER</h2>
                        
                        <div class="row g-3 mb-4" id="caliber-options">
                            <!-- Caliber options will be populated by JavaScript -->
                        </div>
                        
                        <div class="special-request-container">
                            <label for="special-request-1" class="special-request-label">
                                <i class="fas fa-magic me-2"></i>Specialförfrågan för Kaliber
                                <span id="special-status-1" class="badge bg-success ms-2 d-none">Aktiv</span>
                            </label>
                            <textarea 
                                id="special-request-1" 
                                class="special-request-textbox" 
                                placeholder="Klicka här för att skriva en specialförfrågan... (Detta kommer att återställa alla valda alternativ)"
                            ></textarea>
                            <button id="clear-special-1" class="btn btn-sm btn-outline-warning mt-2 d-none" onclick="clearSpecialRequest(1)">
                                <i class="fas fa-times me-1"></i>Rensa Specialförfrågan
                            </button>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Tryck ESC för att avbryta, eller klicka på "Rensa Specialförfrågan"
                            </small>
                        </div>
                        
                        <div class="text-center">
                            <button id="next-btn-1" class="btn btn-custom" disabled>
                                Nästa <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Design -->
                <div id="step-2" class="step">
                    <div class="step-container">
                        <h1 class="step-title">STEG 2</h1>
                        <h2 class="step-subtitle">VÄLJ DIN DESIGN</h2>
                        
                        <div class="text-center mb-3">
                            <p class="text-white small">
                                <i class="fas fa-info-circle me-1"></i>
                                Motiv 10 finns endast i svart                            </p>
                        </div>
                        
                        <div class="row g-3 mb-4" id="design-options">
                            <!-- Design options will be populated by JavaScript -->
                        </div>
                        
                        <div class="special-request-container">
                            <label for="special-request-2" class="special-request-label">
                                <i class="fas fa-magic me-2"></i>Specialförfrågan för Design
                                <span id="special-status-2" class="badge bg-success ms-2 d-none">Aktiv</span>
                            </label>
                            <textarea 
                                id="special-request-2" 
                                class="special-request-textbox" 
                                placeholder="Klicka här för att skriva en specialförfrågan... (Detta kommer att återställa alla valda alternativ)"
                            ></textarea>
                            <button id="clear-special-2" class="btn btn-sm btn-outline-warning mt-2 d-none" onclick="clearSpecialRequest(2)">
                                <i class="fas fa-times me-1"></i>Rensa Specialförfrågan
                            </button>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Tryck ESC för att avbryta, eller klicka på "Rensa Specialförfrågan"
                            </small>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button id="prev-btn-2" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </button>
                            <button id="next-btn-2" class="btn btn-custom" disabled>
                                Nästa <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Primary Color -->
                <div id="step-3" class="step">
                    <div class="step-container">
                        <h1 class="step-title">STEG 3</h1>
                        <h2 class="step-subtitle">VÄLJ PRIMÄR FÄRG</h2>
                        
                        <div class="row g-3 mb-4" id="primary-color-options">
                            <!-- Primary color options will be populated by JavaScript -->
                        </div>
                        
                        <div class="special-request-container">
                            <label for="special-request-3" class="special-request-label">
                                <i class="fas fa-magic me-2"></i>Specialförfrågan för Primär Färg
                                <span id="special-status-3" class="badge bg-success ms-2 d-none">Aktiv</span>
                            </label>
                            <textarea 
                                id="special-request-3" 
                                class="special-request-textbox" 
                                placeholder="Klicka här för att skriva en specialförfrågan... (Detta kommer att återställa alla valda alternativ)"
                            ></textarea>
                            <button id="clear-special-3" class="btn btn-sm btn-outline-warning mt-2 d-none" onclick="clearSpecialRequest(3)">
                                <i class="fas fa-times me-1"></i>Rensa Specialförfrågan
                            </button>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Tryck ESC för att avbryta, eller klicka på "Rensa Specialförfrågan"
                            </small>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button id="prev-btn-3" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </button>
                            <button id="next-btn-3" class="btn btn-custom" disabled>
                                Nästa <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Secondary Color -->
                <div id="step-4" class="step">
                    <div class="step-container">
                        <h1 class="step-title">STEG 4</h1>
                        <h2 class="step-subtitle">VÄLJ SEKUNDÄR FÄRG</h2>
                        
                        <div class="row g-3 mb-4" id="secondary-color-options">
                            <!-- Secondary color options will be populated by JavaScript -->
                        </div>
                        
                        <div class="special-request-container">
                            <label for="special-request-4" class="special-request-label">
                                <i class="fas fa-magic me-2"></i>Specialförfrågan för Sekundär Färg
                                <span id="special-status-4" class="badge bg-success ms-2 d-none">Aktiv</span>
                            </label>
                            <textarea 
                                id="special-request-4" 
                                class="special-request-textbox" 
                                placeholder="Klicka här för att skriva en specialförfrågan... (Detta kommer att återställa alla valda alternativ)"
                            ></textarea>
                            <button id="clear-special-4" class="btn btn-sm btn-outline-warning mt-2 d-none" onclick="clearSpecialRequest(4)">
                                <i class="fas fa-times me-1"></i>Rensa Specialförfrågan
                            </button>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Tryck ESC för att avbryta, eller klicka på "Rensa Specialförfrågan"
                            </small>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button id="prev-btn-4" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </button>
                            <button id="next-btn-4" class="btn btn-custom" disabled>
                                Nästa <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Initials & Summary -->
                <div id="step-5" class="step">
                    <div class="step-container">
                        <h1 class="step-title">STEG 5</h1>
                        <h2 class="step-subtitle">LÄGG TILL INITIALER (VALFRITT)</h2>
                        
                        <div class="text-center mb-4">
                            <input type="text" 
                                   id="initials-input" 
                                   class="initials-input" 
                                   placeholder="T.EX. J.S." 
                                   maxlength="5">
                        </div>
                        
                        <div class="special-request-container">
                            <label for="special-request-5" class="special-request-label">
                                <i class="fas fa-magic me-2"></i>Specialförfrågan för Initialer
                                <span id="special-status-5" class="badge bg-success ms-2 d-none">Aktiv</span>
                            </label>
                            <textarea 
                                id="special-request-5" 
                                class="special-request-textbox" 
                                placeholder="Klicka här för att skriva en specialförfrågan... (Detta kommer att återställa alla valda alternativ)"
                            ></textarea>
                            <button id="clear-special-5" class="btn btn-sm btn-outline-warning mt-2 d-none" onclick="clearSpecialRequest(5)">
                                <i class="fas fa-times me-1"></i>Rensa Specialförfrågan
                            </button>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Tryck ESC för att avbryta, eller klicka på "Rensa Specialförfrågan"
                            </small>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button id="prev-btn-5" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </button>
                            <button id="finish-btn" class="btn btn-custom">
                                <i class="fas fa-shopping-cart me-2"></i>Slutför & Lägg i Varukorg
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Column -->
            <div class="col-lg-4">
                <div class="preview-container">
                    <h3 class="preview-title">
                        <i class="fas fa-eye me-2"></i>Förhandsvisning
                    </h3>
                    <div class="preview-box">
                        <div id="preview-placeholder" class="preview-placeholder">
                            <i class="fas fa-box fa-3x text-muted"></i>
                            <p class="mt-2 text-muted">Välj alternativ för att se förhandsvisning</p>
                        </div>
                        <!-- Base image layers -->
                        <img id="preview-base" class="preview-layer" src="" alt="Låda bas" style="display: none;">
                        <img id="preview-base-next" class="preview-layer preview-next" src="" alt="Låda bas nästa" style="display: none;">
                        <!-- Logo/Design layers -->
                        <img id="preview-logo" class="preview-layer" src="" alt="Låda logo" style="display: none;">
                        <img id="preview-logo-next" class="preview-layer preview-next" src="" alt="Låda logo nästa" style="display: none;">
                        <!-- Button layers -->
                        <img id="preview-button" class="preview-layer" src="" alt="Låda knapp" style="display: none;">
                        <img id="preview-button-next" class="preview-layer preview-next" src="" alt="Låda knapp nästa" style="display: none;">
                    </div>
                    <div class="preview-summary">
                        <div id="preview-details">
                            <!-- Preview details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Configured Combinations Section - Full Width -->
        <div id="configured-combinations" class="configured-combinations-container mb-4">
            <div class="step-container">
                <h2 class="step-subtitle text-center mb-3">
                    <i class="fas fa-palette me-2"></i>VÄLJ EN FÄRDIG FÄRG KOMBINATION
                </h2>
                <div class="row g-3" id="configured-combination-options">
                    <!-- Configured combination options will be populated by JavaScript -->
                </div>
                <div class="text-center mt-3">
                    <button id="clear-configured-combo" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Rensa Val
                    </button>
                </div>
            </div>
        </div>


    </div>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-sidebar-header">
            <h3 class="cart-sidebar-title">
                <i class="fas fa-shopping-cart me-2"></i>Din Varukorg
            </h3>
            <button class="cart-sidebar-close" id="cart-sidebar-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-sidebar-content">
            <div id="cart-sidebar-items">
                <!-- Cart items will be populated here -->
            </div>
        </div>
        <div class="cart-sidebar-footer">
            <div class="cart-total mb-3">
                <span id="cart-sidebar-total">0kr</span>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-secondary" id="continue-shopping">
                    <i class="fas fa-arrow-left me-2"></i>Fortsätt handla
                </button>
                <button class="btn btn-custom" id="go-to-checkout-sidebar">
                    <i class="fas fa-credit-card me-2"></i>Gå till kassan
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar Overlay -->
    <div id="cart-sidebar-overlay" class="cart-sidebar-overlay"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Main application logic
        document.addEventListener('DOMContentLoaded', function() {
            
            // Application state
            const app = {
                currentStep: 1,
                totalSteps: 5,
                selections: {
                    caliber: null,
                    primaryColor: null,
                    secondaryColor: null,
                    configuredCombo: null,
                    design: null,
                    initials: '',
                    caliberSpecial: '',
                    primaryColorSpecial: '',
                    secondaryColorSpecial: '',
                    designSpecial: '',
                    initialsSpecial: ''
                },
                basePrice: 850,
                savedProducts: [] // Array to store completed products
            };

            // Data for options
            const data = {
                calibers: [
                    ".308 Winchester", ".223 Remington", "9.3x62 Mauser", "7x57 Mauser", 
                    ".340 Weatherby Magnum", "8x57 Mauser", ".30-06 Springfield", 
                    ".300 Winchester Magnum", "6.5x55 Swedish Mauser", "12 Gauge (Hagel)"
                ],
                primaryColors: [
                    { name: 'Svart', value: 'black', img: '../images/primarycolors/blackbox.PNG' },
                    { name: 'Vit', value: 'white', img: '../images/primarycolors/boxwhite.PNG' },
                    { name: 'Grå', value: 'gray', img: '../images/primarycolors/graybox.PNG' },
                    { name: 'Grön', value: 'green', img: '../images/primarycolors/greenbox.PNG' },
                    { name: 'Röd', value: 'red', img: '../images/primarycolors/boxred.PNG' },
                    { name: 'Mörkgrön', value: 'darkgreen', img: '../images/primarycolors/darkgreenbox.PNG' }
                ],
                secondaryColors: [
                    { name: 'Svart', value: 'black', img: '../images/secondarycolors/blackbutton.PNG', logo: '../images/secondarycolors/blacklogo.PNG' },
                    { name: 'Vit', value: 'white', img: '../images/secondarycolors/whitebutton.PNG', logo: '../images/secondarycolors/whitelogo.PNG' },
                    { name: 'Guld', value: 'gold', img: '../images/secondarycolors/goldbutton.PNG', logo: '../images/secondarycolors/goldlogo.PNG' },
                    { name: 'Orange', value: 'orange', img: '../images/secondarycolors/orangebutton.PNG', logo: '../images/secondarycolors/orangelogo.PNG' },
                    { name: 'Röd', value: 'red', img: '../images/secondarycolors/redbutton.PNG', logo: '../images/secondarycolors/redlogo.png' }
                ],
                configuredCombinations: [
                    { 
                        id: 'black-blaze', 
                        name: 'Black Blaze', 
                        primaryColor: { name: 'Svart', value: 'black', img: '../images/primarycolors/blackbox.PNG' },
                        secondaryColor: { name: 'Orange', value: 'orange', img: '../images/secondarycolors/orangebutton.PNG', logo: '../images/secondarycolors/orangelogo.PNG' }
                    },
                    { 
                        id: 'nordic-frost', 
                        name: 'Nordic Frost', 
                        primaryColor: { name: 'Svart', value: 'black', img: '../images/primarycolors/blackbox.PNG' },
                        secondaryColor: { name: 'Vit', value: 'white', img: '../images/secondarycolors/whitebutton.PNG', logo: '../images/secondarycolors/whitelogo.PNG' }
                    },
                    { 
                        id: 'winter-sun', 
                        name: 'Winter Sun', 
                        primaryColor: { name: 'Vit', value: 'white', img: '../images/primarycolors/boxwhite.PNG' },
                        secondaryColor: { name: 'Guld', value: 'gold', img: '../images/secondarycolors/goldbutton.PNG', logo: '../images/secondarycolors/goldlogo.PNG' }
                    },
                    { 
                        id: 'midnight-gold', 
                        name: 'Midnight Gold', 
                        primaryColor: { name: 'Svart', value: 'black', img: '../images/primarycolors/blackbox.PNG' },
                        secondaryColor: { name: 'Guld', value: 'gold', img: '../images/secondarycolors/goldbutton.PNG', logo: '../images/secondarycolors/goldlogo.PNG' }
                    }
                ],
                designs: [
                    { 
                        name: 'Motiv 1', 
                        id: 'M1', 
                        optionImg: '../images/motiv/M1/M1.png',
                        variants: {
                            black: '../images/motiv/M1/M1svart.PNG',
                            white: '../images/motiv/M1/M1vit.PNG',
                            gold: '../images/motiv/M1/guldM1.2.png',
                            orange: '../images/motiv/M1/orangeM1.png',
                            red: '../images/motiv/M1/rödM1.png'
                        }
                    },
                    { 
                        name: 'Motiv 2', 
                        id: 'M2', 
                        optionImg: '../images/motiv/M2/M2.png',
                        variants: {
                            black: '../images/motiv/M2/M2svart.PNG',
                            white: '../images/motiv/M2/M2vit.PNG',
                            gold: '../images/motiv/M2/M2guld.png',
                            orange: '../images/motiv/M2/M2orange.png',
                            red: '../images/motiv/M2/M2röd.png'
                        }
                    },
                    { 
                        name: 'Motiv 3', 
                        id: 'M3', 
                        optionImg: '../images/motiv/M3/M3.svg',
                        variants: {
                            black: '../images/motiv/M3/M3svart.PNG',
                            white: '../images/motiv/M3/M3vit.PNG',
                            gold: '../images/motiv/M3/guldM3.png',
                            orange: '../images/motiv/M3/orangeM3.png',
                            red: '../images/motiv/M3/rödM3.png'
                        }
                    },
                    { 
                        name: 'Motiv 4', 
                        id: 'M4', 
                        optionImg: '../images/motiv/M4/M4.svg',
                        variants: {
                            black: '../images/motiv/M4/M4svart.PNG',
                            white: '../images/motiv/M4/M4vit.PNG',
                            gold: '../images/motiv/M4/M4guld.PNG',
                            orange: '../images/motiv/M4/M4orange.PNG',
                            red: '../images/motiv/M4/M4röd.PNG'
                        }
                    },
                    { 
                        name: 'Motiv 5', 
                        id: 'M5', 
                        optionImg: '../images/motiv/M5/M5.PNG',
                        variants: {
                            black: '../images/motiv/M5/M5svart.PNG',
                            white: '../images/motiv/M5/M5vit.PNG',
                            gold: '../images/motiv/M5/M5guld.PNG',
                            orange: '../images/motiv/M5/M5orange.PNG',
                            red: '../images/motiv/M5/M5röd.PNG'
                        }
                    },
                    { 
                        name: 'Motiv 6', 
                        id: 'M6', 
                        optionImg: '../images/motiv/M6/M6.PNG',
                        variants: {
                            black: '../images/motiv/M6/M6svart.PNG',
                            white: '../images/motiv/M6/M6vit.PNG',
                            gold: '../images/motiv/M6/M6guld.PNG',
                            orange: '../images/motiv/M6/M6orange.PNG',
                            red: '../images/motiv/M6/M6röd.PNG'
                        }
                    },
                    { 
                        name: 'Motiv 7', 
                        id: 'M7', 
                        optionImg: '../images/motiv/M7/M7.svg',
                        variants: {
                            black: '../images/motiv/M7/M7svart.PNG',
                            white: '../images/motiv/M7/M7vit.PNG',
                            gold: '../images/motiv/M7/M7guld.PNG',
                            orange: '../images/motiv/M7/M7orange.PNG',
                            red: '../images/motiv/M7/M7röd.PNG'
                        }
                    },
                    { 
                        name: 'Motiv 8', 
                        id: 'M8', 
                        optionImg: '../images/motiv/M8/M8.svg',
                        variants: {
                            black: '../images/motiv/M8/M8svart.PNG',
                            white: '../images/motiv/M8/M8vit.PNG',
                            gold: '../images/motiv/M8/M8guld.PNG',
                            orange: '../images/motiv/M8/M8orange.PNG',
                            red: '../images/motiv/M8/M8röd.PNG'
                        }
                    },
                    { 
                        name: 'Motiv 9', 
                        id: 'M9', 
                        optionImg: '../images/motiv/M9/M9.svg',
                        isSpecial: true, // This one combines grund + color
                        variants: {
                            black: '../images/motiv/M9/M9svart.PNG',
                            white: '../images/motiv/M9/M9vit.PNG',
                            gold: '../images/motiv/M9/M9guld.PNG',
                            orange: '../images/motiv/M9/M9orange.PNG',
                            red: '../images/motiv/M9/M9röd.PNG'
                        },
                        base: '../images/motiv/M9/M9grund.PNG'
                    },
                    { 
                        name: 'Motiv 10', 
                        id: 'M10', 
                        optionImg: '../images/motiv/M10/M10.svg',
                        isSpecial: true, // This one only has one color
                        variants: {
                            black: '../images/motiv/M10/M10svart.PNG'
                        }
                    },
                    { name: 'Inget motiv', id: 'none', optionImg: null, variants: {} }
                ]
            };

            // Initialize the application
            function init() {
                // Load saved products from localStorage
                loadSavedProducts();
                
                // Set default selections
                setDefaultSelections();
                
                populateOptions();
                setupEventListeners();
                updateStepIndicator();
                updateCart();
                
                // Preload common images for smoother transitions
                preloadCommonImages();
                
                // Wait a bit for default selections to be applied, then update preview
                setTimeout(() => {
                updatePreview();
                
                    // Force show some images for testing
                    setTimeout(() => {
                        forceShowPreview();
                    }, 1000);
                }, 500);
                
                // Initialize button states (this will disable next buttons initially)
                updateAllButtonStates();
                
                // Initialize configured combinations visibility
                updateConfiguredCombinationsVisibility();
            }

            // Load saved products from localStorage
            function loadSavedProducts() {
                const savedProducts = localStorage.getItem('nordkaliberProducts');
                if (savedProducts) {
                    app.savedProducts = JSON.parse(savedProducts);
                }
            }

            // Preload common images for smoother transitions
            function preloadCommonImages() {

                
                // Preload primary colors
                data.primaryColors.forEach(color => {
                    if (color.img) {
                        const img = new Image();
                        img.src = color.img;
                    }
                });
                
                // Preload secondary colors
                data.secondaryColors.forEach(color => {
                    if (color.img) {
                        const img = new Image();
                        img.src = color.img;
                    }
                    if (color.logo) {
                        const img = new Image();
                        img.src = color.logo;
                    }
                });
                
                // Preload design variants
                data.designs.forEach(design => {
                    if (design.variants) {
                        Object.values(design.variants).forEach(variant => {
                            if (variant) {
                                const img = new Image();
                                img.src = variant;
                            }
                        });
                    }
                    if (design.base) {
                        const img = new Image();
                        img.src = design.base;
                    }
                });
                

            }

            // Set standard selections for special request (without UI selection)
            function setStandardSelectionsForSpecialRequest(stepNum) {
                switch(stepNum) {
                    case 1: // Caliber - no visual change needed
                        break;
                    case 2: // Design - set to Motiv 8
                        app.selections.design = data.designs.find(d => d.id === 'M8');
                        break;
                    case 3: // Primary Color - set to Grå
                        app.selections.primaryColor = data.primaryColors.find(c => c.value === 'gray');
                        break;
                    case 4: // Secondary Color - set to Svart
                        app.selections.secondaryColor = data.secondaryColors.find(c => c.name === 'Svart');
                        break;
                    case 5: // Initials - no visual change needed
                        break;
                }
            }

            // Clear special request for a specific step type
            function clearSpecialRequestForStep(type) {
                let stepNum = 0;
                
                // Map type to step number
                switch(type) {
                    case 'caliber': stepNum = 1; break;
                    case 'design': stepNum = 2; break;
                    case 'primaryColor': stepNum = 3; break;
                    case 'secondaryColor': stepNum = 4; break;
                    case 'initials': stepNum = 5; break;
                }
                
                if (stepNum > 0) {
                    const textbox = document.getElementById(`special-request-${stepNum}`);
                    const status = document.getElementById(`special-status-${stepNum}`);
                    const step = document.getElementById(`step-${stepNum}`);
                    const clearButton = document.getElementById(`clear-special-${stepNum}`);
                    
                    if (textbox && status && step) {
                        // Clear special request
                        textbox.value = '';
                        textbox.classList.remove('active');
                        status.classList.add('d-none');
                        status.classList.remove('bg-success');
                        step.classList.remove('disabled');
                        
                        // Hide clear button
                        if (clearButton) {
                            clearButton.classList.add('d-none');
                        }
                        
                        // Clear special request from selections
                        switch(stepNum) {
                            case 1: app.selections.caliberSpecial = ''; break;
                            case 2: app.selections.designSpecial = ''; break;
                            case 3: app.selections.primaryColorSpecial = ''; break;
                            case 4: app.selections.secondaryColorSpecial = ''; break;
                            case 5: app.selections.initialsSpecial = ''; break;
                        }
                        
                        // Update configured combinations disabled state
                        updateConfiguredCombinationsDisabledState();
                        
                        // Update preview and cart
                        updatePreview();
                        updateCart();
                        
                        // Update button states
                        updateAllButtonStates();
                    }
                }
                }

            // Check if there are any visual selections (UI selected state) for a step
            function checkVisualSelections(stepNum) {
                switch(stepNum) {
                    case 1:
                        return document.querySelector('.caliber-option.selected') !== null;
                    case 2:
                        return document.querySelector('.design-option.selected') !== null;
                    case 3:
                        return document.querySelector('.primary-color-option.selected') !== null || 
                               document.querySelector('.configured-combo-option.selected') !== null;
                    case 4:
                        return document.querySelector('.secondary-color-option.selected') !== null;
                    case 5:
                        return document.getElementById('initials-input').value.trim() !== '';
                    default:
                        return false;
                }
            }

            // Check if a special request is active for a step
            function checkSpecialRequestActive(stepNum) {
                const textbox = document.getElementById(`special-request-${stepNum}`);
                if (!textbox) return false;
                
                return textbox.value.trim().length > 0;
            }

            // Update configured combinations disabled state based on any disabled step
            function updateConfiguredCombinationsDisabledState() {
                const configuredCombinations = document.getElementById('configured-combinations');
                if (!configuredCombinations) return;
                
                // Check if any step is disabled
                const hasDisabledStep = document.querySelector('.step.disabled') !== null;
                
                if (hasDisabledStep) {
                    configuredCombinations.classList.add('disabled');
                } else {
                    configuredCombinations.classList.remove('disabled');
                }
            }



            // Set default selections for better user experience
            function setDefaultSelections() {
                // Set default primary color (gray)
                app.selections.primaryColor = data.primaryColors.find(c => c.value === 'gray');
                
                // Set default secondary color (black)
                app.selections.secondaryColor = data.secondaryColors.find(c => c.name === 'Svart');
                
                // Set default design (Motiv 8)
                app.selections.design = data.designs.find(d => d.id === 'M8');
                

                
                // Show loading state initially
                const previewBox = document.getElementById('preview-box');
                if (previewBox) {
                    previewBox.classList.add('loading');
                }
                
                // DO NOT mark these as selected in the UI - they should only show in preview
                // The standards are set in app.selections but not visually selected
                
                // Remove loading state after a short delay
                setTimeout(() => {
                    if (previewBox) {
                        previewBox.classList.remove('loading');
                    }
                }, 500);
            }

            // Set default selections without loading state (for reset scenarios)
            function setDefaultSelectionsSilent() {
                // Set default primary color (gray)
                app.selections.primaryColor = data.primaryColors.find(c => c.value === 'gray');
                
                // Set default secondary color (black)
                app.selections.secondaryColor = data.secondaryColors.find(c => c.name === 'Svart');
                
                // Set default design (Motiv 8)
                app.selections.design = data.designs.find(d => d.id === 'M8');
                

            }

            // Get design image based on secondary color
            function getDesignImage(design, secondaryColor) {
                if (!design || design.id === 'none') return null;
                

                
                // If no secondary color is selected, show black version
                if (!secondaryColor) {
                    return design.variants.black;
                }
                
                // Map secondary color names to variant keys
                const colorMap = {
                    'Svart': 'black',
                    'Vit': 'white',
                    'Guld': 'gold',
                    'Orange': 'orange',
                    'Röd': 'red'
                };
                
                const colorKey = colorMap[secondaryColor.name];
                
                if (colorKey && design.variants[colorKey]) {
                    return design.variants[colorKey];
                }
                
                // Fallback to black if color not found
                return design.variants.black;
            }

            // Populate configured combinations
            function populateConfiguredCombinations() {
                const container = document.getElementById('configured-combination-options');
                if (!container) return;

                data.configuredCombinations.forEach(combo => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-3';
                    col.innerHTML = `
                        <div class="configured-combo-option" data-combo="${combo.id}">
                            <div class="combo-color-circle ${combo.id}"></div>
                            <span class="fw-semibold">${combo.name}</span>
                        </div>
                    `;
                    container.appendChild(col);
                });
            }

            // Populate all option containers
            function populateOptions() {
                // Populate caliber options
                const caliberContainer = document.getElementById('caliber-options');
                data.calibers.forEach(caliber => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="option-card caliber-option" data-caliber="${caliber}">
                            <span class="fw-semibold">${caliber}</span>
                        </div>
                    `;
                    caliberContainer.appendChild(col);
                });

                // Populate primary color options
                const primaryContainer = document.getElementById('primary-color-options');
                data.primaryColors.forEach(color => {
                    const col = document.createElement('div');
                    col.className = 'col-4 col-md-3 col-lg-2';
                    col.innerHTML = `
                        <div class="text-center">
                            <div class="color-option primary-color-option" 
                                 style="background-color: ${color.value}" 
                                 data-color="${color.value}" 
                                 data-name="${color.name}"></div>
                            <span class="mt-2 d-block">${color.name}</span>
                        </div>
                    `;
                    primaryContainer.appendChild(col);
                });

                // Populate secondary color options
                const secondaryContainer = document.getElementById('secondary-color-options');
                data.secondaryColors.forEach(color => {
                    const col = document.createElement('div');
                    col.className = 'col-4 col-md-3 col-lg-2';
                    col.innerHTML = `
                        <div class="text-center">
                            <div class="color-option secondary-color-option" 
                                 style="background-color: ${color.value}" 
                                 data-color="${color.value}" 
                                 data-name="${color.name}"></div>
                            <span class="mt-2 d-block">${color.name}</span>
                        </div>
                    `;
                    secondaryContainer.appendChild(col);
                });

                // Populate configured combinations
                populateConfiguredCombinations();

                // Populate design options
                const designContainer = document.getElementById('design-options');
                data.designs.forEach(design => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="option-card design-option" data-design="${design.id}">
                            ${design.optionImg ? 
                                `<img src="${design.optionImg}" alt="${design.name}" class="mb-2">` : 
                                `<div class="h-100 d-flex align-items-center justify-content-center"><i class="fas fa-times fa-3x text-muted"></i></div>`
                            }
                            <span class="fw-semibold">${design.name}</span>
                        </div>
                    `;
                    designContainer.appendChild(col);
                });
            }

            // Setup all event listeners
            function setupEventListeners() {
                // Step navigation
                setupStepNavigation();
                
                // Option selection
                setupOptionSelection();
                
                // Special request handling
                setupSpecialRequests();
                
                // Cart functionality
                setupCartFunctionality();
                
                // Initials input
                setupInitialsInput();
                
                // Configured combinations
                setupConfiguredCombinations();
            }

            // Setup step navigation
            function setupStepNavigation() {
                // Next buttons
                for (let i = 1; i <= 4; i++) {
                    const nextBtn = document.getElementById(`next-btn-${i}`);
                    if (nextBtn) {
                        nextBtn.addEventListener('click', () => goToStep(i + 1));
                    }
                }

                // Previous buttons
                for (let i = 2; i <= 5; i++) {
                    const prevBtn = document.getElementById(`prev-btn-${i}`);
                    if (prevBtn) {
                        prevBtn.addEventListener('click', () => goToPreviousStep(i));
                    }
                }

                // Finish button
                const finishBtn = document.getElementById('finish-btn');
                if (finishBtn) {
                    finishBtn.addEventListener('click', finishDesign);
                }
            }

            // Setup option selection
            function setupOptionSelection() {
                // Caliber selection
                document.querySelectorAll('.caliber-option').forEach(option => {
                    option.addEventListener('click', function() {
                        selectOption(this, 'caliber', this.dataset.caliber);
                        clearSpecialRequest(1);
                        // Don't update preview for caliber selection - it's just text
                    });
                });

                // Primary color selection
                document.querySelectorAll('.primary-color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // If this option is grayed out and a configured combo is selected, clear the combo first
                        if (this.style.opacity === '0.3' && app.selections.configuredCombo) {
                            clearConfiguredCombo();
                        }
                        
                        // Clear special request for primary color step
                        clearSpecialRequest(3);
                        
                        const colorValue = this.dataset.color;
                        const color = data.primaryColors.find(c => c.value === colorValue);
                        if (color) {
                            selectOption(this, 'primaryColor', color);
                        }
                    });
                });

                // Secondary color selection
                document.querySelectorAll('.secondary-color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // If this option is grayed out and a configured combo is selected, clear the combo first
                        if (this.style.opacity === '0.3' && app.selections.configuredCombo) {
                            clearConfiguredCombo();
                        }
                        
                        // Clear special request for secondary color step
                        clearSpecialRequest(4);
                        
                        const colorValue = this.dataset.color;
                        const color = data.secondaryColors.find(c => c.value === colorValue);
                        if (color) {
                            selectOption(this, 'secondaryColor', color);
                        }
                    });
                });

                // Configured combination selection
                document.querySelectorAll('.configured-combo-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const comboId = this.dataset.combo;
                        const combo = data.configuredCombinations.find(c => c.id === comboId);
                        if (combo) {
                            selectConfiguredCombo(this, combo);
                        }
                    });
                });

                // Design selection
                document.querySelectorAll('.design-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // Clear special request for design step
                        clearSpecialRequest(2);
                        
                        const designId = this.dataset.design;
                        const design = data.designs.find(d => d.id === designId);
                        if (design) {
                            selectOption(this, 'design', design);
                            // If a configured combo is selected, the design will show in that color
                            // If no combo is selected, it will show in the selected secondary color
                        }
                    });
                });
            }

            // Select a configured combination
            function selectConfiguredCombo(element, combo) {
                // Clear all previous color selections
                clearAllColorSelections();
                
                // Clear configured combo selections
                document.querySelectorAll('.configured-combo-option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Select the clicked combo
                element.classList.add('selected');
                app.selections.configuredCombo = combo;
                app.selections.primaryColor = combo.primaryColor;
                app.selections.secondaryColor = combo.secondaryColor;

                // Clear any special requests for color steps
                clearSpecialRequestForStep('primaryColor');
                clearSpecialRequestForStep('secondaryColor');

                // Gray out other options in the current step
                grayOutOtherOptions();

                // Enable next button for current step
                enableNextButton(app.currentStep);

                // Update cart and preview
                updateCart();
                updatePreview();
                
                // Update button states
                updateAllButtonStates();
                
                // If a design is already selected, it will now show in the combo's secondary color
                // This is handled in updatePreview() function
            }

            // Select an option
            function selectOption(element, type, value) {
                // Clear previous selections of the same type
                const container = element.closest('.row');
                container.querySelectorAll('.option-card, .color-option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // If selecting individual colors, clear configured combo
                if (type === 'primaryColor' || type === 'secondaryColor') {
                    if (app.selections.configuredCombo) {
                        app.selections.configuredCombo = null;
                        document.querySelectorAll('.configured-combo-option.selected').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        restoreOtherOptions();
                    }
                }
                
                // If selecting secondary color, update design preview
                if (type === 'secondaryColor' && app.selections.design && app.selections.design.id !== 'none') {
                    // Update preview immediately for smooth color change
                    updatePreview();
                }

                // Select the clicked option
                element.classList.add('selected');
                app.selections[type] = value;

                // Clear any special request for this step when selecting normal option
                clearSpecialRequestForStep(type);

                // Enable next button for current step
                enableNextButton(app.currentStep);

                // Update cart
                updateCart();
                
                // Only update preview for visual elements (not caliber)
                if (type !== 'caliber') {
                updatePreview();
                }
                
                // Update button states
                updateAllButtonStates();
                
                // Update visibility
                updateConfiguredCombinationsVisibility();
            }

            // Setup special requests
            function setupSpecialRequests() {
                for (let i = 1; i <= 5; i++) {
                    const textbox = document.getElementById(`special-request-${i}`);
                    if (textbox) {
                        textbox.addEventListener('focus', () => {
                            activateSpecialRequest(i);
                        });

                        textbox.addEventListener('input', () => {
                            handleSpecialRequestInput(i);
                        });
                        
                        // Add blur event to deactivate special request when leaving textbox
                        textbox.addEventListener('blur', () => {
                            setTimeout(() => {
                                clearSpecialRequest(i);
                            }, 100);
                        });
                    }
                }
                
                // Add keyboard shortcut (Escape key) to clear special requests
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        for (let i = 1; i <= 5; i++) {
                            const textbox = document.getElementById(`special-request-${i}`);
                            if (textbox && textbox === document.activeElement) {
                                clearSpecialRequest(i);
                                break;
                            }
                        }
                    }
                });
            }

            // Activate special request for a step
            function activateSpecialRequest(stepNum) {
                const step = document.getElementById(`step-${stepNum}`);
                const textbox = document.getElementById(`special-request-${stepNum}`);
                const status = document.getElementById(`special-status-${stepNum}`);
                const clearButton = document.getElementById(`clear-special-${stepNum}`);



                // Clear all selections for this step
                clearStepSelections(stepNum);

                // Set standard selections for special request (without UI selection)
                setStandardSelectionsForSpecialRequest(stepNum);

                // Disable the step (this grays out the options)
                step.classList.add('disabled');

                // Also clear configured combo selections when special request is active
                if (app.selections.configuredCombo) {
                    clearConfiguredCombo();
                }

                // Activate the textbox
                textbox.classList.add('active');

                // Show status and clear button
                status.classList.remove('d-none');
                status.classList.add('bg-success');
                if (clearButton) {
                    clearButton.classList.remove('d-none');
                }

                // Update cart
                updateCart();
                
                // Only update preview for visual elements (not caliber)
                if (stepNum !== 1) {
                updatePreview();
                }
                
                // Update button states (this will enable next button for special request)
                updateAllButtonStates();
                
                // Update configured combinations disabled state
                updateConfiguredCombinationsDisabledState();
            }

            // Handle special request input
            function handleSpecialRequestInput(stepNum) {
                const textbox = document.getElementById(`special-request-${stepNum}`);
                const text = textbox.value.trim();
                const clearButton = document.getElementById(`clear-special-${stepNum}`);



                if (text.length > 0) {
                    // Save special request
                    switch(stepNum) {
                        case 1: app.selections.caliberSpecial = text; break;
                        case 2: app.selections.designSpecial = text; break;
                        case 3: app.selections.primaryColorSpecial = text; break;
                        case 4: app.selections.secondaryColorSpecial = text; break;
                        case 5: app.selections.initialsSpecial = text; break;
                    }
                    
                    // Make sure the step is disabled when typing
                    const step = document.getElementById(`step-${stepNum}`);
                    if (step) {
                        step.classList.add('disabled');
                    }
                    
                    // Show clear button when there's text
                    if (clearButton) {
                        clearButton.classList.remove('d-none');
                    }
                    
                    // Also clear configured combo selections when special request is active
                    if (app.selections.configuredCombo) {
                        clearConfiguredCombo();
                    }
                    
                    // Force update preview to show "Specialförfrågan"
                    updatePreview();
                } else {
                    // Clear special request
                    clearSpecialRequest(stepNum);
                }

                updateCart();
                
                // Update button states
                updateAllButtonStates();
                
                // Update configured combinations disabled state
                updateConfiguredCombinationsDisabledState();
            }

            // Clear special request for a step
            function clearSpecialRequest(stepNum) {
                const step = document.getElementById(`step-${stepNum}`);
                const textbox = document.getElementById(`special-request-${stepNum}`);
                const status = document.getElementById(`special-status-${stepNum}`);
                const clearButton = document.getElementById(`clear-special-${stepNum}`);

                // Re-enable the step
                step.classList.remove('disabled');

                // Deactivate the textbox
                textbox.classList.remove('active');
                textbox.value = '';

                // Hide status and clear button
                status.classList.add('d-none');
                status.classList.remove('bg-success');
                if (clearButton) {
                    clearButton.classList.add('d-none');
                }

                // Clear special request from selections
                switch(stepNum) {
                    case 1: app.selections.caliberSpecial = ''; break;
                    case 2: app.selections.designSpecial = ''; break;
                    case 3: app.selections.primaryColorSpecial = ''; break;
                    case 4: app.selections.secondaryColorSpecial = ''; break;
                    case 5: app.selections.initialsSpecial = ''; break;
                }

                // Check if next button should be enabled
                enableNextButton(stepNum);

                updateCart();
                
                // Only update preview for visual elements (not caliber)
                if (stepNum !== 1) {
                updatePreview();
                }
                
                // Update button states
                updateAllButtonStates();
                
                // Update configured combinations disabled state
                updateConfiguredCombinationsDisabledState();
            }

            // Gray out other options when a combo is selected
            function grayOutOtherOptions() {
                // Gray out primary color options
                document.querySelectorAll('.primary-color-option').forEach(opt => {
                    opt.style.opacity = '0.3';
                    opt.style.filter = 'grayscale(100%)';
                    opt.style.pointerEvents = 'none';
                });
                
                // Gray out secondary color options
                document.querySelectorAll('.secondary-color-option').forEach(opt => {
                    opt.style.opacity = '0.3';
                    opt.style.filter = 'grayscale(100%)';
                    opt.style.pointerEvents = 'none';
                });
            }

            // Restore other options when combo is cleared
            function restoreOtherOptions() {
                // Restore primary color options
                document.querySelectorAll('.primary-color-option').forEach(opt => {
                    opt.style.opacity = '1';
                    opt.style.filter = 'none';
                    opt.style.pointerEvents = 'auto';
                });
                
                // Restore secondary color options
                document.querySelectorAll('.secondary-color-option').forEach(opt => {
                    opt.style.opacity = '1';
                    opt.style.filter = 'none';
                    opt.style.pointerEvents = 'auto';
                });
            }

            // Clear configured combo
            function clearConfiguredCombo() {
                // Clear configured combo selection
                app.selections.configuredCombo = null;
                
                // Clear visual selection
                document.querySelectorAll('.configured-combo-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Restore other options
                restoreOtherOptions();

                // Update cart and preview
                updateCart();
                updatePreview();
                
                // Update button states
                updateAllButtonStates();
                
                // Update visibility
                updateConfiguredCombinationsVisibility();
            }

            // Clear step selections
            function clearStepSelections(stepNum) {
                const step = document.getElementById(`step-${stepNum}`);
                

                
                switch(stepNum) {
                    case 1:
                        step.querySelectorAll('.caliber-option').forEach(opt => opt.classList.remove('selected'));
                        app.selections.caliber = null;
                        break;
                    case 2:
                        step.querySelectorAll('.design-option').forEach(opt => opt.classList.remove('selected'));
                        app.selections.design = null;
                        break;
                    case 3:
                        step.querySelectorAll('.primary-color-option').forEach(opt => opt.classList.remove('selected'));
                        app.selections.primaryColor = null;
                        // Also clear configured combo if it was selected
                        if (app.selections.configuredCombo) {
                            clearAllColorSelections();
                        }
                        // Restore other options
                        restoreOtherOptions();
                        break;
                    case 4:
                        step.querySelectorAll('.secondary-color-option').forEach(opt => opt.classList.remove('selected'));
                        app.selections.secondaryColor = null;
                        break;
                    case 5:
                        document.getElementById('initials-input').value = '';
                        app.selections.initials = '';
                        break;
                }
                
                // Clear configured combo selections for all steps
                document.querySelectorAll('.configured-combo-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });
                app.selections.configuredCombo = null;
                

            }

            // Update all button states
            function updateAllButtonStates() {
                for (let i = 1; i <= 4; i++) {
                    enableNextButton(i);
                }
            }

            // Enable next button for a step
            function enableNextButton(stepNum) {
                const nextBtn = document.getElementById(`next-btn-${stepNum}`);
                if (!nextBtn) return;

                let shouldEnable = false;

                switch(stepNum) {
                    case 1:
                        shouldEnable = app.selections.caliber !== null || app.selections.caliberSpecial !== '';
                        break;
                    case 2:
                        shouldEnable = app.selections.design !== null || app.selections.designSpecial !== '';
                        break;
                    case 3:
                        shouldEnable = app.selections.primaryColor !== null || app.selections.primaryColorSpecial !== '' || app.selections.configuredCombo !== null;
                        break;
                    case 4:
                        // If configured combo is selected, skip this step
                        if (app.selections.configuredCombo !== null) {
                            shouldEnable = true;
                        } else {
                            shouldEnable = app.selections.secondaryColor !== null || app.selections.secondaryColorSpecial !== '';
                        }
                        break;
                    case 5:
                        // Step 5 doesn't have a next button, it has the finish button
                        return;
                }

                // For special requests, we don't need visual selections - just the special request text
                const hasSpecialRequest = checkSpecialRequestActive(stepNum);
                if (hasSpecialRequest) {
                    shouldEnable = true;
                }

                // IMPORTANT: Only enable if there's an actual user selection, not default preview values
                // Check if the user has made a visual selection for this step
                const hasVisualSelection = checkVisualSelections(stepNum);
                if (!hasSpecialRequest && !hasVisualSelection) {
                    shouldEnable = false;
                }

                nextBtn.disabled = !shouldEnable;
                
                // If this is step 3 and a combo is selected, update the button text to indicate skipping
                if (stepNum === 3 && app.selections.configuredCombo !== null) {
                    nextBtn.innerHTML = 'Nästa (Hoppa över steg 4) <i class="fas fa-arrow-right ms-2"></i>';
                } else if (stepNum === 3) {
                    nextBtn.innerHTML = 'Nästa <i class="fas fa-arrow-right ms-2"></i>';
                }
            }

            // Go to a specific step
            function goToStep(stepNum) {
                if (stepNum < 1 || stepNum > app.totalSteps) return;

                // Handle configured combo logic
                if (stepNum === 4 && app.selections.configuredCombo !== null) {
                    // Skip step 4 (secondary color) if configured combo is selected
                    stepNum = 5;
                }

                // Hide current step
                const currentStep = document.getElementById(`step-${app.currentStep}`);
                currentStep.classList.remove('active');

                // Update current step
                app.currentStep = stepNum;

                // Show new step
                const newStep = document.getElementById(`step-${stepNum}`);
                newStep.classList.add('active');

                // Update step indicator
                updateStepIndicator();
                
                // Show/hide configured combinations based on current step
                updateConfiguredCombinationsVisibility();
                
                // Scroll to top of the page smoothly
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Go to previous step with smart navigation
            function goToPreviousStep(currentStepNum) {
                let previousStep = currentStepNum - 1;
                
                // Handle configured combo logic for back navigation
                if (currentStepNum === 5 && app.selections.configuredCombo !== null) {
                    // If we're at step 5 and a combo is selected, go back to step 3
                    previousStep = 3;
                }
                
                goToStep(previousStep);
            }

            // Update step indicator
            function updateStepIndicator() {
                const indicator = document.getElementById('current-step');
                if (indicator) {
                    // If configured combo is selected and we're on step 4, show step 5
                    let displayStep = app.currentStep;
                    if (app.currentStep === 4 && app.selections.configuredCombo !== null) {
                        displayStep = 5;
                    }
                    indicator.textContent = displayStep;
                }
            }

            // Setup cart functionality
            function setupCartFunctionality() {
                // Cart icon click
                const cartIcon = document.getElementById('cart-icon');
                if (cartIcon) {
                    cartIcon.addEventListener('click', openCartSidebar);
                }

                // Cart sidebar close
                const cartSidebarClose = document.getElementById('cart-sidebar-close');
                if (cartSidebarClose) {
                    cartSidebarClose.addEventListener('click', closeCartSidebar);
                }

                // Cart sidebar overlay click
                const cartSidebarOverlay = document.getElementById('cart-sidebar-overlay');
                if (cartSidebarOverlay) {
                    cartSidebarOverlay.addEventListener('click', closeCartSidebar);
                }

                // Continue shopping button
                const continueShoppingBtn = document.getElementById('continue-shopping');
                if (continueShoppingBtn) {
                    continueShoppingBtn.addEventListener('click', closeCartSidebar);
                }

                // Go to checkout button in sidebar
                const goToCheckoutSidebarBtn = document.getElementById('go-to-checkout-sidebar');
                if (goToCheckoutSidebarBtn) {
                    goToCheckoutSidebarBtn.addEventListener('click', () => {
                        window.location.href = '/checkout';
                    });
                }
            }

            // Open cart sidebar
            function openCartSidebar() {
                const cartSidebar = document.getElementById('cart-sidebar');
                const cartSidebarOverlay = document.getElementById('cart-sidebar-overlay');
                
                if (cartSidebar && cartSidebarOverlay) {
                    cartSidebar.classList.add('open');
                    cartSidebarOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            }

            // Close cart sidebar
            function closeCartSidebar() {
                const cartSidebar = document.getElementById('cart-sidebar');
                const cartSidebarOverlay = document.getElementById('cart-sidebar-overlay');
                
                if (cartSidebar && cartSidebarOverlay) {
                    cartSidebar.classList.remove('open');
                    cartSidebarOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }

            // Update cart
            function updateCart() {
                updateCartSidebar();
                updateCartBadge();
            }

            // Update cart sidebar
            function updateCartSidebar() {
                const cartSidebarItems = document.getElementById('cart-sidebar-items');
                const cartSidebarTotal = document.getElementById('cart-sidebar-total');
                const goToCheckoutSidebarBtn = document.getElementById('go-to-checkout-sidebar');

                if (!cartSidebarItems || !cartSidebarTotal || !goToCheckoutSidebarBtn) return;

                // Clear current items
                cartSidebarItems.innerHTML = '';

                let total = 0;

                // Display saved products
                if (app.savedProducts.length > 0) {
                    app.savedProducts.forEach((product, index) => {
                        addSavedProductToCartSidebar(product, index);
                        total += product.totalPrice;
                    });
                }

                // Show current selections if any
            // Removed "aktuella val" section

                cartSidebarTotal.textContent = `${total}kr`;

                // Enable/disable checkout button
                if (app.savedProducts.length > 0) {
                    goToCheckoutSidebarBtn.disabled = false;
                    goToCheckoutSidebarBtn.classList.remove('btn-secondary');
                    goToCheckoutSidebarBtn.classList.add('btn-custom');
                } else {
                    goToCheckoutSidebarBtn.disabled = true;
                    goToCheckoutSidebarBtn.classList.remove('btn-custom');
                    goToCheckoutSidebarBtn.classList.add('btn-secondary');
                }
            }

            // Update cart badge
            function updateCartBadge() {
                const cartBadge = document.getElementById('cart-badge');
                if (!cartBadge) return;

                const totalItems = app.savedProducts.length;
                if (totalItems > 0) {
                    cartBadge.textContent = totalItems;
                    cartBadge.classList.remove('d-none');
                } else {
                    cartBadge.classList.add('d-none');
                }
            }

            // Add saved product to cart sidebar
            function addSavedProductToCartSidebar(product, index) {
                const cartSidebarItems = document.getElementById('cart-sidebar-items');
                if (!cartSidebarItems) return;

                const productDiv = document.createElement('div');
                productDiv.className = 'saved-product mb-3 p-3 border border-success rounded';
                productDiv.style.background = 'rgba(16, 185, 129, 0.1)';

                let specsHtml = '';
                if (product.selections.caliber) {
                    specsHtml += `<div class="spec-item"><strong>Kaliber:</strong> ${product.selections.caliber}</div>`;
                } else if (product.selections.caliberSpecial) {
                    specsHtml += `<div class="spec-item"><strong>Kaliber:</strong> Specialförfrågan</div>`;
                }

                if (product.selections.primaryColor) {
                    specsHtml += `<div class="spec-item"><strong>Primär Färg:</strong> ${product.selections.primaryColor.name}</div>`;
                } else if (product.selections.primaryColorSpecial) {
                    specsHtml += `<div class="spec-item"><strong>Primär Färg:</strong> Specialförfrågan</div>`;
                }

                if (product.selections.secondaryColor) {
                    specsHtml += `<div class="spec-item"><strong>Sekundär Färg:</strong> ${product.selections.secondaryColor.name}</div>`;
                } else if (product.selections.secondaryColorSpecial) {
                    specsHtml += `<div class="spec-item"><strong>Sekundär Färg:</strong> Specialförfrågan</div>`;
                }

                if (product.selections.design) {
                    specsHtml += `<div class="spec-item"><strong>Design:</strong> ${product.selections.design.name}</div>`;
                } else if (product.selections.designSpecial) {
                    specsHtml += `<div class="spec-item"><strong>Design:</strong> Specialförfrågan</div>`;
                }

                if (product.selections.initials) {
                    specsHtml += `<div class="spec-item"><strong>Initialer:</strong> ${product.selections.initials}</div>`;
                } else if (product.selections.initialsSpecial) {
                    specsHtml += `<div class="spec-item"><strong>Initialer:</strong> Specialförfrågan</div>`;
                }

                productDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 text-success">
                            <i class="fas fa-check-circle me-2"></i>${product.type}
                        </h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeProduct(${index})" title="Ta bort">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="specs-container">
                        ${specsHtml}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">${product.timestamp}</small>
                        <span class="fw-bold text-success">${product.totalPrice}kr</span>
                    </div>
                `;

                cartSidebarItems.appendChild(productDiv);
            }

            // Removed "aktuella val" functions

            // Removed hasCurrentSelections function

            // Clear all color selections
            function clearAllColorSelections() {
                // Clear primary color selections
                document.querySelectorAll('.primary-color-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Clear secondary color selections
                document.querySelectorAll('.secondary-color-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Clear configured combo selections
                document.querySelectorAll('.configured-combo-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Clear app selections
                app.selections.primaryColor = null;
                app.selections.secondaryColor = null;
                app.selections.configuredCombo = null;
            }

            // Clear all current selections
            function clearAllSelections() {
                // Clear app selections
                app.selections = {
                    caliber: null,
                    primaryColor: null,
                    secondaryColor: null,
                    configuredCombo: null,
                    design: null,
                    initials: '',
                    caliberSpecial: '',
                    primaryColorSpecial: '',
                    secondaryColorSpecial: '',
                    designSpecial: '',
                    initialsSpecial: ''
                };

                // Clear all selected visual states
                document.querySelectorAll('.option-card.selected, .color-option.selected, .configured-combo-option.selected').forEach(element => {
                    element.classList.remove('selected');
                });

                // Clear all special request textboxes
                for (let i = 1; i <= 5; i++) {
                    const textbox = document.getElementById(`special-request-${i}`);
                    if (textbox) {
                        textbox.value = '';
                        textbox.classList.remove('active');
                    }
                }

                // Clear special request status badges
                for (let i = 1; i <= 5; i++) {
                    const status = document.getElementById(`special-status-${i}`);
                    if (status) {
                        status.classList.add('d-none');
                    }
                }

                // Re-enable all steps
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('disabled');
                });

                // Restore other options
                restoreOtherOptions();

                // Reset to default selections for preview
                setDefaultSelectionsSilent();

                // Update preview and cart
                updatePreview();
                updateCart();
                
                // Update button states
                updateAllButtonStates();
                
                // Update configured combinations disabled state
                updateConfiguredCombinationsDisabledState();
            }

            // Remove product from cart
            function removeProduct(index) {
                app.savedProducts.splice(index, 1);
                localStorage.setItem('nordkaliberProducts', JSON.stringify(app.savedProducts));
                updateCart();
                showNotification('Produkt borttagen från varukorg', 'info');
            }

            // Make removeProduct globally accessible
            window.removeProduct = removeProduct;
            
            // Make clearSpecialRequest globally accessible
            window.clearSpecialRequest = clearSpecialRequest;

            // Add item to cart sidebar
            function addCartSidebarItem(label, value) {
                const cartSidebarItems = document.getElementById('cart-sidebar-items');
                if (!cartSidebarItems) return;

                const item = document.createElement('div');
                item.className = 'cart-item';
                item.innerHTML = `
                    <span>${label}:</span>
                    <span class="fw-bold">${value}</span>
                `;
                cartSidebarItems.appendChild(item);
            }

            // Setup configured combinations
            function setupConfiguredCombinations() {
                const clearBtn = document.getElementById('clear-configured-combo');
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearConfiguredCombo);
                }
            }

            // Show configured combinations section
            function showConfiguredCombinations() {
                const container = document.getElementById('configured-combinations');
                if (container) {
                    container.style.display = 'block';
                }
            }

            // Hide configured combinations section
            function hideConfiguredCombinations() {
                const container = document.getElementById('configured-combinations');
                if (container) {
                    container.style.display = 'none';
                }
            }

            // Update configured combinations visibility based on current step
            function updateConfiguredCombinationsVisibility() {
                const container = document.getElementById('configured-combinations');
                if (!container) return;

                // Show at steps 3 and 4 (when user can see primary and secondary color options)
                if (app.currentStep === 3 || app.currentStep === 4) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }

            // Setup initials input
            function setupInitialsInput() {
                const initialsInput = document.getElementById('initials-input');
                if (initialsInput) {
                    initialsInput.addEventListener('input', function() {
                        app.selections.initials = this.value;
                        updateCart();
                        updatePreview();
                        
                        // Update button states
                        updateAllButtonStates();
                    });
                }
            }

            // Update preview
            function updatePreview() {
                const previewPlaceholder = document.getElementById('preview-placeholder');
                const previewBase = document.getElementById('preview-base');
                const previewLogo = document.getElementById('preview-logo');
                const previewButton = document.getElementById('preview-button');
                const previewDetails = document.getElementById('preview-details');

                if (!previewPlaceholder || !previewBase || !previewLogo || !previewButton || !previewDetails) {
                    return;
                }

                // Clear previous preview details
                previewDetails.innerHTML = '';

                let hasSelections = false;

                // Update preview images and details with fade-in animations
                if (app.selections.configuredCombo) {
                    // Show configured combo
                    fadeInImage(previewBase, app.selections.configuredCombo.primaryColor.img);
                    fadeInImage(previewButton, app.selections.configuredCombo.secondaryColor.img);
                    
                    // If a design is selected, show it in the combo's secondary color
                    if (app.selections.design && app.selections.design.id !== 'none') {
                        const designImage = getDesignImage(app.selections.design, app.selections.configuredCombo.secondaryColor);
                        if (designImage) {
                            if (app.selections.design.isSpecial && app.selections.design.id === 'M9') {
                                // For M9, show base + color
                                fadeInImage(previewLogo, app.selections.design.base);
                                fadeInImage(previewButton, designImage);
                            } else if (app.selections.design.isSpecial && app.selections.design.id === 'M10') {
                                // M10 only has one color
                                fadeInImage(previewLogo, designImage);
                            } else {
                                // Regular designs replace the logo
                                fadeInImage(previewLogo, designImage);
                            }
                        }
                    } else {
                        // No design selected, show the combo's secondary color logo
                    fadeInImage(previewLogo, app.selections.configuredCombo.secondaryColor.logo);
                    }
                    
                    hasSelections = true;
                    addPreviewDetail('Färdig Kombination', app.selections.configuredCombo.name);
                } else {
                    // Show individual color selections
                    if (app.selections.primaryColorSpecial) {
                        // Show standard gray box for special request
                        fadeInImage(previewBase, '../images/primarycolors/graybox.PNG');
                    hasSelections = true;
                    addPreviewDetail('Primär Färg', 'Specialförfrågan');
                    } else if (app.selections.primaryColor) {
                        fadeInImage(previewBase, app.selections.primaryColor.img);
                        hasSelections = true;
                        addPreviewDetail('Primär Färg', app.selections.primaryColor.name);
                    } else {
                        fadeOutImage(previewBase);
                    }

                    if (app.selections.secondaryColorSpecial) {
                        // Show standard black button/logo for special request
                        fadeInImage(previewButton, '../images/secondarycolors/blackbutton.PNG');
                        
                        // Only show logo if no design is selected
                        if (!app.selections.design || app.selections.design.id === 'none') {
                            fadeInImage(previewLogo, '../images/secondarycolors/blacklogo.PNG');
                        }
                        
                        hasSelections = true;
                        addPreviewDetail('Sekundär Färg', 'Specialförfrågan');
                    } else if (app.selections.secondaryColor) {
                        // Show button for secondary color (this will be visible)
                        fadeInImage(previewButton, app.selections.secondaryColor.img);
                        
                        // Only show logo if no design is selected
                        if (!app.selections.design || app.selections.design.id === 'none') {
                        fadeInImage(previewLogo, app.selections.secondaryColor.logo);
                        }
                        
                        hasSelections = true;
                        addPreviewDetail('Sekundär Färg', app.selections.secondaryColor.name);
                    } else {
                        fadeOutImage(previewButton);
                        fadeOutImage(previewLogo);
                    }
                }

                // Handle design display
                if (app.selections.designSpecial) {
                    hasSelections = true;
                    addPreviewDetail('Design', 'Specialförfrågan');
                    
                    // Show standard Motiv 8 for design special request
                    const standardDesign = data.designs.find(d => d.id === 'M8');
                    if (standardDesign) {
                        const designImage = getDesignImage(standardDesign, app.selections.secondaryColor);
                        if (designImage) {
                            fadeInImage(previewLogo, designImage);
                        }
                    }
                } else if (app.selections.design && app.selections.design.id !== 'none') {
                    hasSelections = true;
                    addPreviewDetail('Design', app.selections.design.name);
                    
                    // Show the design in the preview
                    const designImage = getDesignImage(app.selections.design, app.selections.secondaryColor);
                    
                    if (designImage) {
                        // For M9, we need to show both base and color
                        if (app.selections.design.isSpecial && app.selections.design.id === 'M9') {
                            fadeInImage(previewLogo, app.selections.design.base);
                            fadeInImage(previewButton, designImage);
                        } else if (app.selections.design.isSpecial && app.selections.design.id === 'M10') {
                            // M10 only has one color
                            fadeInImage(previewLogo, designImage);
                        } else {
                            // Regular designs replace the logo, but keep the button visible
                            fadeInImage(previewLogo, designImage);
                            // Don't fade out the button - keep it visible
                        }
                    }
                } else if (app.selections.design && app.selections.design.id === 'none') {
                    hasSelections = true;
                    addPreviewDetail('Design', 'Inget motiv');
                }

                if (app.selections.caliberSpecial) {
                    addPreviewDetail('Kaliber', 'Specialförfrågan');
                    hasSelections = true;
                } else if (app.selections.caliber) {
                    addPreviewDetail('Kaliber', app.selections.caliber);
                    hasSelections = true;
                }

                if (app.selections.initialsSpecial) {
                    addPreviewDetail('Initialer', 'Specialförfrågan');
                    hasSelections = true;
                } else if (app.selections.initials) {
                    addPreviewDetail('Initialer', app.selections.initials);
                    hasSelections = true;
                }

                // Show/hide placeholder with fade effect
                if (hasSelections) {
                    fadeOutElement(previewPlaceholder);
                } else {
                    fadeInElement(previewPlaceholder);
                }
            }

            // Add preview detail
            function addPreviewDetail(label, value) {
                const previewDetails = document.getElementById('preview-details');
                if (!previewDetails) return;

                const detail = document.createElement('div');
                detail.className = 'preview-detail fade-in-detail';
                detail.innerHTML = `
                    <span>${label}:</span>
                    <span class="fw-bold">${value}</span>
                `;
                previewDetails.appendChild(detail);
            }

            // Force show preview for testing
            function forceShowPreview() {
                const previewBase = document.getElementById('preview-base');
                const previewButton = document.getElementById('preview-button');
                const previewLogo = document.getElementById('preview-logo');
                
                if (previewBase) {
                    previewBase.src = '../images/primarycolors/graybox.PNG';
                    previewBase.style.display = 'block';
                    previewBase.style.opacity = '1';
                    previewBase.style.transition = 'none';
                }
                
                if (previewButton) {
                    previewButton.src = '../images/secondarycolors/blackbutton.PNG';
                    previewButton.style.display = 'block';
                    previewButton.style.opacity = '1';
                    previewButton.style.transition = 'none';
                }
                
                if (previewLogo) {
                    previewLogo.src = '../images/motiv/M8/M8svart.PNG';
                    previewLogo.style.display = 'block';
                    previewLogo.style.opacity = '1';
                    previewLogo.style.transition = 'none';
                }
            }

            // Immediate image loading function - no transitions
            function fadeInImage(imgElement, src) {
                if (!imgElement) return;
                
                // If this is the same image, don't change
                if (imgElement.src === src) {
                    return;
                }
                
                // Change image immediately without any transitions
                imgElement.src = src;
                imgElement.style.display = 'block';
                    imgElement.style.opacity = '1';
                imgElement.style.transition = 'none';
                
                // Also update the next layer if it exists
                const nextElement = document.getElementById(imgElement.id + '-next');
                if (nextElement) {
                    nextElement.style.display = 'none';
                    nextElement.style.opacity = '0';
                    nextElement.style.transition = 'none';
                }
            }

            // Hide image immediately - no transitions
            function fadeOutImage(imgElement) {
                if (!imgElement) return;
                
                // Also hide the corresponding next layer
                const nextElement = document.getElementById(imgElement.id + '-next');
                if (nextElement) {
                    nextElement.style.display = 'none';
                    nextElement.style.opacity = '0';
                }
                
                // Hide element immediately without transitions
                imgElement.style.transition = 'none';
                imgElement.style.opacity = '0';
                    imgElement.style.display = 'none';
            }

            // Show element immediately - no transitions
            function fadeInElement(element) {
                if (!element) return;
                
                element.style.transition = 'none';
                    element.style.opacity = '1';
                element.style.display = 'flex';
            }

            // Hide element immediately - no transitions
            function fadeOutElement(element) {
                if (!element) return;
                
                element.style.transition = 'none';
                element.style.opacity = '0';
                    element.style.display = 'none';
            }

            // Finish design
            function finishDesign() {
                // Create product object
                const product = {
                    id: Date.now(), // Unique ID for the product
                    type: 'Ammunitionsetui',
                    selections: { ...app.selections }, // Copy selections
                    totalPrice: calculateTotalPrice(),
                    timestamp: new Date().toLocaleString('sv-SE')
                };

                // Add to saved products
                app.savedProducts.push(product);

                // Save to localStorage
                localStorage.setItem('nordkaliberProducts', JSON.stringify(app.savedProducts));

                // Show success message
                showNotification('Ammunitionsetui tillagt i varukorg!', 'success');

                // Update cart
                updateCart();

                // Clear all selections and reset form
                clearAllSelections();

                // Automatically open cart sidebar
                openCartSidebar();

                // Reset to step 1
                goToStep(1);
            }

            // Calculate total price
            function calculateTotalPrice() {
                let total = app.basePrice;

                if (app.selections.initials) total += 100;
                if (app.selections.caliberSpecial) total += 200;
                if (app.selections.primaryColorSpecial) total += 200;
                if (app.selections.secondaryColorSpecial) total += 200;
                if (app.selections.designSpecial) total += 200;
                if (app.selections.initialsSpecial) total += 200;

                return total;
            }

            // Show notification
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} position-fixed`;
                notification.style.cssText = 'top: 2rem; right: 2rem; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Initialize the application
            init();
        });


    </script>
</body>
</html> 