<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designa Din Egen - Nordkaliber</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="48x48" href="../images/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../images/favicon-96x96.png">
    <link rel="shortcut icon" type="image/png" href="../images/favicon-32x32.png">
    <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../images/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lavender-grey': '#D1CFE0',
                        'forest-teal': '#1B4332',
                        'deep-blue': '#0F172A',
                        'mustard-gold': '#E6B17A',
                        'muted-beige': '#F0E6D3',
                        'sage-green': '#6B8E6B',
                        'hunter-brown': '#A0522D',
                        'dark-green': '#1B4D3E',
                        'light-green': '#90EE90',
                        'premium-black': '#1a1a1a',
                        'light-grey': '#E5E7EB',
                        'warm-grey': '#D1D5DB',
                        'cool-grey': '#9CA3AF',
                        'soft-grey': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        .step-active {
            background: linear-gradient(135deg, #E6B17A, #1B4332);
            color: white;
        }
        .step-completed {
            background: linear-gradient(135deg, #1B4332, #6B8E6B);
            color: white;
        }
        .option-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 177, 122, 0.4);
        }
        .option-btn.selected {
            border-color: #E6B17A;
            background: linear-gradient(135deg, #E6B17A, #1B4332);
            color: white;
        }
        .color-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #E6B17A;
            transform: scale(1.1);
        }
        .design-option {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .design-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 177, 122, 0.4);
        }
        .design-option.selected {
            border-color: #E6B17A;
            background: linear-gradient(135deg, #E6B17A, #1B4332);
            color: white;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
                 .price-highlight {
             background: linear-gradient(135deg, #E6B17A, #1B4332);
             color: white;
             padding: 1rem;
             border-radius: 10px;
             text-align: center;
             margin: 1rem 0;
         }
         .option-disabled {
             opacity: 0.4;
             pointer-events: none;
             filter: grayscale(100%);
         }
         .step-completed {
             background: linear-gradient(135deg, #1B4332, #6B8E6B);
             color: white;
         }
         .step-completed::after {
             content: '✓';
             position: absolute;
             top: -2px;
             right: -2px;
             background: #22c55e;
             color: white;
             border-radius: 50%;
             width: 20px;
             height: 20px;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 12px;
             font-weight: bold;
         }
         
                 .special-request-confirmed {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
            color: white !important;
            border: none !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.3) !important;
            transition: all 0.3s ease !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            opacity: 1 !important;
            position: relative !important;
            padding: 10px 16px !important;
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            overflow: hidden !important;
        }
        
        /* Option disabled styling for when special request is active */
        .option-disabled {
            opacity: 0.4 !important;
            pointer-events: none !important;
            filter: grayscale(0.8) !important;
        }
        
        /* Dropdown animation */
        .dropdown-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .dropdown-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.2s ease-out;
        }
         
         .special-request-confirmed::placeholder {
             color: #9ca3af !important;
        }
        
        /* Dark styling for maximum contrast and visibility */
        .bg-soft-grey {
            background-color: #374151 !important; /* Dark gray for main panels */
        }
        
        .bg-light-grey {
            background-color: #4B5563 !important; /* Medium dark gray for contrast */
        }
        
        .bg-warm-grey {
            background-color: #6B7280 !important; /* Lighter dark gray for inputs */
        }
        
        /* Ensure text is light and readable on dark backgrounds */
        .text-gray-800 {
            color: #F9FAFB !important; /* Light text for better contrast */
        }
        
        /* Make all text light on dark backgrounds */
        .bg-soft-grey, .bg-light-grey, .bg-warm-grey {
            color: #F9FAFB !important;
        }
        
        /* Ensure input text is visible */
        input, textarea, select {
            color: #1F2937 !important; /* Dark text on light input backgrounds */
            background-color: #F3F4F6 !important; /* Light background for inputs */
        }
        
        /* Mobile Single-Screen Layout - NO SCROLLING */
        @media (max-width: 768px) {
            /* Allow normal page scrolling on mobile */
            html, body {
                height: auto !important;
                overflow: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Main container fills entire viewport */
            .min-h-screen {
                height: 100vh !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            
            /* Header takes minimal space */
            header {
                flex: 0 0 auto !important;
                padding: 0.25rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Progress bar area */
            .max-w-4xl.mx-auto.py-8.px-4 {
                flex: 0 0 auto !important;
                padding: 0.25rem !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            
            /* Main content container */
            .container.mx-auto.px-4.py-8 {
                flex: 1 !important;
                padding: 0.25rem !important;
                margin: 0 !important;
                max-width: 100% !important;
                overflow: hidden !important;
            }
            
            /* Grid becomes vertical stack - no scrolling */
            .grid.lg\\:grid-cols-2 {
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
                gap: 0.25rem !important;
            }
            
            /* Step indicators ultra compact */
            .flex.items-center.justify-center.space-x-4 {
                gap: 0.25rem !important;
            }
            
            #step1, #step2, #step3, #step4, #step5 {
                width: 1.25rem !important;
                height: 1.25rem !important;
                font-size: 0.6rem !important;
            }
            
            /* Hide step text */
            .flex.items-center.space-x-4 .text-sm {
                display: none !important;
            }
            
            /* Preview section at top - use content height and allow page to scroll */
            .preview-container {
                display: flex !important;
                gap: 0.25rem !important;
                min-height: 0 !important;
                overflow: visible !important;
            }
            
            /* Preview box - 60% width */
            .preview-container > div:first-child {
                flex: 0 0 60% !important;
                min-width: 0 !important;
            }
            
            /* Price box - 40% width */
            .preview-container > div:last-child {
                flex: 0 0 40% !important;
                min-width: 0 !important;
            }
            
            /* Options section - 75% height */
            .grid.lg\\:grid-cols-2 > div:first-child {
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 0.25rem !important;
                margin: 0 !important;
                min-height: 0 !important;
            }
            
            /* Ultra compact preview styling */
            .preview-container .bg-soft-grey {
                padding: 0.125rem !important;
                margin: 0 !important;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .preview-container h3 {
                font-size: 0.6rem !important;
                margin-bottom: 0.125rem !important;
                flex: 0 0 auto !important;
            }
            
            .preview-container .bg-white.rounded-lg {
                flex: 1 !important;
                padding: 0.125rem !important;
                min-height: 0 !important;
            }
            
            .preview-container .mt-4.text-sm {
                margin-top: 0.125rem !important;
                font-size: 0.4rem !important;
                line-height: 1 !important;
                flex: 0 0 auto !important;
            }
            
            /* Ultra compact price section */
            .preview-container .space-y-3 {
                gap: 0.03125rem !important;
                font-size: 0.45rem !important;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .preview-container .space-y-3 > div {
                margin-bottom: 0.03125rem !important;
                padding: 0.015625rem 0 !important;
                flex: 0 0 auto !important;
            }
            
            .preview-container .text-xl.font-bold {
                font-size: 0.5rem !important;
            }
            
            /* Compact headings */
            .text-2xl.font-bold {
                font-size: 0.7rem !important;
                margin-bottom: 0.125rem !important;
            }
            
            /* Ultra compact step sections */
            .space-y-6 {
                gap: 0.25rem !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .space-y-6 > div {
                margin-bottom: 0.25rem !important;
                flex: 0 0 auto !important;
            }
            
            /* Step indicators and content */
            .step-indicator {
                padding: 0.125rem !important;
                font-size: 0.5rem !important;
                margin-bottom: 0.125rem !important;
            }
            
            .step-content {
                padding: 0.25rem !important;
                margin-top: 0.125rem !important;
            }
            
            /* Color options ultra compact */
            .color-option {
                width: 1.5rem !important;
                height: 1.5rem !important;
            }
            
            /* Grids ultra compact */
            .grid.grid-cols-2.gap-4,
            .grid.grid-cols-3.gap-4 {
                gap: 0.125rem !important;
            }
            
            /* Design images */
            .grid.grid-cols-2.gap-4 img {
                height: 2rem !important;
            }
            
            /* Buttons ultra compact */
            button {
                padding: 0.125rem 0.25rem !important;
                font-size: 0.5rem !important;
                line-height: 1 !important;
            }
            
            /* Textareas */
            textarea {
                padding: 0.125rem !important;
                font-size: 0.5rem !important;
                min-height: 1.5rem !important;
                line-height: 1 !important;
            }
            
            /* Dropdowns */
            .bg-warm-grey.border.border-cool-grey.rounded-lg {
                padding: 0.125rem !important;
            }
            
            /* Labels and text */
            label, span {
                font-size: 0.5rem !important;
                line-height: 1 !important;
            }
            
            /* Compact spacing everywhere */
            .space-x-2, .space-x-3, .space-x-4 {
                gap: 0.125rem !important;
            }
            
            .space-y-2, .space-y-3, .space-y-4 {
                gap: 0.125rem !important;
            }
            
            /* Remove margins and padding */
            .mb-2, .mb-3, .mb-4, .mb-6 {
                margin-bottom: 0.125rem !important;
            }
            
            .mt-2, .mt-3, .mt-4, .mt-6 {
                margin-top: 0.125rem !important;
            }
            
            .p-3, .p-4, .p-6 {
                padding: 0.125rem !important;
            }
            
            /* Step indicators */
            .step-indicator {
                padding: 0.25rem !important;
                font-size: 0.75rem !important;
            }
            
            /* Preview panel optimizations */
            .bg-soft-grey.rounded-xl.p-6 {
                padding: 0.75rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Preview container height reduction */
            .preview-stack {
                height: 10rem !important;
            }
            
            .bg-white.rounded-lg.p-4.h-64 {
                height: 10rem !important;
                padding: 0.5rem !important;
            }
            
            /* Compact special request dropdowns */
            .bg-mustard-gold.text-black.rounded-lg.font-semibold {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
            }
            
            .bg-warm-grey.border.border-cool-grey.rounded-lg.p-4 {
                padding: 0.5rem !important;
            }
            
            .bg-blue-100.border.border-blue-300.rounded-lg.p-3 {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Compact buttons in mobile */
            .bg-gradient-to-r.from-mustard-gold.to-dark-green {
                padding: 0.5rem 1rem !important;
                font-size: 0.8rem !important;
            }
            
            .flex.space-x-4 {
                gap: 0.5rem !important;
            }
            
            .flex.space-x-2 {
                gap: 0.375rem !important;
            }
            
            /* Price section compact */
            .text-3xl.font-bold {
                font-size: 1.5rem !important;
            }
            
            /* Compact option buttons */
            .option-btn {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Design options grid */
            .grid.grid-cols-2.gap-4 {
                gap: 0.5rem !important;
            }
            
            /* Step content margins */
            .fade-in {
                margin-bottom: 0.5rem !important;
            }
            
            /* Compact progress indicators */
            .flex.items-center.justify-between.mb-8 {
                margin-bottom: 1rem !important;
            }
            
            /* Optimize preview details */
            .mt-4.text-sm.text-gray-400 {
                margin-top: 0.5rem !important;
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
            }
            
            .mt-4.text-sm.text-gray-400 p {
                margin-bottom: 0.125rem !important;
            }
            
            /* Make preview sticky and compact */
            .preview-container {
                position: sticky !important;
                top: 0.5rem !important;
                height: fit-content !important;
                max-height: 50vh !important;
                overflow-y: auto !important;
            }
            
            /* Force single column layout on mobile */
            .grid.lg\\:grid-cols-2 {
                display: flex !important;
                flex-direction: column-reverse !important;
            }
            
            /* Ensure preview stays at top on mobile */
            .preview-container {
                order: -1 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 30vh !important;
                z-index: 50 !important;
                background: rgba(17, 24, 39, 0.98) !important;
                backdrop-filter: blur(15px) !important;
                border-bottom: 1px solid rgba(251, 191, 36, 0.3) !important;
            }
            
            /* Add top margin to main content to account for fixed preview */
            .grid.lg\\:grid-cols-2 > div:first-child {
                margin-top: 32vh !important;
                padding-top: 1rem !important;
            }
            
            /* Optimize preview content for fixed positioning */
            .preview-container .space-y-6 {
                height: 100% !important;
                display: flex !important;
                gap: 0.5rem !important;
            }
            
            .preview-container > div {
                flex: 1 !important;
                min-height: 0 !important;
            }
            
            /* Mobile: Combine preview and price in one container */
            .preview-container {
                display: flex !important;
                flex-direction: row !important;
                gap: 0.5rem !important;
                padding: 0.5rem !important;
            }
            
            /* Product preview takes left side */
            .preview-container > div:first-child {
                flex: 1.2 !important;
                min-width: 0 !important;
            }
            
            /* Price breakdown takes right side */
            .preview-container > div:last-child {
                flex: 0.8 !important;
                min-width: 0 !important;
            }
            
            /* Compact preview box */
            .preview-container .bg-soft-grey {
                padding: 0.5rem !important;
                margin: 0 !important;
            }
            
            .preview-container .text-xl.font-bold {
                font-size: 0.9rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            .preview-container .bg-white.rounded-lg {
                height: 8rem !important;
                padding: 0.25rem !important;
            }
            
            /* Compact price section */
            .preview-container .space-y-3 {
                gap: 0.125rem !important;
                font-size: 0.7rem !important;
            }
            
            .preview-container .space-y-3 > div {
                margin-bottom: 0.125rem !important;
                padding: 0.125rem 0 !important;
            }
            
            /* Compact details section */
            .preview-container .mt-4.text-sm {
                margin-top: 0.25rem !important;
                font-size: 0.6rem !important;
                line-height: 1.1 !important;
            }
            
            .preview-container .mt-4.text-sm p {
                margin-bottom: 0.0625rem !important;
            }
            
            /* Total price styling */
            .preview-container .text-xl.font-bold:last-child {
                font-size: 0.8rem !important;
            }
            /* Reduce header padding */
            header {
                padding: 0.5rem 1rem !important;
            }
            
            /* Compact progress steps */
            .max-w-4xl.mx-auto.py-8.px-4 {
                padding: 0.5rem !important;
            }
            
            /* Smaller step indicators on mobile */
            #step1, #step2, #step3, #step4, #step5 {
                width: 1.75rem !important;
                height: 1.75rem !important;
                font-size: 0.7rem !important;
            }
            
            /* Hide step text on very small screens */
            @media (max-width: 480px) {
                .flex.items-center.space-x-4 .text-sm {
                    display: none !important;
                }
            }
            
            /* Reduce main content padding */
            .max-w-6xl.mx-auto.px-4.pb-8 {
                padding: 0.25rem !important;
                padding-bottom: 1rem !important;
            }
            
            /* Compact configuration panel */
            .bg-soft-grey.rounded-xl.p-6.shadow-2xl {
                padding: 0.75rem !important;
            }
            
            /* Smaller headings on mobile */
            .text-2xl.font-bold.mb-6 {
                font-size: 1.125rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Compact button grid */
            .grid.grid-cols-2.gap-4.mb-6 {
                gap: 0.375rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Smaller buttons */
            .option-btn {
                padding: 0.5rem !important;
                font-size: 0.8rem !important;
                min-height: auto !important;
            }
            
            /* Compact color options */
            .color-option {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            /* Reduce textarea rows */
            textarea {
                rows: 2 !important;
            }
            
            /* Compact preview panel */
            .space-y-6 > div {
                margin-bottom: 0.75rem !important;
            }
            
            .space-y-6 > div:last-child {
                margin-bottom: 0 !important;
            }
            
            /* Smaller preview image container */
            .bg-light-grey.rounded-lg.p-4.h-64 {
                height: 6rem !important;
                padding: 0.375rem !important;
            }
            
            /* Compact price breakdown */
            .space-y-3 > div {
                margin-bottom: 0.375rem !important;
            }
            
            /* Smaller text in preview details */
            .mt-4.text-sm.text-gray-400 p {
                font-size: 0.7rem !important;
                margin-bottom: 0.125rem !important;
            }
            
            /* Compact special requests */
            .mt-3.pt-3 {
                margin-top: 0.375rem !important;
                padding-top: 0.375rem !important;
            }
            
            /* Reduce margins between sections */
            .mb-6 {
                margin-bottom: 0.75rem !important;
            }
            
            /* Compact step navigation buttons */
            .flex.space-x-4 button {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Smaller icons */
            .fas {
                font-size: 0.8rem !important;
            }
            
            /* Compact input fields */
            input, textarea, select {
                padding: 0.375rem !important;
            }
            
            /* Reduce spacing in price breakdown */
            .text-xl.font-bold {
                font-size: 1rem !important;
            }
            
            /* Compact labels */
            .block.text-sm.font-medium.mb-2 {
                font-size: 0.75rem !important;
                margin-bottom: 0.375rem !important;
            }
            
            /* Smaller preview icons */
            .fas.fa-box.text-4xl {
                font-size: 2rem !important;
            }
            
            /* Compact preview text */
            .text-gray-400.text-center p {
                font-size: 0.75rem !important;
            }
            
            /* Reduce grid gap for color options */
            .grid.grid-cols-2.gap-6 {
                gap: 0.75rem !important;
            }
            
            /* Compact preview details container */
            .mt-4.text-sm.text-gray-400 {
                margin-top: 0.5rem !important;
                font-size: 0.7rem !important;
            }
        }
        /* Layered preview */
        /* Mobile override: ensure options section is positioned correctly under preview */
        @media (max-width: 768px) {
            /* Use normal column flow (no reverse) and stretch children */
            .grid.lg\:grid-cols-2 {
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
            }

            /* Neutralize any legacy fixed/sticky preview behavior */
            .preview-container {
                position: static !important;
                order: -1 !important; /* preview block first on mobile */
                top: auto !important;
                left: auto !important;
                right: auto !important;
                height: auto !important;
                max-height: none !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border: 0 !important;
                padding: 0.25rem !important;
            }

            /* Ensure the options panel starts immediately after preview */
            .grid.lg\:grid-cols-2 > div:first-child {
                margin-top: 0 !important;
                padding-top: 0.25rem !important;
            }

            /* FIX: Make sure preview image area has a visible height on mobile */
            .preview-stack {
                height: 7.5rem !important; /* ~120px, enough to see the product clearly */
            }

            /* Its immediate container should not collapse the height */
            .preview-container .bg-white.rounded-lg {
                min-height: 7.5rem !important;
                padding: 0.25rem !important; /* small but not zero to avoid crowding */
            }
        }

        .preview-stack { position: relative; height: 16rem; }
        .preview-layer { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; opacity: 0; transition: opacity 750ms ease-in-out; pointer-events: none; will-change: opacity; }
        .preview-layer.show { opacity: 1; }
        .layer-base { z-index: 1; }
        .layer-logo { z-index: 2; }
        .layer-button { z-index: 3; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-hunter-brown to-dark-green py-4 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
                            <a href="/" class="text-2xl font-extrabold text-white hover:text-mustard-gold transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>NORDKALIBER
            </a>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button onclick="toggleCart()" class="p-3 hover:bg-mustard-gold hover:bg-opacity-20 rounded-full transition-all duration-300 cursor-pointer">
                        <i class="fas fa-shopping-cart text-3xl text-white"></i>
                        <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-sm rounded-full h-7 w-7 flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto py-8 px-4">
        <div class="flex justify-between items-center mb-8">
                         <div class="flex items-center space-x-4">
                 <div id="step1" class="step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative">1</div>
                 <div class="text-sm">Välj Kaliber</div>
             </div>
             <div class="flex-1 h-1 bg-gray-600 mx-4"></div>
             <div class="flex items-center space-x-4">
                 <div id="step2" class="w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative">2</div>
                 <div class="text-sm">Primär Färg</div>
             </div>
             <div class="flex-1 h-1 bg-gray-600 mx-4"></div>
             <div class="flex items-center space-x-4">
                 <div id="step3" class="w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative">3</div>
                 <div class="text-sm">Sekundär Färg</div>
             </div>
             <div class="flex-1 h-1 bg-gray-600 mx-4"></div>
             <div class="flex items-center space-x-4">
                 <div id="step4" class="w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative">4</div>
                 <div class="text-sm">Design</div>
             </div>
             <div class="flex-1 h-1 bg-gray-600 mx-4"></div>
             <div class="flex items-center space-x-4">
                 <div id="step5" class="w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative">5</div>
                 <div class="text-sm">Initialer (Valfritt)</div>
             </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 pb-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Configuration Panel -->
            <div class="bg-soft-grey rounded-xl p-6 shadow-2xl">
                <!-- Step 1: Caliber Selection -->
                <div id="step1Content" class="fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-mustard-gold">
                        <i class="fas fa-bullseye mr-3"></i>Steg 1: Välj Din Kaliber
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="308">
                            .308 Winchester
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="223">
                            .223 Remington
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="9.3x62">
                            9.3x62 Mauser
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="7x57">
                            7x57 Mauser
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="340">
                            .340 Weatherby Magnum
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="8x57">
                            8x57 Mauser
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="30-06">
                            .30-06 Springfield
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="300">
                            .300 Winchester Magnum
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="6.5x55">
                            6.5x55 Swedish Mauser
                        </button>
                        <button class="option-btn bg-light-grey text-gray-800 p-4 rounded-lg font-semibold" data-caliber="12g">
                            12 Gauge (Hagel)
                        </button>
                    </div>
                    <div class="mb-6">
                        <!-- Special Request Button -->
                        <button id="caliberSpecialBtn" class="w-full p-3 bg-mustard-gold text-black rounded-lg font-semibold hover:bg-yellow-500 transition-all duration-300 flex items-center justify-between">
                            <span>Specialförfrågan? (t.ex. .308 Winchester) +200kr</span>
                            <i id="caliberSpecialIcon" class="fas fa-chevron-down transition-transform duration-300"></i>
                        </button>
                        
                        <!-- Special Request Dropdown (Hidden by default) -->
                        <div id="caliberSpecialDropdown" class="hidden mt-2">
                            <div class="bg-warm-grey border border-cool-grey rounded-lg p-4">
                                <label class="block text-sm font-medium mb-2">Beskriv din specialförfrågan:</label>
                                <textarea id="caliberSpecial" class="w-full p-3 bg-white border border-cool-grey rounded-lg text-black" rows="2" placeholder="Beskriv din specialförfrågan här..."></textarea>
                                <div class="flex space-x-2 mt-3">
                                    <button id="caliberSpecialConfirm" class="bg-mustard-gold text-black px-4 py-2 rounded font-semibold hover:bg-yellow-500 transition-all duration-300">
                                        <i class="fas fa-check mr-1"></i>Bekräfta
                                    </button>
                                    <button id="caliberSpecialCancel" class="bg-gray-500 text-white px-4 py-2 rounded font-semibold hover:bg-gray-400 transition-all duration-300">
                                        <i class="fas fa-times mr-1"></i>Avbryt
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confirmed Special Request Display -->
                        <div id="caliberSpecialConfirmed" class="hidden mt-2">
                            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                                        <span class="text-sm font-medium text-blue-800">Specialförfrågan bekräftad:</span>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="caliberSpecialEdit" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                            Redigera
                                        </button>
                                        <button id="caliberSpecialUndo" class="text-red-600 hover:text-red-800 text-sm underline">
                                            Ångra
                                        </button>
                                    </div>
                                </div>
                                <p id="caliberSpecialText" class="mt-1 text-blue-700 font-medium"></p>
                            </div>
                        </div>
                    </div>
                                            <button id="nextStep1" class="w-full bg-gradient-to-r from-mustard-gold to-dark-green text-white py-3 px-6 rounded-lg font-semibold hover:from-dark-green hover:to-mustard-gold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Nästa Steg
                        </button>
                        </div>

                <!-- Step 2: Primary Color -->
                <div id="step2Content" class="hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-mustard-gold">
                        <i class="fas fa-palette mr-3"></i>Steg 2: Välj Primär Färg
                    </h2>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="text-center">
                            <div class="color-option bg-black mx-auto mb-2" data-color="black"></div>
                            <span class="text-sm">Svart</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-white mx-auto mb-2" data-color="white"></div>
                            <span class="text-sm">Vit</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-gray-500 mx-auto mb-2" data-color="gray"></div>
                            <span class="text-sm">Grå</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-green-600 mx-auto mb-2" data-color="green"></div>
                            <span class="text-sm">Grön</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-red-600 mx-auto mb-2" data-color="red"></div>
                            <span class="text-sm">Röd</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-green-800 mx-auto mb-2" data-color="darkgreen"></div>
                            <span class="text-sm">Mörkgrön</span>
                        </div>
                    </div>
                    <div class="mb-6">
                        <!-- Special Request Button -->
                        <button id="primarySpecialBtn" class="w-full p-3 bg-mustard-gold text-black rounded-lg font-semibold hover:bg-yellow-500 transition-all duration-300 flex items-center justify-between">
                            <span>Specialförfrågan? (t.ex. Lila färg) +200kr</span>
                            <i id="primarySpecialIcon" class="fas fa-chevron-down transition-transform duration-300"></i>
                        </button>
                        
                        <!-- Special Request Dropdown (Hidden by default) -->
                        <div id="primarySpecialDropdown" class="hidden mt-2">
                            <div class="bg-warm-grey border border-cool-grey rounded-lg p-4">
                                <label class="block text-sm font-medium mb-2">Beskriv din specialförfrågan:</label>
                                <textarea id="primarySpecial" class="w-full p-3 bg-white border border-cool-grey rounded-lg text-black" rows="2" placeholder="Beskriv din specialförfrågan här..."></textarea>
                                <div class="flex space-x-2 mt-3">
                                    <button id="primarySpecialConfirm" class="bg-mustard-gold text-black px-4 py-2 rounded font-semibold hover:bg-yellow-500 transition-all duration-300">
                                        <i class="fas fa-check mr-1"></i>Bekräfta
                                    </button>
                                    <button id="primarySpecialCancel" class="bg-gray-500 text-white px-4 py-2 rounded font-semibold hover:bg-gray-400 transition-all duration-300">
                                        <i class="fas fa-times mr-1"></i>Avbryt
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confirmed Special Request Display -->
                        <div id="primarySpecialConfirmed" class="hidden mt-2">
                            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                                        <span class="text-sm font-medium text-blue-800">Specialförfrågan bekräftad:</span>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="primarySpecialEdit" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                            Redigera
                                        </button>
                                        <button id="primarySpecialUndo" class="text-red-600 hover:text-red-800 text-sm underline">
                                            Ångra
                                        </button>
                                    </div>
                                </div>
                                <p id="primarySpecialText" class="mt-1 text-blue-700 font-medium"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="prevStep2" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-500 transition-all duration-300">
                            Föregående
                        </button>
                        <button id="nextStep2" class="flex-1 bg-gradient-to-r from-mustard-gold to-dark-green text-white py-3 px-6 rounded-lg font-semibold hover:from-dark-green hover:to-mustard-gold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Nästa Steg
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Secondary Color -->
                <div id="step3Content" class="hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-mustard-gold">
                        <i class="fas fa-paint-brush mr-3"></i>Steg 3: Välj Sekundär Färg
                    </h2>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="text-center">
                            <div class="color-option bg-yellow-500 mx-auto mb-2" data-color="gold"></div>
                            <span class="text-sm">Guld</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-red-600 mx-auto mb-2" data-color="red"></div>
                            <span class="text-sm">Röd</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-orange-500 mx-auto mb-2" data-color="orange"></div>
                            <span class="text-sm">Orange</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-black mx-auto mb-2" data-color="black"></div>
                            <span class="text-sm">Svart</span>
                        </div>
                        <div class="text-center">
                            <div class="color-option bg-gray-200 mx-auto mb-2" data-color="white"></div>
                            <span class="text-sm">Vit</span>
                        </div>
                    </div>
                    <div class="mb-6">
                        <!-- Special Request Button -->
                        <button id="secondarySpecialBtn" class="w-full p-3 bg-mustard-gold text-black rounded-lg font-semibold hover:bg-yellow-500 transition-all duration-300 flex items-center justify-between">
                            <span>Specialförfrågan? (t.ex. Lila färg) +200kr</span>
                            <i id="secondarySpecialIcon" class="fas fa-chevron-down transition-transform duration-300"></i>
                        </button>
                        
                        <!-- Special Request Dropdown (Hidden by default) -->
                        <div id="secondarySpecialDropdown" class="hidden mt-2">
                            <div class="bg-warm-grey border border-cool-grey rounded-lg p-4">
                                <label class="block text-sm font-medium mb-2">Beskriv din specialförfrågan:</label>
                                <textarea id="secondarySpecial" class="w-full p-3 bg-white border border-cool-grey rounded-lg text-black" rows="2" placeholder="Beskriv din specialförfrågan här..."></textarea>
                                <div class="flex space-x-2 mt-3">
                                    <button id="secondarySpecialConfirm" class="bg-mustard-gold text-black px-4 py-2 rounded font-semibold hover:bg-yellow-500 transition-all duration-300">
                                        <i class="fas fa-check mr-1"></i>Bekräfta
                                    </button>
                                    <button id="secondarySpecialCancel" class="bg-gray-500 text-white px-4 py-2 rounded font-semibold hover:bg-gray-400 transition-all duration-300">
                                        <i class="fas fa-times mr-1"></i>Avbryt
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confirmed Special Request Display -->
                        <div id="secondarySpecialConfirmed" class="hidden mt-2">
                            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-blue-600 mr-2"></i>
                                        <span class="text-sm font-medium text-blue-800">Specialförfrågan bekräftad:</span>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="secondarySpecialEdit" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                            Redigera
                                        </button>
                                        <button id="secondarySpecialUndo" class="text-red-600 hover:text-red-800 text-sm underline">
                                            Ångra
                                        </button>
                                    </div>
                                </div>
                                <p id="secondarySpecialText" class="mt-1 text-blue-700 font-medium"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="prevStep3" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-500 transition-all duration-300">
                            Föregående
                        </button>
                        <button id="nextStep3" class="flex-1 bg-gradient-to-r from-mustard-gold to-dark-green text-white py-3 px-6 rounded-semibold hover:from-dark-green hover:to-mustard-gold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Nästa Steg
                        </button>
                    </div>
                </div>

                <!-- Step 4: Design Selection -->
                <div id="step4Content" class="hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-mustard-gold">
                        <i class="fas fa-palette mr-3"></i>Steg 4: Välj Design
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="alg_logo">
                                <img src="/images/alg_logo.svg" alt="Design 1" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 1</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="alg_design">
                                <img src="/images/alg_design.svg" alt="Design 2" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 2</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="alg_jagare">
                                <img src="/images/alg_jagare.svg" alt="Design 3" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 3</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="alg_majestic">
                                <img src="/images/alg_majestic.svg" alt="Design 4" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 4</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="fagel_design">
                                <img src="/images/fagel_design.png" alt="Design 5" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 5</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="jagare_hund">
                                <img src="/images/jagare_hund.svg" alt="Design 6" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 6</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="algfavvo">
                                <img src="/images/algfavvo.svg" alt="Design 7" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                                <span class="text-sm font-semibold">Design 7</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="your_text">
                                <img src="/images/your_text_design.png" alt="Design 8" class="w-full h-24 object-contain mb-2" onerror="console.error('[Design] Thumb failed:', this.src)">
                        <span class="text-sm font-semibold">Design 8</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="design-option bg-light-grey rounded-lg p-4 cursor-pointer hover:bg-warm-grey transition-all duration-300" data-design="none">
                                <div class="w-full h-24 bg-gray-300 rounded flex items-center justify-center mb-2">
                                    <i class="fas fa-times text-4xl text-gray-500"></i>
                                </div>
                                <span class="text-sm font-semibold">Ingen Design</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Specialförfrågan (t.ex. Annan design) +200kr</label>
                        <textarea id="designSpecial" class="w-full p-3 bg-warm-grey border border-cool-grey rounded-lg text-gray-800" rows="2" placeholder="Beskriv din specialförfrågan här..."></textarea>
                    </div>
                    <div class="flex space-x-4">
                        <button id="prevStep4" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-500 transition-all duration-300">
                            Föregående
                        </button>
                        <button id="nextStep4" class="flex-1 bg-gradient-to-r from-mustard-gold to-dark-green text-white py-3 px-6 rounded-lg font-semibold hover:from-dark-green hover:to-mustard-gold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Nästa Steg
                        </button>
                    </div>
                </div>

                <!-- Step 5: Initials (Optional) -->
                <div id="step5Content" class="hidden fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-mustard-gold">
                        <i class="fas fa-signature mr-3"></i>Steg 5: Initialer (Valfritt)
                    </h2>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Dina Initialer +100kr</label>
                        <input type="text" id="initials" class="w-full p-3 bg-warm-grey border border-cool-grey rounded-lg text-gray-800" placeholder="t.ex. J.S." maxlength="5">
                        <p class="text-xs text-gray-400 mt-1">Max 5 tecken</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Specialförfrågan (t.ex. Annan font) +200kr</label>
                        <textarea id="initialsSpecial" class="w-full p-3 bg-warm-grey border border-cool-grey rounded-lg text-gray-800" rows="2" placeholder="Beskriv din specialförfrågan här..."></textarea>
                    </div>
                    <div class="flex space-x-4">
                        <button id="prevStep5" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-500 transition-all duration-300">
                            Föregående
                        </button>
                        <button id="addToCart" class="flex-1 bg-gradient-to-r from-mustard-gold to-dark-green text-white py-3 px-6 rounded-lg font-semibold hover:from-dark-green hover:to-mustard-gold transition-all duration-300">
                            Lägg till i Kundvagn
                        </button>
                    </div>
                </div>
                        </div>

            <!-- Preview and Price Panel -->
            <div class="space-y-6 preview-container">
                <!-- Product Preview -->
                <div class="bg-soft-grey rounded-xl p-6 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4 text-mustard-gold">
                        <i class="fas fa-eye mr-2"></i>Produktförhandsvisning
                    </h3>
                    <div class="bg-white rounded-lg p-4 h-64 preview-stack flex items-center justify-center">
                        <img id="baseBoxA" class="preview-layer layer-base" alt="Baslåda">
                        <img id="baseBoxB" class="preview-layer layer-base" alt="Baslåda">
                        <img id="logoOverlayA" class="preview-layer layer-logo" alt="Logo overlay">
                        <img id="logoOverlayB" class="preview-layer layer-logo" alt="Logo overlay">
                        <img id="buttonOverlayA" class="preview-layer layer-button" alt="Knapp overlay">
                        <img id="buttonOverlayB" class="preview-layer layer-button" alt="Knapp overlay">
                        <div id="placeholderText" class="text-gray-400 text-center absolute">
                            <i class="fas fa-box text-4xl mb-2"></i>
                            <p>Välj alternativ för att se förhandsvisning</p>
                        </div>
                    </div>
                                         <div class="mt-4 text-sm text-gray-400">
                         <p><strong>Vald Kaliber:</strong> <span id="selectedCaliber">-</span></p>
                         <p><strong>Primär Färg:</strong> <span id="selectedPrimary">-</span></p>
                         <p><strong>Sekundär Färg:</strong> <span id="selectedSecondary">-</span></p>
                         <p><strong>Design:</strong> <span id="selectedDesign">-</span></p>
                         <p><strong>Initialer:</strong> <span id="selectedInitials">-</span></p>
                         <div id="specialRequests" class="mt-3 pt-3 border-t border-gray-600 hidden">
                             <p class="text-yellow-400 font-semibold mb-2">Specialförfrågningar:</p>
                             <div id="specialRequestsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Breakdown -->
                <div class="bg-soft-grey rounded-xl p-6 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4 text-mustard-gold">
                        <i class="fas fa-calculator mr-2"></i>Prisuppställning
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Standard låda:</span>
                            <span>850kr</span>
                        </div>
                        <div id="caliberSpecialPrice" class="flex justify-between text-green-400 hidden">
                            <span>Kaliber specialförfrågan:</span>
                            <span>+200kr</span>
                        </div>
                        <div id="primarySpecialPrice" class="flex justify-between text-green-400 hidden">
                            <span>Primär färg specialförfrågan:</span>
                            <span>+200kr</span>
                        </div>
                        <div id="secondarySpecialPrice" class="flex justify-between text-green-400 hidden">
                            <span>Sekundär färg specialförfrågan:</span>
                            <span>+200kr</span>
                        </div>
                        <div id="designSpecialPrice" class="flex justify-between text-green-400 hidden">
                            <span>Design specialförfrågan:</span>
                            <span>+200kr</span>
                        </div>
                        <div id="initialsPrice" class="flex justify-between text-green-400 hidden">
                            <span>Initialer:</span>
                            <span>+100kr</span>
                        </div>
                        <div id="initialsSpecialPrice" class="flex justify-between text-green-400 hidden">
                            <span>Initialer specialförfrågan:</span>
                            <span>+200kr</span>
                        </div>
                        <hr class="border-gray-600">
                        <div class="flex justify-between text-xl font-bold">
                            <span>Totalt:</span>
                            <span id="totalPrice">850kr</span>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
                
    <!-- Cart Modal - Side Slide -->
    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0" onclick="closeCart()"></div>
        
        <!-- Cart Panel - Slides in from right -->
        <div class="absolute right-0 top-0 h-full w-full md:w-96 bg-premium-black transform translate-x-full transition-transform duration-300 ease-in-out shadow-2xl">
            <!-- Header -->
            <div class="bg-premium-black p-6 border-b border-mustard-gold border-opacity-30">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl md:text-3xl font-bold text-mustard-gold">🛒 Din Kundvagn</h3>
                    <button onclick="closeCart()" class="text-mustard-gold hover:text-white text-2xl transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-2 text-white text-lg">
                    <span id="cartCount" class="bg-mustard-gold text-premium-black px-3 py-1 rounded-full font-bold">0</span> produkter
                </div>
            </div>
            
            <!-- Cart Items -->
            <div class="flex-1 overflow-y-auto p-6 bg-premium-black">
                <div id="cartItems" class="space-y-4">
                    <!-- Cart items will be displayed here -->
                </div>
                </div>
            
            <!-- Footer -->
            <div class="bg-premium-black p-6 border-t border-mustard-gold border-opacity-30">
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-xl font-bold text-white">
                        <span>Totalt:</span>
                        <span id="cartTotal" class="text-mustard-gold">0 kr</span>
                    </div>
                    <div class="flex flex-col space-y-3">
                        <button onclick="goToCheckout()" class="w-full bg-gradient-to-r from-mustard-gold to-dark-green text-white py-4 px-6 rounded-lg font-bold text-lg hover:from-dark-green hover:to-mustard-gold transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            Gå till Kassan
                        </button>
                        <button onclick="closeCart()" class="w-full bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-gray-500 transition-colors">
                            Fortsätt Handla
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedCaliber = '';
        let selectedPrimary = '';
        let selectedSecondary = '';
        let selectedDesign = '';
        let selectedInitials = '';
        let cart = [];
        let basePrice = 850;

                 // Step navigation
         function showStep(step) {
             console.log('showStep called with step:', step);
             
             // Hide all step contents using both methods for consistency
             const allSteps = ['step1Content', 'step2Content', 'step3Content', 'step4Content', 'step5Content'];
             allSteps.forEach(stepId => {
                 const step = document.getElementById(stepId);
                 if (step) {
                     step.style.display = 'none';
                     step.classList.add('hidden');
                 }
             });
             console.log('Hidden all step contents');
             
             // Show current step content
             const currentStepContent = document.getElementById(`step${step}Content`);
             console.log('Current step content element:', currentStepContent);
             if (currentStepContent) {
                 currentStepContent.style.display = 'block';
                 currentStepContent.classList.remove('hidden');
                 console.log('Showed step', step, 'content');
             } else {
                 console.error('Could not find step content for step:', step);
             }
             
             // Update progress indicators
             for (let i = 1; i <= 5; i++) {
                 const stepEl = document.getElementById(`step${i}`);
                 if (i < step) {
                     stepEl.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 } else if (i === step) {
                     stepEl.className = 'step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 } else {
                     stepEl.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative';
                 }
             }
             console.log('Updated progress indicators');
         }

                 // Caliber selection
         document.querySelectorAll('[data-caliber]').forEach(btn => {
             btn.addEventListener('click', function() {
                 // Don't allow selection if special request is active
                 if (confirmedCaliberSpecial) return;
                 
                 // Toggle selection - if already selected, deselect it
                 if (this.classList.contains('selected')) {
                     this.classList.remove('selected');
                     selectedCaliber = '';
                     document.getElementById('selectedCaliber').textContent = '-';
                     document.getElementById('nextStep1').disabled = true;
                 } else {
                     document.querySelectorAll('[data-caliber]').forEach(b => b.classList.remove('selected'));
                     this.classList.add('selected');
                     selectedCaliber = this.dataset.caliber;
                     document.getElementById('selectedCaliber').textContent = this.textContent;
                     document.getElementById('nextStep1').disabled = false;
                 }
                 updatePreview();
             });
         });

                 // Primary color selection
         document.querySelectorAll('[data-color]').forEach(btn => {
             btn.addEventListener('click', function() {
                 const step = this.closest('[id$="Content"]').id.includes('step2') ? 'primary' : 'secondary';
                 
                 // Don't allow selection if special request is active
                 if (step === 'primary' && confirmedPrimarySpecial) return;
                 if (step === 'secondary' && confirmedSecondarySpecial) return;
                 
                 // Toggle selection - if already selected, deselect it
                 if (this.classList.contains('selected')) {
                     this.classList.remove('selected');
                     if (step === 'primary') {
                         selectedPrimary = '';
                         document.getElementById('selectedPrimary').textContent = '-';
                         document.getElementById('nextStep2').disabled = true;
                     } else {
                         selectedSecondary = '';
                         document.getElementById('selectedSecondary').textContent = '-';
                         document.getElementById('nextStep3').disabled = true;
                     }
                 } else {
                     document.querySelectorAll(`#step${step === 'primary' ? '2' : '3'}Content [data-color]`).forEach(b => b.classList.remove('selected'));
                     this.classList.add('selected');
                     
                     if (step === 'primary') {
                         selectedPrimary = this.dataset.color;
                         document.getElementById('selectedPrimary').textContent = this.dataset.color.charAt(0).toUpperCase() + this.dataset.color.slice(1);
                         document.getElementById('nextStep2').disabled = false;
                     } else {
                         selectedSecondary = this.dataset.color;
                         document.getElementById('selectedSecondary').textContent = this.dataset.color.charAt(0).toUpperCase() + this.dataset.color.slice(1);
                         document.getElementById('nextStep3').disabled = false;
                     }
                 }
                 updatePreview();
             });
         });

                 // Design selection
         document.querySelectorAll('[data-design]').forEach(btn => {
             btn.addEventListener('click', function() {
                 // Don't allow selection if special request is active
                 if (confirmedDesignSpecial) return;
                 
                 // Toggle selection - if already selected, deselect it
                 if (this.classList.contains('selected')) {
                     this.classList.remove('selected');
                     selectedDesign = '';
                     document.getElementById('selectedDesign').textContent = '-';
                     document.getElementById('nextStep4').disabled = true;
                 } else {
                     document.querySelectorAll('[data-design]').forEach(b => b.classList.remove('selected'));
                     this.classList.add('selected');
                     selectedDesign = this.dataset.design;
                     
                     const designNames = {
                         'alg_logo': 'Design 1',
                         'alg_design': 'Design 2',
                         'alg_jagare': 'Design 3',
                         'alg_majestic': 'Design 4',
                         'fagel_design': 'Design 5',
                        'jagare_hund': 'Design 6',
                        'algfavvo': 'Design 7',
                        'your_text': 'Design 8',
                         'none': 'Ingen Design'
                     };
                     
                     document.getElementById('selectedDesign').textContent = designNames[selectedDesign] || selectedDesign;
                     document.getElementById('nextStep4').disabled = false;
                 }
                 updatePreview();
             });
         });

                 // Special request tracking
         function updateSpecialPrices() {
             const caliberSpecial = document.getElementById('caliberSpecial').value.trim();
             const primarySpecial = document.getElementById('primarySpecial').value.trim();
             const secondarySpecial = document.getElementById('secondarySpecial').value.trim();
             const designSpecial = document.getElementById('designSpecial').value.trim();
             const initials = document.getElementById('initials').value.trim();
             const initialsSpecial = document.getElementById('initialsSpecial').value.trim();

             // Use confirmed special requests for validation (any text is valid)
             const hasValidCaliberSpecial = confirmedCaliberSpecial.length > 0;
             const hasValidPrimarySpecial = confirmedPrimarySpecial.length > 0;
             const hasValidSecondarySpecial = confirmedSecondarySpecial.length > 0;
             const hasValidDesignSpecial = confirmedDesignSpecial.length > 0;
             const hasValidInitialsSpecial = confirmedInitialsSpecial.length > 0;

             // Update price display
             document.getElementById('caliberSpecialPrice').classList.toggle('hidden', !hasValidCaliberSpecial);
             document.getElementById('primarySpecialPrice').classList.toggle('hidden', !hasValidPrimarySpecial);
             document.getElementById('secondarySpecialPrice').classList.toggle('hidden', !hasValidSecondarySpecial);
             document.getElementById('designSpecialPrice').classList.toggle('hidden', !hasValidDesignSpecial);
             document.getElementById('initialsPrice').classList.toggle('hidden', !initials);
             document.getElementById('initialsSpecialPrice').classList.toggle('hidden', !hasValidInitialsSpecial);

             // Disable/enable standard options based on special requests
             const caliberOptions = document.querySelectorAll('[data-caliber]');
             const primaryOptions = document.querySelectorAll('#step2Content [data-color]');
             const secondaryOptions = document.querySelectorAll('#step3Content [data-color]');

             caliberOptions.forEach(option => {
                 option.classList.toggle('option-disabled', !!confirmedCaliberSpecial);
             });

             primaryOptions.forEach(option => {
                 option.classList.toggle('option-disabled', !!confirmedPrimarySpecial);
             });

             secondaryOptions.forEach(option => {
                 option.classList.toggle('option-disabled', !!confirmedSecondarySpecial);
             });

             // Update preview with special requests
             updatePreviewWithSpecialRequests();

             let total = basePrice;
             if (hasValidCaliberSpecial) total += 200;
             if (hasValidPrimarySpecial) total += 200;
             if (hasValidSecondarySpecial) total += 200;
             if (hasValidDesignSpecial) total += 200;
             if (initials) total += 100;
             if (hasValidInitialsSpecial) total += 200;

             document.getElementById('totalPrice').textContent = total + 'kr';
         }

         // Update preview to show special requests
         function updatePreviewWithSpecialRequests() {
             const specialRequestsDiv = document.getElementById('specialRequests');
             const specialRequestsList = document.getElementById('specialRequestsList');

             const specialRequests = [];
             if (confirmedCaliberSpecial) specialRequests.push(`Kaliber: ${confirmedCaliberSpecial}`);
             if (confirmedPrimarySpecial) specialRequests.push(`Primär färg: ${confirmedPrimarySpecial}`);
             if (confirmedSecondarySpecial) specialRequests.push(`Sekundär färg: ${confirmedSecondarySpecial}`);
             if (confirmedDesignSpecial) specialRequests.push(`Design: ${confirmedDesignSpecial}`);
             if (confirmedInitialsSpecial) specialRequests.push(`Initialer: ${confirmedInitialsSpecial}`);

             if (specialRequests.length > 0) {
                 specialRequestsList.innerHTML = specialRequests.map(req => 
                     `<p class="text-yellow-300 text-xs mb-1">• ${req}</p>`
                 ).join('');
                 specialRequestsDiv.classList.remove('hidden');
             } else {
                 specialRequestsDiv.classList.add('hidden');
             }
         }

                 // Track confirmed special requests
         let confirmedCaliberSpecial = '';
         let confirmedPrimarySpecial = '';
         let confirmedSecondarySpecial = '';
         let confirmedDesignSpecial = '';
         let confirmedInitialsSpecial = '';

                 // Add event listeners for special requests (excluding those which now use dropdown)
        ['designSpecial', 'initials', 'initialsSpecial'].forEach(id => {
            const input = document.getElementById(id);
             
             // Handle input changes
             input.addEventListener('input', function() {
                 updateSpecialPrices();
                 updatePreview(); // Update preview immediately
                 
                 // Disable next buttons when typing (not confirmed yet)
                 if (id === 'caliberSpecial') {
                     document.getElementById('nextStep1').disabled = true;
                 } else if (id === 'primarySpecial') {
                     document.getElementById('nextStep2').disabled = true;
                 } else if (id === 'secondarySpecial') {
                     document.getElementById('nextStep3').disabled = true;
                 }
             });
             
             // Handle Enter key press
             input.addEventListener('keydown', function(e) {
                 if (e.key === 'Enter') {
                     e.preventDefault();
                     e.stopPropagation();
                     
                     const value = this.value.trim();
                     
                     console.log('Enter pressed for:', id);
                     console.log('Value:', value);
                     console.log('Current classes:', this.className);
                     
                     if (value) { // Just check if there's any text
                         if (id === 'caliberSpecial') {
                             confirmedCaliberSpecial = value;
                             console.log('Set confirmedCaliberSpecial to:', confirmedCaliberSpecial);
                             document.querySelectorAll('[data-caliber]').forEach(btn => btn.classList.remove('selected'));
                             selectedCaliber = '';
                             
                             // Force enable the button
                             const nextStep1Btn = document.getElementById('nextStep1');
                             nextStep1Btn.disabled = false;
                             nextStep1Btn.removeAttribute('disabled');
                             nextStep1Btn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                             nextStep1Btn.style.opacity = '1';
                             nextStep1Btn.style.cursor = 'pointer';
                             nextStep1Btn.style.pointerEvents = 'auto';
                             nextStep1Btn.style.backgroundColor = '#8B4513'; // Force visible background
                             
                             console.log('nextStep1 disabled after setting:', nextStep1Btn.disabled);
                             console.log('nextStep1 has disabled attribute:', nextStep1Btn.hasAttribute('disabled'));
                             console.log('nextStep1 opacity:', nextStep1Btn.style.opacity);
                             console.log('nextStep1 cursor:', nextStep1Btn.style.cursor);
                             console.log('nextStep1 background:', nextStep1Btn.style.backgroundColor);
                             
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             console.log('Applied special-request-confirmed class');
                             console.log('Classes after:', this.className);
                             console.log('ReadOnly:', this.readOnly);
                             console.log('Disabled:', this.disabled);
                             
                             // Temporary alert to confirm transformation
                             setTimeout(() => {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     console.log('✅ Transformation successful - class still present');
                                 } else {
                                     console.log('❌ Transformation failed - class removed');
                                 }
                             }, 500);
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         confirmedCaliberSpecial = '';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         } else if (id === 'primarySpecial') {
                             confirmedPrimarySpecial = value;
                             console.log('Set confirmedPrimarySpecial to:', confirmedPrimarySpecial);
                             document.querySelectorAll('#step2Content [data-color]').forEach(btn => btn.classList.remove('selected'));
                             selectedPrimary = '';
                             document.getElementById('nextStep2').disabled = false;
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         confirmedPrimarySpecial = '';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         } else if (id === 'secondarySpecial') {
                             confirmedSecondarySpecial = value;
                             console.log('Set confirmedSecondarySpecial to:', confirmedSecondarySpecial);
                             document.querySelectorAll('#step3Content [data-color]').forEach(btn => btn.classList.remove('selected'));
                             selectedSecondary = '';
                             document.getElementById('nextStep3').disabled = false;
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         confirmedSecondarySpecial = '';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         } else if (id === 'designSpecial') {
                             confirmedDesignSpecial = value;
                             console.log('Set confirmedDesignSpecial to:', confirmedDesignSpecial);
                             document.querySelectorAll('[data-design]').forEach(btn => btn.classList.remove('selected'));
                             selectedDesign = '';
                             document.getElementById('nextStep4').disabled = false;
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         confirmedDesignSpecial = '';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         } else if (id === 'initials') {
                             selectedInitials = value;
                             console.log('Set selectedInitials to:', selectedInitials);
                             document.getElementById('selectedInitials').textContent = value;
                             
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             console.log('Applied special-request-confirmed class to initials');
                             console.log('Classes after:', this.className);
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         selectedInitials = '';
                                         document.getElementById('selectedInitials').textContent = '-';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         } else if (id === 'initialsSpecial') {
                             confirmedInitialsSpecial = value;
                             console.log('Set confirmedInitialsSpecial to:', confirmedInitialsSpecial);
                             // Apply modern white box animation
                             this.classList.add('special-request-confirmed');
                             this.readOnly = true;
                             this.disabled = true;
                             
                             // Add click handler to make editable again
                             this.addEventListener('click', function(e) {
                                 if (this.classList.contains('special-request-confirmed')) {
                                     e.preventDefault();
                                     e.stopPropagation();
                                     
                                     // Animate back to text box
                                     this.style.transform = 'scale(0.95)';
                                     setTimeout(() => {
                                         this.classList.remove('special-request-confirmed');
                                         this.readOnly = false;
                                         this.disabled = false;
                                         this.style.transform = '';
                                         this.focus();
                                         
                                         // Clear the confirmed value
                                         confirmedInitialsSpecial = '';
                                         updateSpecialPrices();
                                         updatePreview();
                                     }, 150);
                                 }
                             });
                         }
                         
                         updateSpecialPrices();
                         updatePreview();
                     } else {
                         // Show error for empty input
                         this.style.borderColor = '#ef4444'; // Red border for invalid
                         setTimeout(() => {
                             this.style.borderColor = '#6b7280'; // Reset border color
                         }, 1000);
                     }
                 }
             });
             
             // Handle blur (when user clicks away) - clear confirmation
             input.addEventListener('blur', function() {
                 // Don't clear if we're clicking the next step button or if confirmed
                 setTimeout(() => {
                     // Check which step we're on and get the appropriate next step button
                     let nextStepBtn;
                     if (id === 'caliberSpecial') {
                         nextStepBtn = document.getElementById('nextStep1');
                     } else if (id === 'primarySpecial') {
                         nextStepBtn = document.getElementById('nextStep2');
                     } else if (id === 'secondarySpecial') {
                         nextStepBtn = document.getElementById('nextStep3');
                     } else if (id === 'initialsSpecial') {
                         nextStepBtn = document.getElementById('addToCart');
                     }
                     
                     if (nextStepBtn && document.activeElement === nextStepBtn) {
                         return; // Don't clear if next step button is focused
                     }
                     
                     // Don't clear if the input is confirmed (has the special class)
                     if (this.classList.contains('special-request-confirmed')) {
                         return; // Keep the confirmation
                     }
                     
                     if (id === 'caliberSpecial') {
                         confirmedCaliberSpecial = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                         if (!selectedCaliber) {
                             document.getElementById('nextStep1').disabled = true;
                         }
                     } else if (id === 'primarySpecial') {
                         confirmedPrimarySpecial = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                         if (!selectedPrimary) {
                             document.getElementById('nextStep2').disabled = true;
                         }
                     } else if (id === 'secondarySpecial') {
                         confirmedSecondarySpecial = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                         if (!selectedSecondary) {
                             document.getElementById('nextStep3').disabled = true;
                         }
                     } else if (id === 'designSpecial') {
                         confirmedDesignSpecial = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                         if (!selectedDesign) {
                             document.getElementById('nextStep4').disabled = true;
                         }
                     } else if (id === 'initials') {
                         selectedInitials = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                         document.getElementById('selectedInitials').textContent = '-';
                     } else if (id === 'initialsSpecial') {
                         confirmedInitialsSpecial = '';
                         this.classList.remove('special-request-confirmed');
                         this.readOnly = false;
                         this.disabled = false;
                     }
                     
                     updateSpecialPrices();
                     updatePreview();
                 }, 100); // Small delay to check focus
             });
                 });

        // NEW: Special Request Dropdown Functionality
        function setupSpecialRequestDropdown(type) {
            const btn = document.getElementById(`${type}SpecialBtn`);
            const dropdown = document.getElementById(`${type}SpecialDropdown`);
            const confirmed = document.getElementById(`${type}SpecialConfirmed`);
            const textarea = document.getElementById(`${type}Special`);
            const confirmBtn = document.getElementById(`${type}SpecialConfirm`);
            const cancelBtn = document.getElementById(`${type}SpecialCancel`);
            const editBtn = document.getElementById(`${type}SpecialEdit`);
            const undoBtn = document.getElementById(`${type}SpecialUndo`);
            const icon = document.getElementById(`${type}SpecialIcon`);
            const textDisplay = document.getElementById(`${type}SpecialText`);
            
            // Get the normal options container based on type
            let normalOptionsContainer;
            let stepContentSelector;
            let selectedVariable;
            let nextButtonId;
            let selectedDisplayId;
            
            if (type === 'primary') {
                normalOptionsContainer = document.querySelector('#step2Content .grid');
                stepContentSelector = '#step2Content [data-color]';
                nextButtonId = 'nextStep2';
                selectedDisplayId = 'selectedPrimary';
            } else if (type === 'caliber') {
                normalOptionsContainer = document.querySelector('#step1Content .grid');
                stepContentSelector = '#step1Content [data-caliber]';
                nextButtonId = 'nextStep1';
                selectedDisplayId = 'selectedCaliber';
            } else if (type === 'secondary') {
                normalOptionsContainer = document.querySelector('#step3Content .grid');
                stepContentSelector = '#step3Content [data-color]';
                nextButtonId = 'nextStep3';
                selectedDisplayId = 'selectedSecondary';
            }
            
            // Toggle dropdown when button is clicked
            btn.addEventListener('click', function() {
                const isOpen = !dropdown.classList.contains('hidden');
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });
            
            function openDropdown() {
                dropdown.classList.remove('hidden');
                confirmed.classList.add('hidden');
                
                // Hide the dropdown button completely and immediately
                btn.style.display = 'none';
                btn.style.visibility = 'hidden';
                
                // Hide normal options with smooth animation
                if (normalOptionsContainer) {
                    normalOptionsContainer.style.transition = 'all 0.3s ease';
                    normalOptionsContainer.style.opacity = '0';
                    normalOptionsContainer.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        normalOptionsContainer.style.display = 'none';
                    }, 300);
                }
                
                textarea.focus();
            }
            
            function closeDropdown() {
                dropdown.classList.add('hidden');
                
                // Show the dropdown button again
                btn.style.display = '';
                btn.style.visibility = 'visible';
                btn.style.opacity = '1';
                btn.style.transform = 'translateY(0)';
                icon.style.transform = 'rotate(0deg)';
                
                // Show normal options with smooth animation
                if (normalOptionsContainer) {
                    normalOptionsContainer.style.display = '';
                    setTimeout(() => {
                        normalOptionsContainer.style.opacity = '1';
                        normalOptionsContainer.style.transform = 'translateY(0)';
                    }, 50);
                }
            }
            
            function confirmSpecialRequest() {
                const value = textarea.value.trim();
                if (value) {
                    // Set the confirmed value based on type
                    if (type === 'primary') {
                        confirmedPrimarySpecial = value;
                        selectedPrimary = '';
                        document.getElementById(selectedDisplayId).textContent = 'Specialförfrågan';
                        document.getElementById(nextButtonId).disabled = false;
                    } else if (type === 'caliber') {
                        confirmedCaliberSpecial = value;
                        selectedCaliber = '';
                        document.getElementById(selectedDisplayId).textContent = 'Specialförfrågan';
                        document.getElementById(nextButtonId).disabled = false;
                    } else if (type === 'secondary') {
                        confirmedSecondarySpecial = value;
                        selectedSecondary = '';
                        document.getElementById(selectedDisplayId).textContent = 'Specialförfrågan';
                        document.getElementById(nextButtonId).disabled = false;
                    }
                    
                    // Show confirmed state
                    textDisplay.textContent = value;
                    confirmed.classList.remove('hidden');
                    dropdown.classList.add('hidden');
                    
                    // Keep the dropdown button hidden after confirmation
                    btn.style.display = 'none';
                    btn.style.visibility = 'hidden';
                    
                    // Keep normal options hidden when special request is confirmed
                    // They will only show again when user cancels or edits
                    
                    // Clear any selected options
                    document.querySelectorAll(stepContentSelector).forEach(opt => opt.classList.remove('selected'));
                    
                    updateSpecialPrices();
                    updatePreview();
                }
            }
            
            // Confirm special request
            confirmBtn.addEventListener('click', confirmSpecialRequest);
            
            // Cancel special request
            cancelBtn.addEventListener('click', function() {
                textarea.value = '';
                closeDropdown();
            });
            
            // Edit confirmed special request
            editBtn.addEventListener('click', function() {
                confirmed.classList.add('hidden');
                dropdown.classList.remove('hidden');
                textarea.value = textDisplay.textContent;
                
                // Hide the dropdown button completely when editing (it's already hidden from confirmation)
                btn.style.display = 'none';
                btn.style.visibility = 'hidden';
                
                // Keep normal options hidden during editing
                if (normalOptionsContainer && normalOptionsContainer.style.display !== 'none') {
                    normalOptionsContainer.style.transition = 'all 0.3s ease';
                    normalOptionsContainer.style.opacity = '0';
                    normalOptionsContainer.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        normalOptionsContainer.style.display = 'none';
                    }, 300);
                }
                
                // Clear confirmed value
                if (type === 'primary') {
                    confirmedPrimarySpecial = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                } else if (type === 'caliber') {
                    confirmedCaliberSpecial = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                } else if (type === 'secondary') {
                    confirmedSecondarySpecial = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                }
                
                updateSpecialPrices();
                updatePreview();
                textarea.focus();
            });
            
            // Undo confirmed special request (reset to normal state)
            undoBtn.addEventListener('click', function() {
                // Hide confirmed state
                confirmed.classList.add('hidden');
                
                // Show the dropdown button again
                btn.style.display = '';
                btn.style.visibility = 'visible';
                btn.style.opacity = '1';
                btn.style.transform = 'translateY(0)';
                icon.style.transform = 'rotate(0deg)';
                
                // Show normal options with smooth animation
                if (normalOptionsContainer) {
                    normalOptionsContainer.style.display = '';
                    setTimeout(() => {
                        normalOptionsContainer.style.opacity = '1';
                        normalOptionsContainer.style.transform = 'translateY(0)';
                    }, 50);
                }
                
                // Clear confirmed value and reset state
                if (type === 'primary') {
                    confirmedPrimarySpecial = '';
                    selectedPrimary = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                } else if (type === 'caliber') {
                    confirmedCaliberSpecial = '';
                    selectedCaliber = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                } else if (type === 'secondary') {
                    confirmedSecondarySpecial = '';
                    selectedSecondary = '';
                    document.getElementById(selectedDisplayId).textContent = '-';
                    document.getElementById(nextButtonId).disabled = true;
                }
                
                // Clear textarea
                textarea.value = '';
                
                updateSpecialPrices();
                updatePreview();
            });
            
            // Handle Enter key in textarea
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    confirmSpecialRequest();
                }
            });
        }
        
        // Initialize dropdowns for special requests
        setupSpecialRequestDropdown('caliber');
        setupSpecialRequestDropdown('primary');
        setupSpecialRequestDropdown('secondary');
        
        // Mobile layout: allow scrolling; clear any previous locks
        function optimizeMobileLayout() {
            document.documentElement.style.height = '';
            document.documentElement.style.overflow = '';
            document.body.style.height = '';
            document.body.style.overflow = '';
        }
        // Apply once
        optimizeMobileLayout();

                // Update preview image and selections
         function updatePreview() {
             // Ensure pairs exist
             ensurePairs();
             
             const placeholderText = document.getElementById('placeholderText');
             
             // Update caliber display
             if (confirmedCaliberSpecial) {
                 document.getElementById('selectedCaliber').textContent = confirmedCaliberSpecial;
             } else if (selectedCaliber) {
                 const caliberButton = document.querySelector(`[data-caliber="${selectedCaliber}"]`);
                 document.getElementById('selectedCaliber').textContent = caliberButton ? caliberButton.textContent : selectedCaliber;
             } else {
                 document.getElementById('selectedCaliber').textContent = '-';
             }
             
             // Update primary color display
             if (confirmedPrimarySpecial) {
                 document.getElementById('selectedPrimary').textContent = confirmedPrimarySpecial;
             } else if (selectedPrimary) {
                 document.getElementById('selectedPrimary').textContent = selectedPrimary.charAt(0).toUpperCase() + selectedPrimary.slice(1);
             } else {
                 document.getElementById('selectedPrimary').textContent = '-';
             }
             
             // Update secondary color display
             if (confirmedSecondarySpecial) {
                 document.getElementById('selectedSecondary').textContent = confirmedSecondarySpecial;
             } else if (selectedSecondary) {
                 document.getElementById('selectedSecondary').textContent = selectedSecondary.charAt(0).toUpperCase() + selectedSecondary.slice(1);
             } else {
                 document.getElementById('selectedSecondary').textContent = '-';
             }
             
             // Update design display
             if (confirmedDesignSpecial) {
                 document.getElementById('selectedDesign').textContent = confirmedDesignSpecial;
             } else if (selectedDesign) {
                 const designNames = {
                     'alg_logo': 'Design 1',
                     'alg_design': 'Design 2',
                     'alg_jagare': 'Design 3',
                     'alg_majestic': 'Design 4',
                     'fagel_design': 'Design 5',
                        'jagare_hund': 'Design 6',
                        'algfavvo': 'Design 7',
                        'your_text': 'Design 8',
                     'none': 'Ingen Design'
                 };
                 document.getElementById('selectedDesign').textContent = designNames[selectedDesign] || selectedDesign;
             } else {
                 document.getElementById('selectedDesign').textContent = '-';
             }
             
             // Update layered images
             const baseSrc = confirmedPrimarySpecial ? null : primaryImageMap[selectedPrimary];
             const logoSrc = confirmedSecondarySpecial ? null : secondaryLogoMap[selectedSecondary];
             const buttonSrc = confirmedSecondarySpecial ? null : secondaryButtonMap[selectedSecondary];
             
             // Debug resolved URLs
             try {
                 console.log('[Design] Resolved sources:', { baseSrc, logoSrc, buttonSrc });
             } catch (e) {}
             
             if (baseSrc) {
                 crossfade(basePair, baseSrc);
                 placeholderText.style.display = 'none';
             } else {
                 crossfade(basePair, null);
                 // If a primary is selected but we didn't resolve a src (e.g., mapping/case issue), still hide placeholder
                 if (selectedPrimary && !confirmedPrimarySpecial) {
                     placeholderText.style.display = 'none';
                     try { console.error('[Design] Missing baseSrc for selectedPrimary', selectedPrimary); } catch (e) {}
                 } else {
                     placeholderText.style.display = 'block';
                 }
             }
             try {
                 crossfade(logoPair, logoSrc);
                 crossfade(buttonPair, buttonSrc);
             } catch (e) { try { console.error('[Design] Overlay set error', e); } catch (_) {} }
         }

                 // Step navigation buttons
         document.getElementById('nextStep1').addEventListener('click', () => {
             console.log('=== NEXT STEP 1 CLICKED ===');
             console.log('selectedCaliber:', selectedCaliber);
             console.log('confirmedCaliberSpecial:', confirmedCaliberSpecial);
             
             // Check if we can proceed
             const canProceed = selectedCaliber || confirmedCaliberSpecial;
             console.log('Can proceed:', canProceed);
             
             if (!canProceed) {
                 // Cannot proceed - no valid selection
                 return;
             }
             
             // Simple step navigation test
             try {
                 console.log('Starting step navigation...');
                 
                 // Get step elements
                 const step1 = document.getElementById('step1Content');
                 const step2 = document.getElementById('step2Content');
                 
                 console.log('Step 1 element:', step1);
                 console.log('Step 2 element:', step2);
                 
                 if (step1) {
                     console.log('Step 1 current display:', step1.style.display);
                     console.log('Step 1 current classes:', step1.className);
                     step1.style.display = 'none';
                     step1.classList.add('hidden');
                     console.log('Step 1 hidden');
                 }
                 
                 if (step2) {
                     console.log('Step 2 current display:', step2.style.display);
                     console.log('Step 2 current classes:', step2.className);
                     step2.style.display = 'block';
                     step2.classList.remove('hidden');
                     console.log('Step 2 shown');
                 }
                 
                 // Update indicators
                 const step1Indicator = document.getElementById('step1');
                 const step2Indicator = document.getElementById('step2');
                 
                 if (step1Indicator) {
                     step1Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                     console.log('Step 1 indicator updated');
                 }
                 
                 if (step2Indicator) {
                     step2Indicator.className = 'step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                     console.log('Step 2 indicator updated');
                 }
                 
                 console.log('Step navigation completed successfully');
                 
             } catch (error) {
                 console.error('Error in step navigation:', error);
                 alert('Error: ' + error.message);
             }
         });

         document.getElementById('nextStep2').addEventListener('click', () => {
             console.log('=== NEXT STEP 2 CLICKED ===');
             console.log('selectedPrimary:', selectedPrimary);
             console.log('confirmedPrimarySpecial:', confirmedPrimarySpecial);
             
             // Check if we can proceed
             const canProceed = selectedPrimary || confirmedPrimarySpecial;
             console.log('Can proceed:', canProceed);
             
             if (!canProceed) {
                 // Cannot proceed - no valid selection
                 return;
             }
             
             // Proper step navigation
             try {
                 console.log('Starting step 2 to 3 navigation...');
                 
                 // Hide ALL step content first
                 const allSteps = ['step1Content', 'step2Content', 'step3Content', 'step4Content'];
                 allSteps.forEach(stepId => {
                     const step = document.getElementById(stepId);
                     if (step) {
                         step.style.display = 'none';
                         step.classList.add('hidden');
                     }
                 });
                 
                 // Show only step 3
                 const step3 = document.getElementById('step3Content');
                 if (step3) {
                     step3.style.display = 'block';
                     step3.classList.remove('hidden');
                     console.log('Step 3 shown');
                 }
                 
                 // Update progress indicators
                 const step1Indicator = document.getElementById('step1');
                 const step2Indicator = document.getElementById('step2');
                 const step3Indicator = document.getElementById('step3');
                 const step4Indicator = document.getElementById('step4');
                 
                 if (step1Indicator) {
                     step1Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step2Indicator) {
                     step2Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step3Indicator) {
                     step3Indicator.className = 'step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step4Indicator) {
                     step4Indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative';
                 }
                 
                 console.log('Step navigation completed successfully');
                 
             } catch (error) {
                 console.error('Error in step navigation:', error);
                 alert('Error: ' + error.message);
             }
         });

         document.getElementById('nextStep3').addEventListener('click', () => {
             console.log('=== NEXT STEP 3 CLICKED ===');
             
             // Proper step navigation
             try {
                 // Hide ALL step content first
                 const allSteps = ['step1Content', 'step2Content', 'step3Content', 'step4Content', 'step5Content'];
                 allSteps.forEach(stepId => {
                     const step = document.getElementById(stepId);
                     if (step) {
                         step.style.display = 'none';
                         step.classList.add('hidden');
                     }
                 });
                 
                 // Show only step 4
                 const step4 = document.getElementById('step4Content');
                 if (step4) {
                     step4.style.display = 'block';
                     step4.classList.remove('hidden');
                     console.log('Step 4 shown');
                 }
                 
                 // Update progress indicators
                 const step1Indicator = document.getElementById('step1');
                 const step2Indicator = document.getElementById('step2');
                 const step3Indicator = document.getElementById('step3');
                 const step4Indicator = document.getElementById('step4');
                 const step5Indicator = document.getElementById('step5');
                 
                 if (step1Indicator) {
                     step1Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step2Indicator) {
                     step2Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step3Indicator) {
                     step3Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step4Indicator) {
                     step4Indicator.className = 'step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step5Indicator) {
                     step5Indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold bg-gray-600 relative';
                 }
                 
                 console.log('Step navigation completed successfully');
                 
             } catch (error) {
                 console.error('Error in step navigation:', error);
                 alert('Error: ' + error.message);
             }
         });

         document.getElementById('nextStep4').addEventListener('click', () => {
             console.log('=== NEXT STEP 4 CLICKED ===');
             
             // Proper step navigation
             try {
                 // Hide ALL step content first
                 const allSteps = ['step1Content', 'step2Content', 'step3Content', 'step4Content', 'step5Content'];
                 allSteps.forEach(stepId => {
                     const step = document.getElementById(stepId);
                     if (step) {
                         step.style.display = 'none';
                         step.classList.add('hidden');
                     }
                 });
                 
                 // Show only step 5
                 const step5 = document.getElementById('step5Content');
                 if (step5) {
                     step5.style.display = 'block';
                     step5.classList.remove('hidden');
                     console.log('Step 5 shown');
                 }
                 
                 // Update progress indicators
                 const step1Indicator = document.getElementById('step1');
                 const step2Indicator = document.getElementById('step2');
                 const step3Indicator = document.getElementById('step3');
                 const step4Indicator = document.getElementById('step4');
                 const step5Indicator = document.getElementById('step5');
                 
                 if (step1Indicator) {
                     step1Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step2Indicator) {
                     step2Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step3Indicator) {
                     step3Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step4Indicator) {
                     step4Indicator.className = 'step-completed w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 if (step5Indicator) {
                     step5Indicator.className = 'step-active w-12 h-12 rounded-full flex items-center justify-center font-bold relative';
                 }
                 
                 console.log('Step navigation completed successfully');
                 
             } catch (error) {
                 console.error('Error in step navigation:', error);
                 alert('Error: ' + error.message);
             }
         });

        document.getElementById('prevStep2').addEventListener('click', () => {
            console.log('=== PREV STEP 2 CLICKED ===');
            console.log('Current step before:', currentStep);
            currentStep = 1;
            console.log('Current step after:', currentStep);
            showStep(currentStep);
        });

        document.getElementById('prevStep3').addEventListener('click', () => {
            console.log('=== PREV STEP 3 CLICKED ===');
            console.log('Current step before:', currentStep);
            currentStep = 2;
            console.log('Current step after:', currentStep);
            showStep(currentStep);
        });

        document.getElementById('prevStep4').addEventListener('click', () => {
            console.log('=== PREV STEP 4 CLICKED ===');
            console.log('Current step before:', currentStep);
            currentStep = 3;
            console.log('Current step after:', currentStep);
            showStep(currentStep);
        });

        document.getElementById('prevStep5').addEventListener('click', () => {
            console.log('=== PREV STEP 5 CLICKED ===');
            console.log('Current step before:', currentStep);
            currentStep = 4;
            console.log('Current step after:', currentStep);
            showStep(currentStep);
        });

        // Add to cart
        document.getElementById('addToCart').addEventListener('click', () => {
            // If we are editing an existing item, delegate to updater and stop
            if (window.__isEditingCartItem && window.__editingCartItemId != null) {
                updateCartItem(window.__editingCartItemId);
                return;
            }

            const initials = document.getElementById('initials').value.trim();
            selectedInitials = initials;
            document.getElementById('selectedInitials').textContent = initials || '-';

            const product = {
                id: Date.now(), // Unique ID for editing
                caliber: selectedCaliber,
                primaryColor: selectedPrimary,
                secondaryColor: selectedSecondary,
                design: selectedDesign,
                initials: initials,
                specialRequests: {
                    caliber: confirmedCaliberSpecial || document.getElementById('caliberSpecial').value.trim(),
                    primary: confirmedPrimarySpecial || document.getElementById('primarySpecial').value.trim(),
                    secondary: confirmedSecondarySpecial || document.getElementById('secondarySpecial').value.trim(),
                    design: confirmedDesignSpecial || document.getElementById('designSpecial').value.trim(),
                    initials: confirmedInitialsSpecial || document.getElementById('initialsSpecial').value.trim()
                },
                price: parseInt(document.getElementById('totalPrice').textContent.replace(/[^0-9]/g, ''))
            };

            cart.push(product);
            updateCartCount();
            
            // Reset form
            resetForm();
            
            // Automatically open cart after adding product
            setTimeout(() => {
                toggleCart();
            }, 500);
        });

                 function resetForm() {
             currentStep = 1;
             selectedCaliber = '';
             selectedPrimary = '';
             selectedSecondary = '';
             selectedDesign = '';
             selectedInitials = '';
             
             // Reset confirmed special requests
             confirmedCaliberSpecial = '';
             confirmedPrimarySpecial = '';
             confirmedSecondarySpecial = '';
             confirmedDesignSpecial = '';
             confirmedInitialsSpecial = '';
             
             // Reset selections
             document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
             document.querySelectorAll('button[disabled]').forEach(btn => btn.disabled = true);
             
             // Reset text inputs
             ['caliberSpecial', 'primarySpecial', 'secondarySpecial', 'designSpecial', 'initials', 'initialsSpecial'].forEach(id => {
                 const input = document.getElementById(id);
                 input.value = '';
                 input.classList.remove('special-request-confirmed');
                 input.readOnly = false;
                 input.disabled = false;
             });
             
             // Reset preview
             document.getElementById('selectedCaliber').textContent = '-';
             document.getElementById('selectedPrimary').textContent = '-';
             document.getElementById('selectedSecondary').textContent = '-';
             document.getElementById('selectedDesign').textContent = '-';
             document.getElementById('selectedInitials').textContent = '-';
             
             // Reset price
             document.getElementById('totalPrice').textContent = '850kr';
             document.querySelectorAll('[id$="SpecialPrice"], #initialsPrice').forEach(el => el.classList.add('hidden'));
             
             // Reset special requests display
             document.getElementById('specialRequests').classList.add('hidden');
             
             // Re-enable all options
             document.querySelectorAll('.option-disabled').forEach(el => el.classList.remove('option-disabled'));
             
             showStep(1);
             updatePreview();
             updateSpecialPrices();
         }

        function updateCartCount() {
            // Update all cart count elements
            const cartCountElements = document.querySelectorAll('#cartCount');
            cartCountElements.forEach(element => {
                element.textContent = cart.length;
            });
        }

        function toggleCart() {
            const modal = document.getElementById('cartModal');
            const cartPanel = modal.querySelector('.absolute.right-0');
            const items = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            // Update cart count first
            updateCartCount();
            
            // Calculate total
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            cartTotal.textContent = total + ' kr';
            
            if (cart.length === 0) {
                items.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-shopping-cart text-6xl text-gray-500 mb-4"></i>
                        <p class="text-xl text-gray-400 font-semibold">Din kundvagn är tom</p>
                        <p class="text-gray-500 mt-2">Lägg till produkter för att komma igång</p>
                    </div>
                `;
            } else {
                items.innerHTML = cart.map((item, index) => {
                    // Determine display values
                    const displayCaliber = item.caliber || (item.specialRequests.caliber ? 'Specialförfrågan' : 'Ej vald');
                    const displayPrimary = item.primaryColor || (item.specialRequests.primary ? 'Specialförfrågan' : 'Ej vald');
                    const displaySecondary = item.secondaryColor || (item.specialRequests.secondary ? 'Specialförfrågan' : 'Ej vald');
                    
                    // Get design name for display
                    const designNames = {
                        'alg_logo': 'Design 1',
                        'alg_design': 'Design 2',
                        'alg_jagare': 'Design 3',
                        'alg_majestic': 'Design 4',
                        'fagel_design': 'Design 5',
                        'jagare_hund': 'Design 6',
                        'algfavvo': 'Design 7',
                        'your_text': 'Design 8',
                        'none': 'Ingen Design'
                    };
                    const displayDesign = item.design ? (designNames[item.design] || item.design) : (item.specialRequests.design ? 'Specialförfrågan' : 'Ej vald');
                    
                    return `
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 border border-mustard-gold border-opacity-20">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <p class="font-bold text-lg text-white">${displayCaliber}</p>
                                    <p class="text-mustard-gold font-semibold">${displayPrimary}/${displaySecondary}</p>
                                    ${displayDesign !== 'Ej vald' ? `<p class="text-gray-300 text-sm">Design: ${displayDesign}</p>` : ''}
                                    ${item.initials ? `<p class="text-gray-300 text-sm">Initialer: ${item.initials}</p>` : ''}
                                    ${Object.values(item.specialRequests).some(req => req) ? `
                                        <div class="mt-2 p-2 bg-yellow-500 bg-opacity-20 rounded">
                                            <p class="text-yellow-300 text-xs font-semibold">Specialförfrågningar:</p>
                                            ${Object.entries(item.specialRequests).map(([key, value]) => value ? `<p class="text-yellow-200 text-xs">• ${key}: ${value}</p>` : '').join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-xl text-mustard-gold">${item.price} kr</p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="editCartItem(${index})" class="text-blue-400 hover:text-blue-300 text-sm font-semibold transition-colors">
                                            <i class="fas fa-edit mr-1"></i>Redigera
                                        </button>
                                        <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-300 text-sm font-semibold transition-colors">
                                            <i class="fas fa-trash mr-1"></i>Ta bort
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show modal and slide in
            modal.classList.remove('hidden');
            setTimeout(() => {
                cartPanel.classList.remove('translate-x-full');
            }, 10);
        }

        function closeCart() {
            const modal = document.getElementById('cartModal');
            const cartPanel = modal.querySelector('.absolute.right-0');
            
            // Slide out
            cartPanel.classList.add('translate-x-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCount();
            toggleCart();
        }

        function editCartItem(index) {
            const item = cart[index];
            
            // Close cart first
            closeCart();
            
            // Load the item data into the form
            loadItemForEditing(item);
            
            // Remove the item from cart (will be re-added when user confirms)
            cart.splice(index, 1);
            updateCartCount();
        }

        function loadItemForEditing(item) {
            console.log('Loading item for editing:', item);
            
            // Clear all previous selections first
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.special-request-confirmed').forEach(el => {
                el.classList.remove('special-request-confirmed');
                el.readOnly = false;
                el.disabled = false;
            });
            
            // Reset all form inputs
            ['caliberSpecial', 'primarySpecial', 'secondarySpecial', 'designSpecial', 'initials', 'initialsSpecial'].forEach(id => {
                const input = document.getElementById(id);
                input.value = '';
                input.classList.remove('special-request-confirmed');
                input.readOnly = false;
                input.disabled = false;
            });
            
            // Set the form values based on the item
            selectedCaliber = item.caliber || '';
            selectedPrimary = item.primaryColor || '';
            selectedSecondary = item.secondaryColor || '';
            selectedDesign = item.design || '';
            selectedInitials = item.initials || '';
            
            // Load special requests
            confirmedCaliberSpecial = item.specialRequests.caliber || '';
            confirmedPrimarySpecial = item.specialRequests.primary || '';
            confirmedSecondarySpecial = item.specialRequests.secondary || '';
            confirmedDesignSpecial = item.specialRequests.design || '';
            confirmedInitialsSpecial = item.specialRequests.initials || '';
            
            console.log('Loaded values:', {
                selectedCaliber,
                selectedPrimary,
                selectedSecondary,
                selectedDesign,
                selectedInitials,
                confirmedCaliberSpecial,
                confirmedPrimarySpecial,
                confirmedSecondarySpecial,
                confirmedDesignSpecial,
                confirmedInitialsSpecial
            });
            
            // Update form inputs for special requests
            if (confirmedCaliberSpecial) {
                document.getElementById('caliberSpecial').value = confirmedCaliberSpecial;
                document.getElementById('caliberSpecial').classList.add('special-request-confirmed');
                document.getElementById('caliberSpecial').readOnly = true;
                document.getElementById('caliberSpecial').disabled = true;
            }
            
            if (confirmedPrimarySpecial) {
                document.getElementById('primarySpecial').value = confirmedPrimarySpecial;
                document.getElementById('primarySpecial').classList.add('special-request-confirmed');
                document.getElementById('primarySpecial').readOnly = true;
                document.getElementById('primarySpecial').disabled = true;
            }
            
            if (confirmedSecondarySpecial) {
                document.getElementById('secondarySpecial').value = confirmedSecondarySpecial;
                document.getElementById('secondarySpecial').classList.add('special-request-confirmed');
                document.getElementById('secondarySpecial').readOnly = true;
                document.getElementById('secondarySpecial').disabled = true;
            }
            
            if (confirmedDesignSpecial) {
                document.getElementById('designSpecial').value = confirmedDesignSpecial;
                document.getElementById('designSpecial').classList.add('special-request-confirmed');
                document.getElementById('designSpecial').readOnly = true;
                document.getElementById('designSpecial').disabled = true;
            }
            
            if (selectedInitials) {
                document.getElementById('initials').value = selectedInitials;
                document.getElementById('initials').classList.add('special-request-confirmed');
                document.getElementById('initials').readOnly = true;
                document.getElementById('initials').disabled = true;
            }
            
            if (confirmedInitialsSpecial) {
                document.getElementById('initialsSpecial').value = confirmedInitialsSpecial;
                document.getElementById('initialsSpecial').classList.add('special-request-confirmed');
                document.getElementById('initialsSpecial').readOnly = true;
                document.getElementById('initialsSpecial').disabled = true;
            }
            
            // Update visual selections
            updateVisualSelections();
            
            // Update preview and prices
            updatePreview();
            updateSpecialPrices();
            
            // Navigate to the appropriate step
            navigateToRelevantStep();
            
            // Switch button to update mode using global flags
            const addToCartBtn = document.getElementById('addToCart');
            addToCartBtn.textContent = 'Uppdatera Kundvagn';
            window.__isEditingCartItem = true;
            window.__editingCartItemId = item.id;
        }

        function updateVisualSelections() {
            // Clear all selections first
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            
            // Select caliber if not a special request
            if (selectedCaliber && !confirmedCaliberSpecial) {
                const caliberBtn = document.querySelector(`[data-caliber="${selectedCaliber}"]`);
                if (caliberBtn) caliberBtn.classList.add('selected');
            }
            
            // Select primary color if not a special request
            if (selectedPrimary && !confirmedPrimarySpecial) {
                const primaryBtn = document.querySelector(`#step2Content [data-color="${selectedPrimary}"]`);
                if (primaryBtn) primaryBtn.classList.add('selected');
            }
            
            // Select secondary color if not a special request
            if (selectedSecondary && !confirmedSecondarySpecial) {
                const secondaryBtn = document.querySelector(`#step3Content [data-color="${selectedSecondary}"]`);
                if (secondaryBtn) secondaryBtn.classList.add('selected');
            }
            
            // Select design if not a special request
            if (selectedDesign && !confirmedDesignSpecial) {
                const designBtn = document.querySelector(`[data-design="${selectedDesign}"]`);
                if (designBtn) designBtn.classList.add('selected');
            }
        }

        function navigateToRelevantStep() {
            // Determine which step to show based on what's selected
            if (selectedCaliber || confirmedCaliberSpecial) {
                if (selectedPrimary || confirmedPrimarySpecial) {
                    if (selectedSecondary || confirmedSecondarySpecial) {
                        if (selectedDesign || confirmedDesignSpecial) {
                            showStep(5); // Go to initials step
                        } else {
                            showStep(4); // Go to design step
                        }
                    } else {
                        showStep(3); // Go to secondary color step
                    }
                } else {
                    showStep(2); // Go to primary color step
                }
            } else {
                showStep(1); // Go to caliber step
            }
        }

        function updateCartItem(originalId) {
            console.log('Updating cart item with ID:', originalId);
            
            const initials = document.getElementById('initials').value.trim();
            selectedInitials = initials;
            document.getElementById('selectedInitials').textContent = initials || '-';

            // Get current values (prioritize confirmed special requests)
            const currentCaliber = confirmedCaliberSpecial || selectedCaliber;
            const currentPrimary = confirmedPrimarySpecial || selectedPrimary;
            const currentSecondary = confirmedSecondarySpecial || selectedSecondary;
            const currentDesign = confirmedDesignSpecial || selectedDesign;
            const currentInitials = selectedInitials;
            
            console.log('Current values for update:', {
                currentCaliber,
                currentPrimary,
                currentSecondary,
                currentDesign,
                currentInitials,
                confirmedCaliberSpecial,
                confirmedPrimarySpecial,
                confirmedSecondarySpecial,
                confirmedDesignSpecial,
                confirmedInitialsSpecial
            });

            const updatedProduct = {
                id: originalId, // Keep the same ID
                caliber: currentCaliber,
                primaryColor: currentPrimary,
                secondaryColor: currentSecondary,
                design: currentDesign,
                initials: currentInitials,
                specialRequests: {
                    caliber: confirmedCaliberSpecial || '',
                    primary: confirmedPrimarySpecial || '',
                    secondary: confirmedSecondarySpecial || '',
                    design: confirmedDesignSpecial || '',
                    initials: confirmedInitialsSpecial || ''
                },
                price: parseInt(document.getElementById('totalPrice').textContent.replace(/[^0-9]/g, ''))
            };

            console.log('Updated product:', updatedProduct);
            cart.push(updatedProduct);
            updateCartCount();
            
            // Reset form
            resetForm();
            
            // Reset button and flags back to normal add mode
            const addToCartBtn = document.getElementById('addToCart');
            addToCartBtn.textContent = 'Lägg till i Kundvagn';
            window.__isEditingCartItem = false;
            window.__editingCartItemId = null;
            
            // Automatically open cart after updating
            setTimeout(() => {
                toggleCart();
            }, 500);
        }

        // Stripe integration
        let stripe = null;
        let publishableKey = null;

        // Initialize Stripe
        async function initializeStripe() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                publishableKey = config.publishableKey;
                
                if (publishableKey) {
                    stripe = Stripe(publishableKey);
                    console.log('Stripe initialized successfully');
                } else {
                    console.error('No publishable key found');
                }
            } catch (error) {
                console.error('Failed to initialize Stripe:', error);
            }
        }

        // Create checkout session
        async function createCheckoutSession(items, customerEmail) {
            try {
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: items,
                        customerEmail: customerEmail
                    }),
                });

                if (!response.ok) {
                    throw new Error('Failed to create checkout session');
                }

                const { sessionId } = await response.json();
                return sessionId;
            } catch (error) {
                console.error('Error creating checkout session:', error);
                throw error;
            }
        }

        // Redirect to Stripe checkout
        async function redirectToCheckout(sessionId) {
            if (!stripe) {
                console.error('Stripe not initialized');
                return;
            }

            const { error } = await stripe.redirectToCheckout({
                sessionId: sessionId
            });

            if (error) {
                console.error('Error redirecting to checkout:', error);
                // Error occurred during redirect to payment page
            }
        }

        // Enhanced checkout function
        async function goToCheckout() {
            if (cart.length === 0) {
                // Cart is empty
                return;
            }

            // Show loading state
            const checkoutBtn = document.querySelector('button[onclick="goToCheckout()"]');
            const originalText = checkoutBtn.textContent;
            checkoutBtn.textContent = 'Laddar...';
            checkoutBtn.disabled = true;

            try {
                // Save cart data to localStorage for checkout page
                const cartData = {
                    items: cart,
                    total: cart.reduce((sum, item) => sum + item.price, 0)
                };
                localStorage.setItem('nordkaliberCart', JSON.stringify(cartData));
                
                // Redirect to checkout page
                window.location.href = '/checkout';
                
            } catch (error) {
                console.error('Checkout error:', error);
                // Error occurred during transfer to checkout
            } finally {
                // Reset button state
                checkoutBtn.textContent = originalText;
                checkoutBtn.disabled = false;
            }
        }

                 // Initialize
         console.log('=== SCRIPT LOADED ===');
         showStep(1);
         updateSpecialPrices();
         
         // Initialize Stripe when page loads
         document.addEventListener('DOMContentLoaded', function() {
             initializeStripe();
         });
         
         // Test function to manually advance steps
         window.testStepAdvance = function() {
             console.log('=== MANUAL TEST ===');
             
             // Force step 2 to show
             const step1 = document.getElementById('step1Content');
             const step2 = document.getElementById('step2Content');
             
             console.log('Step 1 element:', step1);
             console.log('Step 2 element:', step2);
             
             if (step1) {
                 step1.style.display = 'none';
                 step1.classList.add('hidden');
                 console.log('Step 1 manually hidden');
             }
             
             if (step2) {
                 step2.style.display = 'block';
                 step2.classList.remove('hidden');
                 console.log('Step 2 manually shown');
             }
             
             console.log('Manually switched to step 2');
         };
         
         // Test function to manually go back to step 1
         window.testStepBack = function() {
             console.log('=== MANUAL BACK TEST ===');
             
             // Force step 1 to show
             const step1 = document.getElementById('step1Content');
             const step2 = document.getElementById('step2Content');
             
             console.log('Step 1 element:', step1);
             console.log('Step 2 element:', step2);
             
             if (step2) {
                 step2.style.display = 'none';
                 step2.classList.add('hidden');
                 console.log('Step 2 manually hidden');
             }
             
             if (step1) {
                 step1.style.display = 'block';
                 step1.classList.remove('hidden');
                 console.log('Step 1 manually shown');
             }
             
             console.log('Manually switched back to step 1');
         };
         
         // Test function to manually go to step 3
         window.testStep3 = function() {
             console.log('=== MANUAL STEP 3 TEST ===');
             
             // Force step 3 to show
             const step2 = document.getElementById('step2Content');
             const step3 = document.getElementById('step3Content');
             
             console.log('Step 2 element:', step2);
             console.log('Step 3 element:', step3);
             
             if (step2) {
                 step2.style.display = 'none';
                 step2.classList.add('hidden');
                 console.log('Step 2 manually hidden');
             }
             
             if (step3) {
                 step3.style.display = 'block';
                 step3.classList.remove('hidden');
                 console.log('Step 3 manually shown');
             }
             
             console.log('Manually switched to step 3');
         };
         
         // Test function to check button state
         window.checkButton = function() {
             const btn = document.getElementById('nextStep1');
             console.log('Button element:', btn);
             console.log('Button disabled:', btn.disabled);
             console.log('Button has disabled attribute:', btn.hasAttribute('disabled'));
             console.log('Button opacity:', btn.style.opacity);
             console.log('Button cursor:', btn.style.cursor);
             console.log('Button classes:', btn.className);
             console.log('Button background:', btn.style.backgroundColor);
             console.log('Button pointer-events:', btn.style.pointerEvents);
             
             // Test if we can add a new event listener
             btn.addEventListener('click', () => {
                 // Event listener triggered
             });
             
             console.log('Added new event listener to button');
         };
         
         // Test function to manually enable button
         window.enableButton = function() {
             const btn = document.getElementById('nextStep1');
             btn.disabled = false;
             btn.removeAttribute('disabled');
             btn.style.opacity = '1';
             btn.style.cursor = 'pointer';
             btn.style.pointerEvents = 'auto';
             btn.style.backgroundColor = '#8B4513';
             console.log('Button manually enabled');
         };
         
         // Simple test to check if JavaScript is working
         // Page loaded successfully
         console.log('JavaScript is working!');
         console.log('Current step variable:', currentStep);
         console.log('Next step button exists:', !!document.getElementById('nextStep1'));
         
         // Check if step content elements exist
         console.log('Step 1 content exists:', !!document.getElementById('step1Content'));
         console.log('Step 2 content exists:', !!document.getElementById('step2Content'));
         console.log('Step 3 content exists:', !!document.getElementById('step3Content'));
         console.log('Step 4 content exists:', !!document.getElementById('step4Content'));
         
         // Check step indicators
         console.log('Step 1 indicator exists:', !!document.getElementById('step1'));
         console.log('Step 2 indicator exists:', !!document.getElementById('step2'));
         console.log('Step 3 indicator exists:', !!document.getElementById('step3'));
         console.log('Step 4 indicator exists:', !!document.getElementById('step4'));

         function setImageWithFade(img, src) {
              if (!img) return;
              if (!src) {
                  img.classList.remove('show');
                  img.removeAttribute('src');
                  return;
              }
              if (img.getAttribute('src') === src) {
                  img.classList.add('show');
                  return;
              }
              img.classList.remove('show');
              img.addEventListener('load', function onload() {
                  img.removeEventListener('load', onload);
                  requestAnimationFrame(() => img.classList.add('show'));
              });
              img.setAttribute('src', src);
              // Fallback: if load doesn't fire (cache/edge), ensure visibility shortly after
              setTimeout(() => {
                  try {
                      if (img.getAttribute('src') === src) {
                          img.classList.add('show');
                          img.style.display = 'block';
                      }
                  } catch (e) {}
              }, 500);
          }

         // Image maps for color assets (must be defined before updatePreview)
         const primaryImageMap = {
             black: '/images/primarycolors/blackbox.png',
             white: '/images/primarycolors/boxwhite.PNG',
             gray: '/images/primarycolors/graybox.PNG',
             green: '/images/primarycolors/greenbox.PNG',
             darkgreen: '/images/primarycolors/darkgreenbox.PNG',
             red: '/images/primarycolors/boxred.PNG'
         };
                 const secondaryLogoMap = {
            black: '/images/secondarycolors/blacklogo.PNG',
            red: '/images/secondarycolors/redlogo.png',
            orange: '/images/secondarycolors/orangelogo.PNG',
            gold: '/images/secondarycolors/goldlogo.PNG',
            white: '/images/secondarycolors/whitelogo.PNG'
        };
                 const secondaryButtonMap = {
            black: '/images/secondarycolors/blackbutton.PNG',
            red: '/images/secondarycolors/redbutton.PNG',
            orange: '/images/secondarycolors/orangebutton.PNG',
            gold: '/images/secondarycolors/goldbutton.PNG',
            white: '/images/secondarycolors/whitebutton.PNG'
        };

          // Crossfade utility between A/B images in a layer
          function createPair(aId, bId) {
              return { A: document.getElementById(aId), B: document.getElementById(bId), active: 'A' };
          }
          function crossfade(pair, newSrc) {
              const activeEl = pair[pair.active];
              const nextKey = pair.active === 'A' ? 'B' : 'A';
              const incomingEl = pair[nextKey];
  
              if (!newSrc) {
                  activeEl.classList.remove('show');
                  incomingEl.classList.remove('show');
                  activeEl.removeAttribute('src');
                  incomingEl.removeAttribute('src');
                  return;
              }
  
              if (incomingEl.getAttribute('src') !== newSrc) {
                  incomingEl.classList.remove('show');
                  incomingEl.addEventListener('load', function onload() {
                      incomingEl.removeEventListener('load', onload);
                      incomingEl.style.display = 'block';
                      requestAnimationFrame(() => {
                          // Start fading in the incoming image first
                          incomingEl.classList.add('show');
                          // Slight overlap so the change feels smooth
                          setTimeout(() => { activeEl.classList.remove('show'); }, 150);
                          // Switch active reference after fade completes
                          setTimeout(() => { pair.active = nextKey; }, 750);
                      });
                  });
                  incomingEl.setAttribute('src', newSrc);
                  // Fallback for cached/instant loads
                  setTimeout(() => {
                      try {
                          if (incomingEl.getAttribute('src') === newSrc) {
                              incomingEl.style.display = 'block';
                              incomingEl.classList.add('show');
                              setTimeout(() => { activeEl.classList.remove('show'); }, 150);
                              setTimeout(() => { pair.active = nextKey; }, 750);
                          }
                      } catch (_) {}
                  }, 100);
              } else {
                  incomingEl.classList.add('show');
                  setTimeout(() => { activeEl.classList.remove('show'); }, 150);
                  setTimeout(() => { pair.active = nextKey; }, 1100);
              }
          }

          // Persistent pairs (initialized once), with lazy fallback
          let basePair = null;
          let logoPair = null;
          let buttonPair = null;
          function ensurePairs() {
              if (!basePair || !logoPair || !buttonPair) {
                  basePair = createPair('baseBoxA','baseBoxB');
                  logoPair = createPair('logoOverlayA','logoOverlayB');
                  buttonPair = createPair('buttonOverlayA','buttonOverlayB');
              }
          }
          document.addEventListener('DOMContentLoaded', ensurePairs);

          // Ensure pairs exist
          ensurePairs();
    </script>
</body>
</html>