<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <title>Kassa - Nordkaliber</title>
    <!-- Favicon for all browsers - ICO format for IE compatibility -->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico?v=2">
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico?v=2">
    
    <!-- PNG favicons for modern browsers -->
    <link rel="icon" type="image/png" sizes="24x24" href="images/favicon-16x16.png"?v=2>
    <link rel="icon" type="image/png" sizes="36x36" href="images/favicon-24x24.png"?v=2>
    <link rel="icon" type="image/png" sizes="48x48" href="images/favicon-32x32.png"?v=2>
    <link rel="icon" type="image/png" sizes="72x72" href="images/favicon-48x48.png"?v=2>
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-64x64.png"?v=2>
    <link rel="icon" type="image/png" sizes="144x144" href="images/favicon-96x96.png"?v=2>
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon-128x128.png"?v=2>
    <link rel="icon" type="image/png" sizes="384x384" href="images/favicon-256x256.png"?v=2>
    
    <!-- Apple Touch Icons for iOS devices -->
    <link rel="apple-touch-icon" sizes="86x86" href="images/favicon-57x57.png"?v=2>
    <link rel="apple-touch-icon" sizes="108x108" href="images/favicon-72x72.png"?v=2>
    <link rel="apple-touch-icon" sizes="171x171" href="images/favicon-114x114.png"?v=2>
    <link rel="apple-touch-icon" sizes="216x216" href="images/favicon-144x144.png"?v=2>
    <link rel="apple-touch-icon" sizes="228x228" href="images/favicon-152x152.png"?v=2>
    <link rel="apple-touch-icon" sizes="270x270" href="images/apple-touch-icon.png">
    
    <!-- Microsoft Tiles for Windows -->
    <meta name="msapplication-TileColor" content="#1B4D3E">
    <meta name="msapplication-TileImage" content="images/favicon-144x144.png">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Android Chrome icons -->
    <link rel="icon" type="image/png" sizes="288x288" href="images/favicon-192x192.png"?v=2>
    <link rel="icon" type="image/png" sizes="768x768" href="images/favicon-512x512.png"?v=2>
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1B4D3E">
    
    <!-- Web App Manifest for PWA support -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Security: Only allow access from your domain
        (function() {
            const allowedDomains = ['nordkaliber.store', 'localhost', '127.0.0.1'];
            const currentDomain = window.location.hostname;
            const referrer = document.referrer;
            
            // Check if current domain is allowed
            const isAllowedDomain = allowedDomains.some(domain => 
                currentDomain === domain || currentDomain.endsWith('.' + domain)
            );
            
            // Check if referrer is from your domain (or empty for direct access)
            const isFromYourDomain = !referrer || (
                referrer.includes('nordkaliber.store') || 
                referrer.includes('localhost') ||
                referrer.includes('127.0.0.1')
            );
            
            // Block if not from allowed domain OR if there's a referrer that's not from your site
            if (!isAllowedDomain || !isFromYourDomain) {
                console.log('Unauthorized access attempt blocked');
                window.location.href = '/';
                return;
            }
        })();
        
        // Function to redirect to the new design page
        function redirectToDesign(event) {
            event.preventDefault();
            window.location.href = '/designpage';
        }
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lavender-grey': '#D1CFE0',
                        'forest-teal': '#1B4332',
                        'deep-blue': '#0F172A',
                        'mustard-gold': '#E6B17A',
                        'muted-beige': '#F0E6D3',
                        'sage-green': '#6B8E6B',
                        'hunter-brown': '#A0522D',
                        'dark-green': '#1B4D3E',
                        'light-green': '#2D5A46',
                        'premium-black': '#0A0A0A',
                        'light-grey': '#E5E7EB',
                        'warm-grey': '#D1D5DB',
                        'cool-grey': '#9CA3AF',
                        'soft-grey': '#F3F4F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #32325d;
            overflow-x: hidden;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Stripe Payment Element styling for clean white design */
        #payment-element {
            margin-bottom: 24px;
        }
        
        /* Custom styling for Stripe elements to match clean white theme */
        .StripeElement {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            color: #32325d;
        }
        
        .StripeElement--focus {
            border-color: #6772e5;
            box-shadow: 0 0 0 2px rgba(103, 114, 229, 0.2);
        }
        
        .StripeElement--invalid {
            border-color: #fa755a;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="#" onclick="redirectToDesign(event)" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                    <span class="text-xl font-semibold">NORDKALIBER</span>
                </a>
                <div class="text-right">
                    <div class="text-lg font-semibold text-gray-900">Betalning</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-8 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900">Orderöversikt</h2>
                    
                    <div id="orderItems" class="space-y-3 mb-6">
                        <!-- Order items will be populated here -->
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Delsumma:</span>
                            <span id="subtotal" class="text-gray-900">0 kr</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Frakt:</span>
                            <span class="text-green-600">Gratis</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold text-gray-900">
                            <span>Totalt:</span>
                            <span id="total">0 kr</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Form -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-gray-200 rounded-lg p-6 fade-in shadow-sm">
                    <h1 class="text-2xl font-bold mb-6 text-gray-900">Betalningsinformation</h1>
                    
                    <!-- Customer Information -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900">Kundinformation</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="firstName" class="block text-sm font-medium mb-2 text-gray-700">Förnamn *</label>
                                <input type="text" id="firstName" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium mb-2 text-gray-700">Efternamn *</label>
                                <input type="text" id="lastName" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="email" class="block text-sm font-medium mb-2 text-gray-700">E-postadress *</label>
                                <input type="email" id="email" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="phone" class="block text-sm font-medium mb-2 text-gray-700">Telefonnummer</label>
                                <input type="tel" id="phone" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900">Leveransadress</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="address" class="block text-sm font-medium mb-2 text-gray-700">Gatuadress *</label>
                                <input type="text" id="address" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="postalCode" class="block text-sm font-medium mb-2 text-gray-700">Postnummer *</label>
                                <input type="text" id="postalCode" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium mb-2 text-gray-700">Stad *</label>
                                <input type="text" id="city" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="country" class="block text-sm font-medium mb-2 text-gray-700">Land *</label>
                                <select id="country" required class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Välj land</option>
                                    <option value="SE">Sverige</option>
                                    <option value="NO">Norge</option>
                                    <option value="DK">Danmark</option>
                                    <option value="FI">Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-gray-900">Betalningsmetod</h3>
                        
                        <!-- Test Mode Toggle -->
                        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-yellow-800">Test Mode</h4>
                                    <p class="text-sm text-yellow-700">Aktivera för att testa betalningar med testkort (4242 4242 4242 4242)</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="testModeToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div id="testModeInfo" class="mt-2 text-sm text-yellow-700 hidden">
                                <i class="fas fa-info-circle mr-1"></i>
                                Test Mode: Använd kort 4242 4242 4242 4242, valfri CVC och framtida utgångsdatum
                            </div>
                        </div>
                        
                        <!-- Stripe Payment Element -->
                        <div class="bg-white border border-gray-300 rounded-lg p-4">
                            <div id="payment-element">
                                <!-- Stripe Payment Element will be inserted here -->
                            </div>
                            <div id="payment-message" class="text-red-600 text-sm mt-4"></div>
                            <div id="payment-status" class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-spinner fa-spin mr-1"></i>
                                Laddar betalningsmetoder...
                            </div>
                        </div>
                        
                        <!-- Debug Information -->
                        <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Debug Information</h4>
                            <div id="debugInfo" class="text-xs text-gray-600">
                                <div>Mode: <span id="currentMode">Live</span></div>
                                <div>Order Total: <span id="orderTotal">0 kr</span></div>
                                <div>Items: <span id="itemCount">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="mb-8">
                        <div class="flex items-start space-x-3">
                            <input type="checkbox" id="terms" required class="mt-1">
                            <label for="terms" class="text-sm text-gray-700">
                                Jag accepterar <a href="/policies" class="text-blue-600 hover:underline">användarvillkoren</a> och <a href="/policies" class="text-blue-600 hover:underline">integritetspolicyn</a> *
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="submit" class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors">
                        <div class="spinner hidden" id="spinner"></div>
                        <span id="button-text">Slutför köp</span>
                    </button>
                </div>
            </div>
        </div>
    </div>



    <script>
        // Global variables
        let stripe = null;
        let elements = null;
        let orderData = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCheckout();
            
            // Add test mode toggle event listener
            document.getElementById('testModeToggle').addEventListener('change', function() {
                const testModeInfo = document.getElementById('testModeInfo');
                if (this.checked) {
                    testModeInfo.classList.remove('hidden');
                } else {
                    testModeInfo.classList.add('hidden');
                }
                
                // Update debug info
                updateDebugInfo();
                
                // Reinitialize Stripe with new mode
                initializeStripe();
            });
        });

        // Initialize checkout
        async function initializeCheckout() {
            // Load order data from localStorage
            loadOrderData();
            
            // Update order summary
            updateOrderSummary();
            
            // Update debug info
            updateDebugInfo();
            
            // Initialize Stripe
            await initializeStripe();
            
            // Check if payment element loads properly after 3 seconds
            setTimeout(() => {
                const paymentElement = document.getElementById('payment-element');
                if (paymentElement && paymentElement.children.length === 0) {
                    console.log('⏰ Stripe Payment Element failed to load');
                    document.getElementById('payment-status').innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-1"></i>Betalningsmetoder kunde inte laddas';
                } else {
                    // Stripe loaded successfully
                    document.getElementById('payment-status').innerHTML = '<i class="fas fa-check text-green-600 mr-1"></i>Betalningsmetoder laddade';
                }
            }, 3000);
        }

        // Load order data from localStorage
        function loadOrderData() {
            const productsData = localStorage.getItem('nordkaliberProducts');
            if (productsData) {
                const products = JSON.parse(productsData);
                orderData = {
                    items: products.map(product => ({
                        type: product.type,
                        caliber: product.selections.caliber || product.selections.caliberSpecial || 'Ej valt',
                        primaryColor: product.selections.primaryColor ? product.selections.primaryColor.name : (product.selections.primaryColorSpecial || 'Ej valt'),
                        secondaryColor: product.selections.secondaryColor ? product.selections.secondaryColor.name : (product.selections.secondaryColorSpecial || 'Ej valt'),
                        design: product.selections.design ? product.selections.design.name : (product.selections.designSpecial || 'Ej valt'),
                        initials: product.selections.initials || product.selections.initialsSpecial || 'Inga',
                        price: product.totalPrice
                    })),
                    total: products.reduce((sum, product) => sum + product.totalPrice, 0)
                };
                console.log('Loaded products from localStorage:', orderData);
            } else {
                // Create demo data if no products data exists
                orderData = {
                    items: [
                        {
                            type: 'Ammunitionsetui',
                            caliber: '6.5x55 Swedish Mauser',
                            primaryColor: 'Grön',
                            secondaryColor: 'Svart',
                            design: 'Motiv 1',
                            initials: 'Inga',
                            price: 850
                        }
                    ],
                    total: 850
                };
                console.log('Using demo order data');
            }
        }

        // Initialize Stripe
        async function initializeStripe() {
            try {
                const isTestMode = document.getElementById('testModeToggle').checked;
                console.log('🔄 Initializing Stripe in', isTestMode ? 'test' : 'live', 'mode...');
                
                // Clear existing payment element if it exists
                if (elements) {
                    elements = null;
                }
                
                // Get Stripe config from server
                const response = await fetch(`/.netlify/functions/stripe-config?test=${isTestMode}`);
                if (!response.ok) {
                    throw new Error('Failed to get Stripe configuration');
                }
                
                const config = await response.json();
                console.log('✅ Got Stripe config:', config.publishableKey ? 'Key received' : 'No key');
                
                if (!config.publishableKey) {
                    throw new Error('No Stripe publishable key received');
                }
                
                stripe = Stripe(config.publishableKey);
                
                // Create payment intent with customer data
                const paymentIntentResponse = await fetch(`/.netlify/functions/create-payment-intent?test=${isTestMode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: orderData.items,
                        customerEmail: document.getElementById('email').value || 'test@example.com',
                        customerName: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                        customerPhone: document.getElementById('phone').value,
                        customerAddress: {
                            line1: document.getElementById('address').value,
                            postal_code: document.getElementById('postalCode').value,
                            city: document.getElementById('city').value,
                            country: document.getElementById('country').value,
                        }
                    })
                });

                if (!paymentIntentResponse.ok) {
                    const errorData = await paymentIntentResponse.json();
                    console.error('❌ Payment intent error:', errorData);
                    throw new Error(`Payment intent creation failed: ${errorData.details || 'Unknown error'}`);
                }

                const paymentIntentData = await paymentIntentResponse.json();
                const { clientSecret } = paymentIntentData;
                
                if (!clientSecret) {
                    throw new Error('No client secret received from payment intent');
                }
                
                console.log('✅ Payment Intent created, clientSecret:', clientSecret ? 'Received' : 'Missing');
                
                // Clear payment element container
                const paymentElementContainer = document.getElementById('payment-element');
                paymentElementContainer.innerHTML = '';
                
                // Create elements with clean white appearance
                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#6772e5',
                            colorBackground: '#ffffff',
                            colorText: '#32325d',
                            colorDanger: '#fa755a',
                            fontFamily: 'Inter, sans-serif',
                            spacingUnit: '4px',
                            borderRadius: '8px',
                        },
                    },
                });

                // Create and mount the Payment Element
                const paymentElement = elements.create('payment', {
                    layout: {
                        type: 'tabs',
                        defaultCollapsed: false,
                        spacedAccordionItems: false,
                    },
                    fields: {
                        billingDetails: {
                            name: 'auto',
                            email: 'auto',
                            phone: 'auto',
                            address: {
                                country: 'auto',
                                line1: 'auto',
                                line2: 'auto',
                                city: 'auto',
                                state: 'auto',
                                postalCode: 'auto'
                            }
                        }
                    }
                });
                
                paymentElement.mount('#payment-element');
                
                console.log('✅ Stripe Payment Element mounted successfully');
                showMessage('Payment methods loaded successfully!', 'success');
            } catch (error) {
                console.error('❌ Failed to initialize Stripe:', error);
                showMessage(`Payment setup failed: ${error.message}`, 'error');
            }
        }

        // Handle form submission
        document.getElementById('submit').addEventListener('click', handleSubmit);

        async function handleSubmit(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            setLoading(true);

            try {
                // Save customer information for email sending
                const customerInfo = {
                    name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    postalCode: document.getElementById('postalCode').value,
                    city: document.getElementById('city').value,
                    country: document.getElementById('country').value
                };
                
                // Get existing cart data and add customer info + order items
                const existingCartData = localStorage.getItem('nordkaliberCart');
                let cartData = existingCartData ? JSON.parse(existingCartData) : { items: [], orderId: 'ORDER-' + Date.now() };
                cartData.customerInfo = customerInfo;
                cartData.items = orderData.items; // Add the order items!
                cartData.total = orderData.total; // Add the total!
                cartData.paymentStatus = 'processing';
                cartData.timestamp = new Date().toLocaleString('sv-SE');
                
                console.log('💾 Saving cart data with items:', cartData);
                
                // Save updated cart data
                localStorage.setItem('nordkaliberCart', JSON.stringify(cartData));
                
                // Confirm payment
                const isTestMode = document.getElementById('testModeToggle').checked;
                const customerName = document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value;
                const customerEmail = document.getElementById('email').value;
                const customerPhone = document.getElementById('phone').value;
                const customerAddress = document.getElementById('address').value;
                const customerPostalCode = document.getElementById('postalCode').value;
                const customerCity = document.getElementById('city').value;
                const customerCountry = document.getElementById('country').value;
                
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: `${window.location.origin}/success?test=${isTestMode}&customer_name=${encodeURIComponent(customerName)}&customer_email=${encodeURIComponent(customerEmail)}&customer_phone=${encodeURIComponent(customerPhone)}&customer_address=${encodeURIComponent(customerAddress)}&customer_postal=${encodeURIComponent(customerPostalCode)}&customer_city=${encodeURIComponent(customerCity)}&customer_country=${encodeURIComponent(customerCountry)}`,
                        payment_method_data: {
                            billing_details: {
                                name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                                email: document.getElementById('email').value,
                                phone: document.getElementById('phone').value,
                                address: {
                                    line1: document.getElementById('address').value,
                                    postal_code: document.getElementById('postalCode').value,
                                    city: document.getElementById('city').value,
                                    country: document.getElementById('country').value,
                                }
                            }
                        }
                    }
                });

                if (error) {
                    if (error.type === 'card_error' || error.type === 'validation_error') {
                        showMessage(error.message, 'error');
                    } else {
                        showMessage('Ett oväntat fel uppstod. Försök igen.', 'error');
                    }
                }
            } catch (error) {
                console.error('Payment error:', error);
                showMessage('Ett fel uppstod vid betalning. Försök igen.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Validate form
        function validateForm() {
            const requiredFields = ['firstName', 'lastName', 'email', 'address', 'postalCode', 'city', 'country'];
            const terms = document.getElementById('terms');
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showMessage(`Vänligen fyll i ${field.previousElementSibling.textContent.replace(' *', '')}`, 'error');
                    field.focus();
                    return false;
                }
            }
            
            if (!terms.checked) {
                showMessage('Du måste acceptera användarvillkoren', 'error');
                return false;
            }
            
            return true;
        }

        // Show/hide loading state
        function setLoading(isLoading) {
            if (isLoading) {
                document.querySelector('#submit').disabled = true;
                document.querySelector('#spinner').classList.remove('hidden');
                document.querySelector('#button-text').classList.add('hidden');
            } else {
                document.querySelector('#submit').disabled = false;
                document.querySelector('#spinner').classList.add('hidden');
                document.querySelector('#button-text').classList.remove('hidden');
            }
        }

        // Show message
        function showMessage(messageText, messageType) {
            const messageContainer = document.querySelector('#payment-message');
            messageContainer.classList.remove('hidden');
            messageContainer.textContent = messageText;
            
            if (messageType === 'error') {
                messageContainer.className = 'text-red-600 text-sm mt-4';
            } else {
                messageContainer.className = 'text-green-600 text-sm mt-4';
            }

            setTimeout(function() {
                messageContainer.classList.add('hidden');
            }, 4000);
        }





        // Update order summary
        function updateOrderSummary() {
            if (!orderData) return;

            const orderItemsContainer = document.getElementById('orderItems');
            const subtotalElement = document.getElementById('subtotal');
            const totalElement = document.getElementById('total');

            // Clear existing items
            orderItemsContainer.innerHTML = '';

            // Add items
            orderData.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'border border-gray-200 rounded-lg p-4 mb-3 bg-gray-50';
                itemElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900 text-lg">${item.type}</h4>
                        <span class="font-bold text-blue-600 text-lg">${item.price} kr</span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex justify-between">
                            <span class="font-medium">Kaliber:</span>
                            <span>${item.caliber}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Primär Färg:</span>
                            <span>${item.primaryColor}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Sekundär Färg:</span>
                            <span>${item.secondaryColor}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Design:</span>
                            <span>${item.design}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Initialer:</span>
                            <span>${item.initials}</span>
                        </div>
                    </div>
                `;
                orderItemsContainer.appendChild(itemElement);
            });

            // Update totals
            const subtotal = orderData.items.reduce((sum, item) => sum + item.price, 0);
            subtotalElement.textContent = subtotal + ' kr';
            totalElement.textContent = subtotal + ' kr';
        }

        // Update debug information
        function updateDebugInfo() {
            const isTestMode = document.getElementById('testModeToggle').checked;
            const currentModeElement = document.getElementById('currentMode');
            const orderTotalElement = document.getElementById('orderTotal');
            const itemCountElement = document.getElementById('itemCount');
            
            if (currentModeElement) {
                currentModeElement.textContent = isTestMode ? 'Test' : 'Live';
                currentModeElement.className = isTestMode ? 'text-yellow-600 font-medium' : 'text-green-600 font-medium';
            }
            
            if (orderData) {
                const total = orderData.items.reduce((sum, item) => sum + item.price, 0);
                if (orderTotalElement) {
                    orderTotalElement.textContent = total + ' kr';
                }
                if (itemCountElement) {
                    itemCountElement.textContent = orderData.items.length;
                }
            } else {
                if (orderTotalElement) orderTotalElement.textContent = '0 kr';
                if (itemCountElement) itemCountElement.textContent = '0';
            }
        }
    </script>
</body>
</html> 